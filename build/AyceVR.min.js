function WebVRHMDHandler_1_1(t,e){function i(t){console.log("Presenting in HMD: ",t)}this.onHMDReady=e;var r=new VRFrameData,n=!0,o=t.getEyeParameters("left"),a=t.getEyeParameters("right"),s=new Ayce.Vector3,h=new Ayce.Quaternion,c=t.getPose();window.addEventListener("vrdisplaypresentchange",i,!1),this.update=function(){t.getFrameData(r)&&(c=r.pose)},this.getPosition=function(){var t=c.position;return t&&s.set(t[0],t[1],t[2]),s},this.getRotation=function(){var t=c.orientation;return h.set(t[0],t[1],t[2],t[3]),h},this.resetSensor=function(){t.resetPose()},this.showInHMD=function(e){t.requestPresent([{source:e}]).then(function(){},function(){console.warn("vrDisplay: requestPresent failed.")})},this.exitHMD=function(){t.exitPresent().then(function(){},function(){console.warn("vrDisplay: exitPresent failed.")})},this.isHMDReady=function(){return n},this.renderToHMD=function(){t.isPresenting&&t.submitFrame(c)},this.getAnimFrame=function(e){return!(!t||!t.isPresenting)&&(t.requestAnimationFrame(e),!0)},this.isWebVRReady=function(){return Boolean(navigator.getVRDisplays||navigator.getVRDevices)},this.getEyeTranslationL=function(){return o.offset[0]},this.getEyeTranslationR=function(){return a.offset[0]},this.getEyeFOVL=function(){return o.fieldOfView},this.getEyeFOVR=function(){return a.fieldOfView},this.getEyeWidthR=function(){return a.renderWidth},this.getEyeWidthL=function(){return o.renderWidth},this.getEyeHeightR=function(){return a.renderHeight},this.getEyeHeightL=function(){return o.renderHeight}}function WebVRHMDHandler_1_0(t,e){function i(t){console.log("Presenting in HMD: ",t)}this.onHMDReady=e;var r=!0,n=t.getEyeParameters("left"),o=t.getEyeParameters("right"),a=new Ayce.Vector3,s=new Ayce.Quaternion,h=t.getPose();window.addEventListener("vrdisplaypresentchange",i,!1),this.update=function(){h=t.getPose()},this.getPosition=function(){var t=h.position;return t&&a.set(t[0],t[1],t[2]),a},this.getRotation=function(){var t=h.orientation;return s.set(t[0],t[1],t[2],t[3]),s},this.resetSensor=function(){t.resetPose()},this.showInHMD=function(e){t.requestPresent([{source:e}]).then(function(){},function(){console.warn("vrDisplay: requestPresent failed.")})},this.exitHMD=function(){t.exitPresent().then(function(){},function(){console.warn("vrDisplay: exitPresent failed.")})},this.isHMDReady=function(){return r},this.renderToHMD=function(){t.isPresenting&&t.submitFrame(h)},this.getAnimFrame=function(e){return!(!t||!t.isPresenting)&&(t.requestAnimationFrame(e),!0)},this.isWebVRReady=function(){return Boolean(navigator.getVRDisplays||navigator.getVRDevices)},this.getEyeTranslationL=function(){return n.offset[0]},this.getEyeTranslationR=function(){return o.offset[0]},this.getEyeFOVL=function(){return n.fieldOfView},this.getEyeFOVR=function(){return o.fieldOfView},this.getEyeWidthR=function(){return o.renderWidth},this.getEyeWidthL=function(){return n.renderWidth},this.getEyeHeightR=function(){return o.renderHeight},this.getEyeHeightL=function(){return n.renderHeight}}function WebVRHMDHandler_Deprecated(t,e,i){this.onHMDReady=i;var r=!0,n=t.getEyeParameters("left"),o=t.getEyeParameters("right"),a=new Ayce.Vector3,s=new Ayce.Quaternion;this.update=function(){},this.renderToHMD=function(){},this.exitHMD=function(){},this.getPosition=function(){var t=e.getState().position;return t&&a.set(t.x,t.y,t.z),a},this.getRotation=function(){var t=e.getState().orientation;return s.set(t.x,t.y,t.z,t.w),s},this.resetSensor=function(){void 0!==e&&("resetSensor"in e?e.resetSensor():"zeroSensor"in e?e.zeroSensor():console.log("Can't reset position sensor."))},this.showInHMD=function(e){var i={};i.vrDisplay=t,i.vrTimewarp=!0,e.requestFullscreen?e.requestFullscreen(i):e.msRequestFullscreen?e.msRequestFullscreen(i):e.mozRequestFullScreen?e.mozRequestFullScreen(i):e.webkitRequestFullscreen&&e.webkitRequestFullscreen(i)},this.isHMDReady=function(){return r},this.isWebVRReady=function(){return Boolean(navigator.getVRDisplays||navigator.getVRDevices)},this.getEyeTranslationL=function(){return n.eyeTranslation.x},this.getEyeTranslationR=function(){return o.eyeTranslation.x},this.getEyeFOVL=function(){return n.recommendedFieldOfView},this.getEyeFOVR=function(){return o.recommendedFieldOfView},this.getEyeWidthR=function(){return o.renderRect.width},this.getEyeWidthL=function(){return n.renderRect.width},this.getEyeHeightR=function(){return o.renderRect.height},this.getEyeHeightL=function(){return n.renderRect.height}}var Ayce={};"undefined"!=typeof module&&(module.exports=Ayce),"undefined"==typeof navigator&&(navigator={}),Ayce.requestAnimFrame=function(t){if(!Ayce.HMDHandler.getAnimFrame||!Ayce.HMDHandler.getAnimFrame(t)){var e=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,e){window.setTimeout(t,1e3/60)};e.call(window,t)}},Ayce.Vector2=function(t,e){this.x=t||0,this.y=e||0},Ayce.Vector2.prototype={getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);return 0!==t&&(this.x/=t,this.y/=t),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},nullVector:function(){return this.x=0,this.y=0,this},scaleBy:function(t){return this.x*=t,this.y*=t,this},set:function(t,e){return this.x=t,this.y=e,this},add:function(t,e){return this.x+=t,this.y+=e,this},subtract:function(t,e){return this.x-=t,this.y-=e,this},multiply:function(t,e){return this.x*=t,this.y*=e,this},distance:function(t,e){var i=e.x-t.x,r=e.y-t.y;return Math.sqrt(i*i+r*r)},dotProduct:function(t){return this.x*t.x+this.y*t.y},addVector2:function(t){return this.x+=t.x,this.y+=t.y,this},copyToVector:function(t,e){e.x=t.x,e.y=t.y},copy:function(){return new Ayce.Vector2(this.x,this.y)}},Ayce.Vector3=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0},Ayce.Vector3.prototype={getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return 0!==t&&(this.x/=t,this.y/=t,this.z/=t),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},nullVector:function(){return this.x=0,this.y=0,this.z=0,this},scaleBy:function(t){return this.x*=t,this.y*=t,this.z*=t,this},set:function(t,e,i){return this.x=t,this.y=e,this.z=i,this},add:function(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this},subtract:function(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this},multiply:function(t,e,i){return this.x*=t,this.y*=e,this.z*=i,this},distance:function(t,e){var i=e.x-t.x,r=e.y-t.y,n=e.z-t.z;return Math.sqrt(i*i+r*r+n*n)},dotProduct:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},crossProduct:function(t){return new Ayce.Vector3(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},addVector3:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},copyToVector:function(t,e){e.x=t.x,e.y=t.y,e.z=t.z},copy:function(){return new Ayce.Vector3(this.x,this.y,this.z)}},Ayce.Quaternion=function(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=r||1},Ayce.Quaternion.prototype={multiply:function(t,e){var i=t.w,r=t.x,n=t.y,o=t.z,a=e.w,s=e.x,h=e.y,c=e.z;return this.w=i*a-r*s-n*h-o*c,this.x=i*s+r*a+n*c-o*h,this.y=i*h-r*c+n*a+o*s,this.z=i*c+r*h-n*s+o*a,this},set:function(t,e,i,r){this.x=t,this.y=e,this.z=i,this.w=r},fromAxisAngle:function(t,e){t.normalize();var i=Math.sin(e/2),r=Math.cos(e/2);return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=r,this.normalize(),this},fromEulerAngles:function(t,e,i){var r=.5*t,n=.5*e,o=.5*i,a=Math.cos(r),s=Math.sin(r),h=Math.cos(n),c=Math.sin(n),u=Math.cos(o),l=Math.sin(o);return this.w=a*h*u+s*c*l,this.x=s*h*u-a*c*l,this.y=a*c*u+s*h*l,this.z=a*h*l-s*c*u,this},normalize:function(){var t=this.x,e=this.y,i=this.z,r=this.w,n=1/Math.sqrt(t*t+e*e+i*i+r*r);return this.x*=n,this.y*=n,this.z*=n,this.w*=n,this},reset:function(){this.x=0,this.y=0,this.z=0,this.w=1},rotatePoint:function(t){var e=this.x,i=this.y,r=this.z,n=this.w,o=t.x,a=t.y,s=t.z,h=-e*o-i*a-r*s,c=n*o+i*s-r*a,u=n*a-e*s+r*o,l=n*s+e*a-i*o;return t.x=-h*e+c*n-u*r+l*i,t.y=-h*i+c*r+u*n-l*e,t.z=-h*r-c*i+u*e+l*n,t},getRotatedPoint:function(t,e){var i,r,n,o,a=this.x,s=this.y,h=this.z,c=this.w,u=t.x,l=t.y,d=t.z;o=-a*u-s*l-h*d,i=c*u+s*d-h*l,r=c*l-a*d+h*u,n=c*d+a*l-s*u;var y=e?e:new Ayce.Vector3;return y.x=-o*a+i*c-r*h+n*s,y.y=-o*s+i*h+r*c-n*a,y.z=-o*h-i*s+r*a+n*c,y},toRotationMatrix:function(t){var e=this.x,i=this.y,r=this.z,n=this.w,o=e*e,a=e*i,s=e*r,h=e*n,c=i*i,u=i*r,l=i*n,d=r*r,y=r*n;t.data[0]=1-2*(c+d),t.data[1]=2*(a-y),t.data[2]=2*(s+l),t.data[4]=2*(a+y),t.data[5]=1-2*(o+d),t.data[6]=2*(u-h),t.data[8]=2*(s-l),t.data[9]=2*(u+h),t.data[10]=1-2*(o+c),t.data[3]=t.data[7]=t.data[11]=t.data[12]=t.data[13]=t.data[14]=0,t.data[15]=1},getConjugate:function(t){return this.normalize(),t?(t.x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t):new Ayce.Quaternion(-this.x,-this.y,-this.z,this.w)},copy:function(){return new Ayce.Quaternion(this.x,this.y,this.z,this.w)},copyToQuaternion:function(t,e){e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w},slerp:function(t,e,i){var r=t.w,n=t.x,o=t.y,a=t.z,s=e.w,h=e.x,c=e.y,u=e.z,l=r*s+n*h+o*c+a*u;if(l<0&&(l=-l,s=-s,h=-h,c=-c,u=-u),l<.95){var d=Math.acos(l),y=1/Math.sin(d),f=Math.sin(d*(1-i))*y,p=Math.sin(d*i)*y;this.w=r*f+s*p,this.x=n*f+h*p,this.y=o*f+c*p,this.z=a*f+u*p}else{this.w=r+i*(s-r),this.x=n+i*(h-n),this.y=o+i*(c-o),this.z=a+i*(u-a);var g=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=g,this.x*=g,this.y*=g,this.z*=g}},getForwardVector:function(){return new Ayce.Vector3(2*(this.x*this.z+this.w*this.y),2*(this.y*this.x-this.w*this.x),1-2*(this.x*this.x+this.y*this.y))},getUpVector:function(){return new Ayce.Vector3(2*(this.x*this.y-this.w*this.z),1-2*(this.x*this.x+this.z*this.z),2*(this.y*this.z+this.w*this.x))},getRightVector:function(){return new Ayce.Vector3(1-2*(this.y*this.y+this.z*this.z),2*(this.x*this.y+this.w*this.z),2*(this.x*this.z-this.w*this.y))}},Ayce.Matrix4=function(){this.data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},Ayce.Matrix4.makePerspective=function(t,e,i,r){var n=new Ayce.Matrix4,o=t/2*Math.PI/180,a=Math.sin(o),s=Math.cos(o)/a,h=!0,c=h?-1:1;return n.data=new Float32Array([s/e,0,0,0,0,s,0,0,0,0,r/(i-r)*-c,c,0,0,r*i/(i-r),0]),n},Ayce.Matrix4.makeOrthoPerspective=function(t,e,i,r,n,o){var a=new Ayce.Matrix4,s=1/(t-e),h=1/(r-i),c=1/(n-o);return a.data=new Float32Array([-2*s,0,0,0,0,-2*h,0,0,0,0,2*c,0,(t+e)*s,(i+r)*h,(o+n)*c,1]),a},Ayce.Matrix4.makeVRPerspective=function(t,e,i){var r=Math.PI/180,n=Math.tan(t.upDegrees*r),o=Math.tan(t.downDegrees*r),a=Math.tan(t.leftDegrees*r),s=Math.tan(t.rightDegrees*r),h=2/(a+s),c=(a-s)*h*.5,u=2/(n+o),l=(n-o)*u*.5,d=!0,y=d?-1:1,f=new Ayce.Matrix4;return f.data=new Float32Array([h,0,0,0,0,u,0,0,c*y,l*y,i/(e-i)*-y,y,0,0,i*e/(e-i),0]),f},Ayce.Matrix4.prototype={poolMatrix:new Ayce.Matrix4,poolVector3:new Ayce.Vector3,identity:function(){this.data[0]=1,this.data[1]=0,this.data[2]=0,this.data[3]=0,this.data[4]=0,this.data[5]=1,this.data[6]=0,this.data[7]=0,this.data[8]=0,this.data[9]=0,this.data[10]=1,this.data[11]=0,this.data[12]=0,this.data[13]=0,this.data[14]=0,this.data[15]=1},apply:function(t){var e=this.data[0],i=this.data[4],r=this.data[8],n=this.data[12],o=this.data[1],a=this.data[5],s=this.data[9],h=this.data[13],c=this.data[2],u=this.data[6],l=this.data[10],d=this.data[14],y=this.data[3],f=this.data[7],p=this.data[11],g=this.data[15],m=t.data[0],x=t.data[4],v=t.data[8],A=t.data[12],w=t.data[1],M=t.data[5],R=t.data[9],b=t.data[13],S=t.data[2],V=t.data[6],C=t.data[10],T=t.data[14],E=t.data[3],P=t.data[7],z=t.data[11],D=t.data[15];this.data[0]=e*m+o*x+c*v+y*A,this.data[1]=e*w+o*M+c*R+y*b,this.data[2]=e*S+o*V+c*C+y*T,this.data[3]=e*E+o*P+c*z+y*D,this.data[4]=i*m+a*x+u*v+f*A,this.data[5]=i*w+a*M+u*R+f*b,this.data[6]=i*S+a*V+u*C+f*T,this.data[7]=i*E+a*P+u*z+f*D,this.data[8]=r*m+s*x+l*v+p*A,this.data[9]=r*w+s*M+l*R+p*b,this.data[10]=r*S+s*V+l*C+p*T,this.data[11]=r*E+s*P+l*z+p*D,this.data[12]=n*m+h*x+d*v+g*A,this.data[13]=n*w+h*M+d*R+g*b,this.data[14]=n*S+h*V+d*C+g*T,this.data[15]=n*E+h*P+d*z+g*D},applyRotation:function(t,e,i){if(this.poolMatrix.data[0]=1,this.poolMatrix.data[1]=0,this.poolMatrix.data[2]=0,this.poolMatrix.data[3]=0,this.poolMatrix.data[4]=0,this.poolMatrix.data[5]=1,this.poolMatrix.data[6]=0,this.poolMatrix.data[7]=0,this.poolMatrix.data[8]=0,this.poolMatrix.data[9]=0,this.poolMatrix.data[10]=1,this.poolMatrix.data[11]=0,this.poolMatrix.data[12]=0,this.poolMatrix.data[13]=0,this.poolMatrix.data[14]=0,this.poolMatrix.data[15]=1,this.getAxisRotation(e.x,e.y,e.z,t,this.poolMatrix),void 0!==i){var r=i;this.poolMatrix.applyTranslation(r.x,r.y,r.z)}this.apply(this.poolMatrix)},applyScale:function(t,e,i){this.poolMatrix.data[0]=t,this.poolMatrix.data[1]=0,this.poolMatrix.data[2]=0,this.poolMatrix.data[3]=0,this.poolMatrix.data[4]=0,this.poolMatrix.data[5]=e,this.poolMatrix.data[6]=0,this.poolMatrix.data[7]=0,this.poolMatrix.data[8]=0,this.poolMatrix.data[9]=0,this.poolMatrix.data[10]=i,this.poolMatrix.data[11]=0,this.poolMatrix.data[12]=0,this.poolMatrix.data[13]=0,this.poolMatrix.data[14]=0,this.poolMatrix.data[15]=1,this.apply(this.poolMatrix)},applyTranslation:function(t,e,i){this.data[12]+=t,this.data[13]+=e,this.data[14]+=i},getAxisRotation:function(t,e,i,r,n){var o;o=n?n:new Ayce.Matrix4;var a=this.poolVector3;a.x=t,a.y=e,a.z=i;var s=-r*(Math.PI/180),h=Math.cos(s),c=Math.sin(s),u=1-h;o.data[0]=h+a.x*a.x*u,o.data[5]=h+a.y*a.y*u,o.data[10]=h+a.z*a.z*u;var l=a.x*a.y*u,d=a.z*c;return o.data[4]=l+d,o.data[1]=l-d,l=a.x*a.z*u,d=a.y*c,o.data[8]=l-d,o.data[2]=l+d,l=a.y*a.z*u,d=a.x*c,o.data[9]=l+d,o.data[6]=l-d,o},getDeterminant:function(){return 1*((this.data[0]*this.data[5]-this.data[4]*this.data[1])*(this.data[10]*this.data[15]-this.data[14]*this.data[11])-(this.data[0]*this.data[9]-this.data[8]*this.data[1])*(this.data[6]*this.data[15]-this.data[14]*this.data[7])+(this.data[0]*this.data[13]-this.data[12]*this.data[1])*(this.data[6]*this.data[11]-this.data[10]*this.data[7])+(this.data[4]*this.data[9]-this.data[8]*this.data[5])*(this.data[2]*this.data[15]-this.data[14]*this.data[3])-(this.data[4]*this.data[13]-this.data[12]*this.data[5])*(this.data[2]*this.data[11]-this.data[10]*this.data[3])+(this.data[8]*this.data[13]-this.data[12]*this.data[9])*(this.data[2]*this.data[7]-this.data[6]*this.data[3]))},transpose:function(){this.copyToMatrix(this,this.poolMatrix),this.data[1]=this.poolMatrix.data[4],this.data[2]=this.poolMatrix.data[8],this.data[3]=this.poolMatrix.data[12],this.data[4]=this.poolMatrix.data[1],this.data[6]=this.poolMatrix.data[9],this.data[7]=this.poolMatrix.data[13],this.data[8]=this.poolMatrix.data[2],this.data[9]=this.poolMatrix.data[6],this.data[11]=this.poolMatrix.data[14],this.data[12]=this.poolMatrix.data[3],this.data[13]=this.poolMatrix.data[7],this.data[14]=this.poolMatrix.data[11]},invert:function(){var t=this.getDeterminant(),e=Math.abs(t)>1e-11;if(!e)throw"Can't invert Matrix";t=1/t;var i=this.data[0],r=this.data[4],n=this.data[8],o=this.data[12],a=this.data[1],s=this.data[5],h=this.data[9],c=this.data[13],u=this.data[2],l=this.data[6],d=this.data[10],y=this.data[14],f=this.data[3],p=this.data[7],g=this.data[11],m=this.data[15];return this.data[0]=t*(s*(d*m-y*g)-h*(l*m-y*p)+c*(l*g-d*p)),this.data[1]=-t*(a*(d*m-y*g)-h*(u*m-y*f)+c*(u*g-d*f)),this.data[2]=t*(a*(l*m-y*p)-s*(u*m-y*f)+c*(u*p-l*f)),this.data[3]=-t*(a*(l*g-d*p)-s*(u*g-d*f)+h*(u*p-l*f)),this.data[4]=-t*(r*(d*m-y*g)-n*(l*m-y*p)+o*(l*g-d*p)),this.data[5]=t*(i*(d*m-y*g)-n*(u*m-y*f)+o*(u*g-d*f)),this.data[6]=-t*(i*(l*m-y*p)-r*(u*m-y*f)+o*(u*p-l*f)),this.data[7]=t*(i*(l*g-d*p)-r*(u*g-d*f)+n*(u*p-l*f)),this.data[8]=t*(r*(h*m-c*g)-n*(s*m-c*p)+o*(s*g-h*p)),this.data[9]=-t*(i*(h*m-c*g)-n*(a*m-c*f)+o*(a*g-h*f)),this.data[10]=t*(i*(s*m-c*p)-r*(a*m-c*f)+o*(a*p-s*f)),this.data[11]=-t*(i*(s*g-h*p)-r*(a*g-h*f)+n*(a*p-s*f)),this.data[12]=-t*(r*(h*y-c*d)-n*(s*y-c*l)+o*(s*d-h*l)),this.data[13]=t*(i*(h*y-c*d)-n*(a*y-c*u)+o*(a*d-h*u)),this.data[14]=-t*(i*(s*y-c*l)-r*(a*y-c*u)+o*(a*l-s*u)),this.data[15]=t*(i*(s*d-h*l)-r*(a*d-h*u)+n*(a*l-s*u)),e},transformVector:function(t){var e=t.x,i=t.y,r=t.z;return t.x=e*this.data[0]+i*this.data[4]+r*this.data[8]+this.data[12],t.y=e*this.data[1]+i*this.data[5]+r*this.data[9]+this.data[13],t.z=e*this.data[2]+i*this.data[6]+r*this.data[10]+this.data[14],t},copyToMatrix:function(t,e){e.data[0]=t.data[0],e.data[1]=t.data[1],e.data[2]=t.data[2],e.data[3]=t.data[3],e.data[4]=t.data[4],e.data[5]=t.data[5],e.data[6]=t.data[6],e.data[7]=t.data[7],e.data[8]=t.data[8],e.data[9]=t.data[9],e.data[10]=t.data[10],e.data[11]=t.data[11],e.data[12]=t.data[12],e.data[13]=t.data[13],e.data[14]=t.data[14],e.data[15]=t.data[15]},copy:function(){var t=new Ayce.Matrix4;return t.data=new Float32Array(this.data),t},getMatrix3:function(t){var e;return e=t?t:new Ayce.Matrix3,e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=this.data[2],e.data[3]=this.data[4],e.data[4]=this.data[5],e.data[5]=this.data[6],e.data[6]=this.data[8],e.data[7]=this.data[9],e.data[8]=this.data[10],e}},Ayce.Matrix3=function(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1])},Ayce.Matrix3.prototype={},Ayce.Geometry=function(){this.position=new Ayce.Vector3(0,0,0),this.rotation=new Ayce.Quaternion,this.scale=new Ayce.Vector3(1,1,1),this.offset=new Ayce.Vector3(0,0,0)},Ayce.Geometry.prototype={},Ayce.Geometry.Box=function(t,e,i){Ayce.Geometry.call(this),this.a=t||0,this.b=e||0,this.c=i||0},Ayce.Geometry.Box.prototype=new Ayce.Geometry,Ayce.Geometry.Box.prototype.getO3D=function(t){var e=new Ayce.Object3D,i=this.offset,r=this.a,n=this.b,o=this.c;return e.vertices=[],e.vertices.push(i.x+0,i.y+0,i.z+0),e.vertices.push(i.x+r,i.y+0,i.z+0),e.vertices.push(i.x+0,i.y+n,i.z+0),e.vertices.push(i.x+r,i.y+n,i.z+0),e.vertices.push(i.x+0,i.y+0,i.z+o),e.vertices.push(i.x+r,i.y+0,i.z+o),e.vertices.push(i.x+0,i.y+n,i.z+o),e.vertices.push(i.x+r,i.y+n,i.z+o),e.normals=[],e.normals.push(-1,-1,-1),e.normals.push(1,-1,-1),e.normals.push(-1,1,-1),e.normals.push(1,1,-1),e.normals.push(-1,-1,1),e.normals.push(1,-1,1),e.normals.push(-1,1,1),e.normals.push(1,1,1),e.indices=[],t?(e.indices.push(0,1),e.indices.push(5,1),e.indices.push(4,0),e.indices.push(4,5),e.indices.push(2,6),e.indices.push(6,7),e.indices.push(7,3),e.indices.push(3,2),e.indices.push(0,2),e.indices.push(4,6),e.indices.push(5,7),e.indices.push(3,1),e.isWireframe=!0):(e.indices.push(2,1,0),e.indices.push(2,3,1),e.indices.push(7,4,5),e.indices.push(7,6,4),e.indices.push(6,0,4),e.indices.push(6,2,0),e.indices.push(3,5,1),e.indices.push(3,7,5),e.indices.push(0,5,4),e.indices.push(0,1,5),e.indices.push(6,3,2),e.indices.push(6,7,3)),e.position=this.position,e.rotation=this.rotation,e.scale=this.scale,e},Ayce.Geometry.Box.prototype.containsPoint=function(t){var e=this,i=function(t){var i=e.position.copy().addVector3(t).addVector3(e.offset);return i.multiply(e.scale.x,e.scale.y,e.scale.z),i=e.rotation.getRotatedPoint(i)},r=function(t,e,i,r){e=e.copy().subtract(t.x,t.y,t.z),i=i.copy().subtract(t.x,t.y,t.z);var n=e.copy().crossProduct(i).normalize(),o=r.copy().subtract(t.x,t.y,t.z),a=n.dotProduct(o);return a},n=i(new Ayce.Vector3(0,0,0)),o=i(new Ayce.Vector3(0,this.b,0)),a=i(new Ayce.Vector3(this.a,this.b,0)),s=i(new Ayce.Vector3(0,0,this.c)),h=i(new Ayce.Vector3(this.a,0,this.c)),c=i(new Ayce.Vector3(0,this.b,this.c)),u=i(new Ayce.Vector3(this.a,this.b,this.c)),l=r(c,o,u,t),d=r(s,h,n,t),y=r(c,s,n,t),f=r(u,a,h,t),p=r(c,u,s,t),g=r(o,n,a,t),s=l>0&&d>0&&y>0&&f>0&&p>0&&g>0;return s},Ayce.Geometry.Sphere=function(t){Ayce.Geometry.call(this),this.r=t||0},Ayce.Geometry.Sphere.prototype=new Ayce.Geometry,Ayce.Geometry.Sphere.prototype.getO3D=function(t,e,i){this.scale=null;var r,n,o=e||10,a=i||10,s=this.r,h=this.offset,c=new Ayce.Object3D;for(c.vertices=[],c.normals=[],c.textureCoords=[],r=0;r<=a;r++){var u=r*Math.PI/a,l=Math.sin(u),d=Math.cos(u);for(n=0;n<=o;n++){var y=2*n*Math.PI/o,f=Math.sin(y),p=Math.cos(y),g=p*l,m=d,x=f*l,v=1-n/o,A=1-r/a;c.normals.push(g,m,x),c.textureCoords.push(v,A),c.vertices.push(s*g+h.x,s*m+h.y,s*x+h.z)}}for(t&&(c.isWireframe=!0),c.indices=[],r=0;r<a;r++)for(n=0;n<o;n++){var w=r*(o+1)+n,M=w+o+1;t?(c.indices.push(M+1,M),c.indices.push(M,w),c.indices.push(w+1,w),c.indices.push(w+1,M+1)):(c.indices.push(w+1,M,w),c.indices.push(w+1,M+1,M))}return c.position=this.position,c.rotation=this.rotation,c},Ayce.Geometry.Plane=function(t,e,i,r,n){Ayce.Geometry.call(this),this.a=t||0,this.b=e||0,this.xVertices=i||2,this.yVertices=r||2,this.splitSquares=n},Ayce.Geometry.Plane.prototype=new Ayce.Geometry,Ayce.Geometry.Plane.prototype.getO3D=function(){var t=new Ayce.Object3D,e=this.offset,i=this.a,r=this.b,n=this.xVertices,o=this.yVertices;t.vertices=[];var a,s,h=i/n,c=r/o;if(this.splitSquares){for(s=0;s<this.yVertices-1;s++)for(a=0;a<this.xVertices-1;a++)t.vertices.push(e.x+a*h,e.y+s*c,e.z,e.x+a*h+h,e.y+s*c,e.z,e.x+a*h,e.y+s*c+c,e.z,e.x+a*h+h,e.y+s*c,e.z,e.x+a*h+h,e.y+s*c+c,e.z,e.x+a*h,e.y+s*c+c,e.z);t.normals=[],t.indices=[];for(var u=0;u<t.vertices.length/3;u++)t.normals.push(0,0,1),t.indices.push(u)}else{for(s=0;s<this.yVertices;s++)for(a=0;a<this.xVertices;a++)t.vertices.push(e.x+a*h,e.y+s*c,e.z);for(t.normals=[],u=0;u<n*o;u++)t.normals.push(0,0,1);for(t.indices=[],u=0;u<n*(o-1);u++)(u+1)%n!=0&&t.indices.push(u+1,u+n,u,u+n+1,u+n,u+1)}return t.position=this.position,t.rotation=this.rotation,t.scale=this.scale,t},Ayce.Geometry.Icosahedron=function(t){this.subdivisions=t,Ayce.Geometry.call(this)},Ayce.Geometry.Icosahedron.prototype=new Ayce.Geometry,Ayce.Geometry.Icosahedron.prototype.getO3D=function(){var t=new Ayce.Object3D,e=new Ayce.Vector2(.5,(1+Math.sqrt(5))/2-(1+Math.sqrt(5))/2/2),i=new Ayce.Vector2(-e.x,e.y),r=new Ayce.Vector2(e.x,e.y),n=new Ayce.Vector2(-e.x,-e.y),o=new Ayce.Vector2(e.x,-e.y),a=[];a.push(i.x,i.y,0,r.x,r.y,0,n.x,n.y,0,o.x,o.y,0,0,i.x,i.y,0,r.x,r.y,0,n.x,n.y,0,o.x,o.y,i.y,0,i.x,r.y,0,r.x,n.y,0,n.x,o.y,0,o.x),t.vertices=[a[0],a[1],a[2],a[15],a[16],a[17],a[3],a[4],a[5],a[0],a[1],a[2],a[3],a[4],a[5],a[21],a[22],a[23],a[0],a[1],a[2],a[30],a[31],a[32],a[33],a[34],a[35],a[0],a[1],a[2],a[21],a[22],a[23],a[30],a[31],a[32],a[0],a[1],a[2],a[33],a[34],a[35],a[15],a[16],a[17],a[3],a[4],a[5],a[27],a[28],a[29],a[24],a[25],a[26],a[3],a[4],a[5],a[24],a[25],a[26],a[21],a[22],a[23],a[3],a[4],a[5],a[15],a[16],a[17],a[27],a[28],a[29],a[12],a[13],a[14],a[27],a[28],a[29],a[15],a[16],a[17],a[12],a[13],a[14],a[9],a[10],a[11],a[27],a[28],a[29],a[12],a[13],a[14],a[15],a[16],a[17],a[33],a[34],a[35],a[6],a[7],a[8],a[33],a[34],a[35],a[30],a[31],a[32],a[6],a[7],a[8],a[12],a[13],a[14],a[33],a[34],a[35],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[9],a[10],a[11],a[24],a[25],a[26],a[27],a[28],a[29],a[18],a[19],a[20],a[6],a[7],a[8],a[30],a[31],a[32],a[18],a[19],a[20],a[9],a[10],a[11],a[6],a[7],a[8],a[18],a[19],a[20],a[24],a[25],a[26],a[9],a[10],a[11],a[18],a[19],a[20],a[21],a[22],a[23],a[24],a[25],a[26],a[18],a[19],a[20],a[30],a[31],a[32],a[21],a[22],a[23]];var s=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2)),h=[t.vertices],c=this.subdivisions-1;i=new Ayce.Vector3(0,0,0),r=new Ayce.Vector3(0,0,0),n=new Ayce.Vector3(0,0,0);for(var u,l=new Ayce.Vector3(0,0,0),d=new Ayce.Vector3(0,0,0),y=new Ayce.Vector3(0,0,0),f=1;f<c+1;f++)h[f]=[];for(f=0;f<h.length-1;f++)for(var p=0;p<h[f].length;p+=9)i.set(h[f][p],h[f][p+1],i.z=h[f][p+2]),r.set(h[f][p+3],h[f][p+4],h[f][p+5]),n.set(h[f][p+6],h[f][p+7],h[f][p+8]),l.set((i.x+r.x)/2,(i.y+r.y)/2,(i.z+r.z)/2),u=s/Math.sqrt(l.x*l.x+l.y*l.y+l.z*l.z),l.x*=u,l.y*=u,l.z*=u,d.set((r.x+n.x)/2*u,(r.y+n.y)/2*u,(r.z+n.z)/2*u),y.set((i.x+n.x)/2*u,(i.y+n.y)/2*u,(i.z+n.z)/2*u),h[f+1].push(i.x,i.y,i.z,l.x,l.y,l.z,y.x,y.y,y.z,r.x,r.y,r.z,d.x,d.y,d.z,l.x,l.y,l.z,n.x,n.y,n.z,y.x,y.y,y.z,d.x,d.y,d.z,l.x,l.y,l.z,d.x,d.y,d.z,y.x,y.y,y.z),p==h[f].length-1&&c--;for(t.vertices=h[h.length-1],t.indices=[],f=0;f<t.vertices.length/3;f++)t.indices.push(f);var g;for(t.normals=[],f=0;f<t.vertices.length;f+=9)i.set(t.vertices[f],t.vertices[f+1],t.vertices[f+2]),r.set(t.vertices[f+3],t.vertices[f+4],t.vertices[f+5]),n.set(t.vertices[f+6],t.vertices[f+7],t.vertices[f+8]),l=r.subtract(i.x,i.y,i.z),y=n.subtract(i.x,i.y,i.z),g=l.crossProduct(y),t.normals.push(g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z);return t.position=this.position,t.rotation=this.rotation,t.scale=this.scale,t},Ayce.Geometry.CollisionMath={},Ayce.Geometry.CollisionMath.ObjectPool={corners1:[new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3],corners2:[new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3],normals:[new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3],edgeNormalV1:new Ayce.Vector3,edgeNormalV2:new Ayce.Vector3},Ayce.Geometry.CollisionMath.calcCorner=function(t,e,i,r,n){t.x=i?e.a:0,t.y=r?e.b:0,t.z=n?e.c:0,t.addVector3(e.offset),t.multiply(e.scale.x,e.scale.y,e.scale.z),e.rotation.getConjugate().rotatePoint(t),t.addVector3(e.position)},Ayce.Geometry.CollisionMath.calcNormal=function(t,e,i,r){var n=i.x-e.x,o=i.y-e.y,a=i.z-e.z,s=r.x-e.x,h=r.y-e.y,c=r.z-e.z;t.x=o*c-a*h,t.y=a*s-n*c,t.z=n*h-o*s,t.normalize()},Ayce.Geometry.CollisionMath.getEdgeNormal=function(t,e,i,r){var n=Ayce.Geometry.CollisionMath.ObjectPool.edgeNormalV1;n.x=i.x-e.x,n.y=i.y-e.y,n.z=i.z-e.z,n.normalize();var o=n.x*(r.x-e.x)+n.y*(r.y-e.y)+n.z*(r.z-e.z);t.x=n.x*o+e.x-r.x,t.y=n.y*o+e.y-r.y,t.z=n.z*o+e.z-r.z,t.normalize()},Ayce.Geometry.prototype.boxBoxCollision=function(t,e){var i=Ayce.Geometry.CollisionMath.calcCorner,r=Ayce.Geometry.CollisionMath.calcNormal,n=Ayce.Geometry.CollisionMath.ObjectPool.corners1;i(n[0],t,!1,!1,!1),i(n[1],t,!0,!1,!1),i(n[2],t,!1,!0,!1),i(n[3],t,!0,!0,!1),i(n[4],t,!1,!1,!0),i(n[5],t,!0,!1,!0),i(n[6],t,!1,!0,!0),i(n[7],t,!0,!0,!0);var o=Ayce.Geometry.CollisionMath.ObjectPool.corners2;i(o[0],e,!1,!1,!1),i(o[1],e,!0,!1,!1),i(o[2],e,!1,!0,!1),i(o[3],e,!0,!0,!1),i(o[4],e,!1,!1,!0),i(o[5],e,!0,!1,!0),i(o[6],e,!1,!0,!0),i(o[7],e,!0,!0,!0);var a=Ayce.Geometry.CollisionMath.ObjectPool.normals,s=6;r(a[0],n[0],n[1],n[2]),r(a[1],n[0],n[4],n[2]),r(a[2],n[0],n[1],n[4]),r(a[3],o[0],o[1],o[2]),r(a[4],o[0],o[4],o[2]),r(a[5],o[0],o[1],o[4]);var h,c,u=null;for(h=0;h<s;h++){var l=a[h];if(0!==l.x||0!==l.y||0!==l.z){var d=null,y=null;for(c=0;c<n.length;c++){var f=l.dotProduct(n[c]);(null===d||f<d)&&(d=f),(null===y||f>y)&&(y=f)}var p=null,g=null;for(c=0;c<o.length;c++){var f=l.dotProduct(o[c]);(null===p||f<p)&&(p=f),(null===g||f>g)&&(g=f)}if(y<p||d>g)return null;var m=y-p;Math.abs(g-d)<Math.abs(m)&&(m=g-d),Math.abs(d-g)<Math.abs(m)&&(m=d-g),Math.abs(p-y)<Math.abs(m)&&(m=p-y),d>p&&(m=-m);var x=l.copy().scaleBy(m);(null===u||u.getLength()>x.getLength())&&(u=x,u.normal=l,u.distance=m)}}return u},Ayce.Geometry.prototype.boxSphereCollision=function(t,e,i){0!==t.a&&0!==t.b&&0!==t.c||(i=!0);var r=Ayce.Geometry.CollisionMath.calcCorner,n=Ayce.Geometry.CollisionMath.calcNormal,o=Ayce.Geometry.CollisionMath.getEdgeNormal,a=Ayce.Geometry.CollisionMath.ObjectPool.corners1;r(a[0],t,!1,!1,!1),r(a[1],t,!0,!1,!1),r(a[2],t,!1,!0,!1),r(a[3],t,!0,!0,!1),r(a[4],t,!1,!1,!0),r(a[5],t,!0,!1,!0),r(a[6],t,!1,!0,!0),r(a[7],t,!0,!0,!0);var s=e.position.copy().addVector3(e.offset),h=Ayce.Geometry.CollisionMath.ObjectPool.normals,c=15;n(h[0],a[0],a[1],a[2]),n(h[1],a[0],a[2],a[4]),n(h[2],a[0],a[4],a[1]),o(h[3],a[0],a[1],s),o(h[4],a[1],a[5],s),o(h[5],a[4],a[5],s),o(h[6],a[4],a[0],s),o(h[7],a[2],a[6],s),o(h[8],a[7],a[6],s),o(h[9],a[7],a[3],s),o(h[10],a[3],a[2],s),o(h[11],a[0],a[2],s),o(h[12],a[1],a[3],s),o(h[13],a[7],a[5],s),o(h[14],a[6],a[4],s);var u,l,d=null;for(u=0;u<c;u++){var y=h[u];if(0!==y.x||0!==y.y||0!==y.z){var f=null,p=null;for(l=0;l<a.length;l++){var g=y.dotProduct(a[l]);(null===f||g<f)&&(f=g),(null===p||g>p)&&(p=g)}var m=y.dotProduct(s),x=m-e.r,v=m+e.r;if(p<x||f>v)return null;var A=p-x;Math.abs(v-f)<Math.abs(A)&&(A=v-f),Math.abs(f-v)<Math.abs(A)&&(A=f-v),Math.abs(x-p)<Math.abs(A)&&(A=x-p);var w=y.copy().scaleBy(A);(i&&f>x||!i&&f<x)&&w.negate(),(null===d||d.getLength()>w.getLength())&&(d=w,d.distance=A,d.normal=y)}}return d},Ayce.Geometry.prototype.sphereSphereCollision=function(t,e){var i=t.position.copy().addVector3(t.offset),r=e.position.copy().addVector3(e.offset),n=i.copy().subtract(r.x,r.y,r.z).getLength();if(n<t.r+e.r){var o=t.position,a=e.position.copy().subtract(o.x,o.y,o.z).normalize().scaleBy(t.r+e.r-n);return a.distance=n,a.normal=a,a}return null},Ayce.Timer=function(){},Ayce.Timer.prototype={},Ayce.Timer.prototype.getCurrentTimeMs=function(){return(new Date).getTime()},Ayce.XMLLoader=function(){},Ayce.XMLLoader.getSourceSynch=function(t){var e=new XMLHttpRequest;return e.open("GET",t,!1),e.send(),200==e.status?e.responseText:null},Ayce.XMLLoader.prototype={},Ayce.Renderer=function(t){var e,i=0,r=this;this.width=0,this.height=0,this.clearColor={red:0,green:0,blue:0},this.init=function(){t.width=this.width,t.height=this.height,o(t),n()},this.resize=function(){t.width=this.width,t.height=this.height,e.viewportWidth=t.width,e.viewportHeight=t.height,r.setViewportAndScissor(0,0,e.viewportWidth,e.viewportHeight)};var n=function(){e.clearColor(r.clearColor.red,r.clearColor.green,r.clearColor.blue,1),r.setViewportAndScissor(0,0,e.viewportWidth,e.viewportHeight),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.cullFace(e.FRONT),e.frontFace(e.CW),e.enable(e.SCISSOR_TEST)},o=function(t){try{var i={alpha:!1};e=t.getContext("webgl",i),e||(e=t.getContext("experimental-webgl",i)),e.viewportWidth=t.width,e.viewportHeight=t.height,e.ext=e.getExtension("OES_vertex_array_object"),e.shaders={},e.ext||console.warn("Can't get OES_vertex_array_object extension.")}catch(t){}e||alert("Could not initialise WebGL.")};this.update=function(t,e,r){for(i=0;i<e.length;i++)e[i].buffer.update(t);for(i=0;i<r.length;i++)r[i].buffer.update(t)},this.render=function(t,r,n){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var o;for(i=0;i<r.length;i++)o=r[i].buffer,o.render();for(i=0;i<n.length;i++)o=n[i].buffer,o.render()},this.setViewportAndScissor=function(t,i,r,n){e.viewport(t,i,r,n),e.scissor(t,i,r,n),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)},this.getBuffer=function(t,i){if(!t instanceof Ayce.Object3D)throw"Can't get Buffer for "+t;return new Ayce.BufferMulti(e,t,i)},this.getCanvasHeight=function(){return e.viewportHeight},this.getCanvasWidth=function(){return e.viewportWidth},this.getGL=function(){return e}},Ayce.Renderer.prototype={},Ayce.VRRenderer=function(t,e,i){function r(){var t=h.createFramebuffer();h.bindFramebuffer(h.FRAMEBUFFER,t),y=t.width=1024,f=t.height=1024;var e=h.createTexture();h.bindTexture(h.TEXTURE_2D,e),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.LINEAR),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,t.width,t.height,0,h.RGBA,h.UNSIGNED_BYTE,null);var i=h.createRenderbuffer();return h.bindRenderbuffer(h.RENDERBUFFER,i),h.renderbufferStorage(h.RENDERBUFFER,h.DEPTH_COMPONENT16,t.width,t.height),h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,e,0),h.framebufferRenderbuffer(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.RENDERBUFFER,i),h.bindTexture(h.TEXTURE_2D,null),h.bindRenderbuffer(h.RENDERBUFFER,null),h.bindFramebuffer(h.FRAMEBUFFER,null),[t,e]}function n(){var t,e=m.vertices.slice();for(t=M;t<=m.vertices.length;t+=M)e.splice(t+(t/M-1)*R,0,m.textureCoords[(t/M-1)*R],m.textureCoords[(t/M-1)*R+1]);w=4*(M+R),g=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,g),h.bufferData(h.ARRAY_BUFFER,new Float32Array(e),h.STATIC_DRAW),g.numItems=4,h.enableVertexAttribArray(p.vertexPositionAttribute),h.vertexAttribPointer(p.vertexPositionAttribute,M,h.FLOAT,!1,w,0),h.enableVertexAttribArray(p.textureCoordAttribute),h.vertexAttribPointer(p.textureCoordAttribute,R,h.FLOAT,!1,w,4*M);
}function o(t,e){h.bindFramebuffer(h.FRAMEBUFFER,c),v.setViewportAndScissor(0,0,y,f),s(t,"left"),s(e,"left"),h.bindFramebuffer(h.FRAMEBUFFER,u),v.setViewportAndScissor(0,0,y,f),s(t,"right"),s(e,"right"),h.bindFramebuffer(h.FRAMEBUFFER,null),p.initShaders(),h.bindBuffer(h.ARRAY_BUFFER,g),h.vertexAttribPointer(p.vertexPositionAttribute,M,h.FLOAT,!1,w,0),h.vertexAttribPointer(p.textureCoordAttribute,R,h.FLOAT,!1,w,4*M),h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,l),h.uniform1i(p.samplerUniform,0),v.setViewportAndScissor(0,0,h.viewportWidth,h.viewportHeight),h.uniformMatrix4fv(p.pMatrixUniform,!1,x.getPerspectiveMatrix().data),h.uniformMatrix4fv(p.mvMatrixUniform,!1,x.getViewMatrix().data),h.drawArrays(h.TRIANGLE_STRIP,0,g.numItems),h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,d),h.uniform1i(p.samplerUniform,0),v.setViewportAndScissor(h.viewportWidth,0,h.viewportWidth,h.viewportHeight),h.uniformMatrix4fv(p.pMatrixUniform,!1,x.getPerspectiveMatrix().data),h.uniformMatrix4fv(p.mvMatrixUniform,!1,x.getViewMatrix().data),h.drawArrays(h.TRIANGLE_STRIP,0,g.numItems),h.bindTexture(h.TEXTURE_2D,null)}function a(t,e){v.setViewportAndScissor(0,0,h.viewportWidth,h.viewportHeight),s(t,"left"),s(e,"left"),v.setViewportAndScissor(h.viewportWidth,0,h.viewportWidth,h.viewportHeight),s(t,"right"),s(e,"right"),Ayce.HMDHandler.renderToHMD()}function s(t,e){for(var i=0;i<t.length;i++)t[i].buffer.renderVR(e)}Ayce.Renderer.call(this,t);var h,c,u,l,d,y,f,p,g,m,x,v=this,A=0,w=0,M=3,R=2;this.resize=function(){i?(t.width=i.cameraProperties.renderRectWidth,t.height=i.cameraProperties.renderRectHeight):(console.warn("Can't get renderRect from cameraProperties."),t.width=this.width*window.devicePixelRatio,t.height=this.height*window.devicePixelRatio),t.style.width=this.width+"px",t.style.height=this.height+"px",console.log("Resolution: "+t.width+"x"+t.height," Style: "+t.style.width+" - "+t.style.height),h.viewportWidth=t.width/2,h.viewportHeight=t.height,v.setViewportAndScissor(0,0,h.viewportWidth,h.viewportHeight)};var b=this.init;this.init=function(){console.log("Initializing VRRenderer"),b(),h=this.getGL();var t=r();c=t[0],l=t[1],t=r(),u=t[0],d=t[1],m=new Ayce.VRSquare;var e=Ayce.VRRenderer.prototype.vrCanvasVert,i=Ayce.VRRenderer.prototype.vrCanvasFrag;p=new Ayce.Shader(h,e,i),p.pMatrixUniform=p.getUniformLocation("uPMatrix"),p.mvMatrixUniform=p.getUniformLocation("uMVMatrix"),p.vertexPositionAttribute=p.getAttribLocation("aVertexPosition"),p.textureCoordAttribute=p.getAttribLocation("aTextureCoord"),p.samplerUniform=p.getUniformLocation("uSampler");var o=new Ayce.CameraModifier;o.getPosition().set(0,0,2.3),o.getOrientation().set(0,0,0,1);var a=new Ayce.CameraManager;a.modifiers.push(o),x=new Ayce.Camera(a),x.isOrtho=!0,x.updateProjectionMatrix(),x.update(),n(),h.enable(h.SCISSOR_TEST)},this.update=function(t,e,i){for(A=0;A<e.length;A++)e[A].buffer.updateVR(t);for(A=0;A<i.length;A++)i[A].buffer.updateVR(t)},this.render=function(t,i,r){e?o(i,r):a(i,r)}},Ayce.VRRenderer.prototype=new Ayce.Renderer,Ayce.VRRenderer.prototype.vrCanvasVert="attribute vec3 aVertexPosition;attribute vec2 aTextureCoord;uniform mat4 uMVMatrix;uniform mat4 uPMatrix;varying vec2 vTextureCoord;void main(void) {gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);vTextureCoord = aTextureCoord;}",Ayce.VRRenderer.prototype.vrCanvasFrag="precision mediump float;uniform sampler2D uSampler;uniform bool uUseTextures;varying vec2 vTextureCoord;varying vec4 vColor;void main(void) {    float distance = sqrt(abs(0.5-vTextureCoord.s)*abs(0.5-vTextureCoord.s)+abs(0.5-vTextureCoord.t)*abs(0.5-vTextureCoord.t));    float distanceS = (0.5-vTextureCoord.s);    float distanceT = (0.5-vTextureCoord.t);    float factor = 1.0+0.22*distance*distance+0.24*distance*distance*distance*distance;    float newCoordS = (vTextureCoord.s-0.5)*factor;    float newCoordT = (vTextureCoord.t-0.5)*factor;    float offsetR = 1.0;    float offsetG = 0.995;    float offsetB = 0.980;    float newCoordSR = newCoordS/offsetR+0.5;    float newCoordSG = newCoordS/offsetG+0.5;    float newCoordSB = newCoordS/offsetB+0.5;    float newCoordTR = newCoordT/offsetR+0.5;    float newCoordTG = newCoordT/offsetG+0.5;    float newCoordTB = newCoordT/offsetB+0.5;    if(newCoordSR<0.0||newCoordSR>1.0    ||newCoordSG<0.0||newCoordSG>1.0    ||newCoordSB<0.0||newCoordSB>1.0    ||newCoordTR<0.0||newCoordTR>1.0    ||newCoordTG<0.0||newCoordTG>1.0    ||newCoordTB<0.0||newCoordTB>1.0){        gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);    }else{        float r = texture2D(uSampler, vec2(newCoordSR, newCoordTR)).r;        float g = texture2D(uSampler, vec2(newCoordSG, newCoordTG)).g;        float b = texture2D(uSampler, vec2(newCoordSB, newCoordTB)).b;        gl_FragColor = vec4(r, g, b, 1.0);    }}",Ayce.Scene=function(t){var e=this,i=0,r=!0,n=new Ayce.Camera(new Ayce.CameraManager),o=new Ayce.AudioContext,a=null,s=new Ayce.KeyboardHandler,h=[],c=[],u=new Ayce.LightContainer,l=[];this.render=!0,this.width=t.parentNode.clientWidth,this.height=t.parentNode.clientHeight,this.presentationPreset={useWebVR:function(){var i=function(){var i=n.getManager();i.modifiers.push(new Ayce.WebVR),n.update(),e.setRenderer(new Ayce.VRRenderer(t,!1,i)),n.useVR=!0,i.initHMDControls(),e.resize()},r=n.getManager().modifiers;if(r&&r.length>0)throw"Camera modifiers not empty. Please call camera.getManager().clearModifiers() first.";return Ayce.HMDHandler.isWebVRReady()?(Ayce.HMDHandler.isHMDReady()?i():Ayce.HMDHandler.onHMDReady=i,new Ayce.WebVRAccess(t)):(console.warn("Browser dosen't support WebVR."),null)},useCardboard:function(t){e.useMotionSensor(),e.setRendererVR(t),n.useVR=!0,e.resize()}},this.setFullscreenElement=function(e){var i=this,r=null;e.addEventListener("click",function(){var e=i.getCamera();e.setFullscreen(!e.isFullscreen(),t),e.isFullscreen()?("orientation"in screen&&screen.orientation.lock("landscape-primary").catch(function(){}),window.navigator.requestWakeLock&&(r=window.navigator.requestWakeLock("screen")),window.navigator.wakeLock&&window.navigator.wakeLock.request("screen"),screen.keepAwake=!0,Ayce.HMDHandler.showInHMD(t)):("orientation"in screen&&screen.orientation.unlock().catch(function(){}),window.navigator.requestWakeLock&&r&&r.unlock(),screen.keepAwake=!1)})},this.useMotionSensor=function(){var t=n.getManager().modifiers;if(t&&t.length>0)throw"Camera modifiers not empty. Please call camera.getManager().clearModifiers() first.";t.push(new Ayce.Cardboard)},this.resize=function(){this.width=t.parentNode.clientWidth,this.height=t.parentNode.clientHeight,a.width=this.width,a.height=this.height,a.resize(),n.width=a.getCanvasWidth(),n.height=a.getCanvasHeight(),n.updateProjectionMatrix()},this.setRendererDesktop=function(){this.setRenderer(new Ayce.Renderer(t)),n.useVR=!1,this.resize()},this.setRendererVR=function(e){this.setRenderer(new Ayce.VRRenderer(t,e)),n.useVR=!0,this.resize()},this.setRenderer=function(e){var i=null;a&&(e.clearColor=a.clearColor,i=a.getGL().shaders),a=e,a.width=this.width,a.height=this.height,a.init(),t.style.width="auto",t.style.height="auto",i&&(a.getGL().shaders=i)},this.setRendererDesktop(),window.attachEvent?window.attachEvent("onresize",this.resize):window.addEventListener&&window.addEventListener("resize",this.resize,!0),this.updateScene=function(){for(r&&(d(h),d(c),r=!1),s.update(),n.update(),u.update(n),i=0;i<h.length;i++)h[i].update();for(i=0;i<c.length;i++)c[i].update();for(a.update(n,h,c),i=0;i<l.length;i++){l[i].listenerPosition=n.getManager().getGlobalPosition();var t=n.getManager().getGlobalRotation(),e=t.getForwardVector(),o=t.getUpVector();l[i].listenerOrientationFront.x=e.x,l[i].listenerOrientationFront.y=e.y,l[i].listenerOrientationFront.z=e.z,l[i].listenerOrientationUp.x=o.x,l[i].listenerOrientationUp.y=o.y,l[i].listenerOrientationUp.z=o.z,l[i].update()}},this.drawScene=function(){if(this.render&&!r){for(var t=0,e=0;e<c.length;e++)if(!c[e].renderPriority){var i=c[e].getGlobalPosition(),o=n.getManager();c[e].distance=Math.sqrt(Math.pow(o.getGlobalPosition().x-i.x,2)+Math.pow(o.getGlobalPosition().y-i.y,2)+Math.pow(o.getGlobalPosition().z-i.z,2)),c[e].distance>t&&(t=c[e].distance)}for(e=0;e<c.length;e++)c[e].renderPriority&&(c[e].renderPriority>0?c[e].distance=t+c[e].renderPriority:c[e].distance=c[e].renderPriority);c.sort(function(t,e){return e.distance-t.distance}),a.render(n,h,c)}};var d=function(t){for(i=0;i<t.length;i++)t[i].buffer&&t[i].buffer.dispose(),t[i].buffer=a.getBuffer(t[i],u)};this.addToScene=function(t){if(t instanceof Ayce.Light)u.addLight(t),r=!0;else if(t instanceof Ayce.Object3D)r||(t.buffer=a.getBuffer(t,u)),t.calcBoundingBox(),t.calcBoundingSphere(),t.transparent?c.push(t):h.push(t);else{if(!(t instanceof Ayce.Sound))throw"Can't add to scene. Unknown type: "+typeof t;t.init(o),l.push(t)}},this.removeFromScene=function(t){if(t instanceof Ayce.Light)u.removeLight(t);else if(t instanceof Ayce.Object3D){for(i=0;i<h.length;i++)h[i]===t&&h.splice(i,1);for(i=0;i<c.length;i++)c[i]===t&&c.splice(i,1)}else{if(!(t instanceof Ayce.Sound))throw"Can't remove from scene: "+typeof t;for(i=0;i<l.length;i++)l[i]===t&&(l[i].stop(),l.splice(i,1))}},this.getCamera=function(){return n},this.setClearColor=function(t,e,i){a.clearColor.red=t,a.clearColor.green=e,a.clearColor.blue=i,a.getGL().clearColor(t,e,i,1)},this.setAmbientLight=function(t,e,i){u.ambientLight.red=t,u.ambientLight.green=e,u.ambientLight.blue=i}},Ayce.WebVRAccess=function(t){this.setHMDEnterElement=function(e){e.addEventListener("click",function(){Ayce.HMDHandler.showInHMD(t)})},this.setHMDExitElement=function(t){t.addEventListener("click",function(){Ayce.HMDHandler.exitHMD()})}},Ayce.Light=function(){this.position=new Ayce.Vector3,this.color={red:1,green:1,blue:1},this.specularColor={red:1,green:1,blue:1}},Ayce.LightContainer=function(){var t=[];this.locationsArray=[],this.locationsArrayLeftEye=[],this.locationsArrayRightEye=[],this.colorsArray=[],this.specColorsArray=[],this.lightsCount=0,this.ambientLight={red:.5,green:.5,blue:.5};var e=new Ayce.Vector3;this.addLight=function(e){t.push(e),this.lightsCount=t.length},this.removeLight=function(e){var i=t.indexOf(e);i!==-1&&t.splice(i,1),this.locationsArray.splice(i,1),this.colorsArray.splice(i,1),this.specColorsArray.splice(i,1)},this.update=function(i){var r,n,o=0;if(i.useVR){for(r=i.getViewMatrix("left"),o=0;o<t.length;o++)Ayce.Vector3.prototype.copyToVector(t[o].position,e),n=r.transformVector(e),this.locationsArrayLeftEye[3*o+0]=n.x,this.locationsArrayLeftEye[3*o+1]=n.y,this.locationsArrayLeftEye[3*o+2]=n.z;for(r=i.getViewMatrix("right"),o=0;o<t.length;o++)Ayce.Vector3.prototype.copyToVector(t[o].position,e),n=r.transformVector(e),this.locationsArrayRightEye[3*o+0]=n.x,this.locationsArrayRightEye[3*o+1]=n.y,this.locationsArrayRightEye[3*o+2]=n.z}else for(r=i.getViewMatrix(),o=0;o<t.length;o++)Ayce.Vector3.prototype.copyToVector(t[o].position,e),n=r.transformVector(e),this.locationsArray[3*o+0]=n.x,this.locationsArray[3*o+1]=n.y,this.locationsArray[3*o+2]=n.z;for(o=0;o<t.length;o++)this.colorsArray[3*o+0]=t[o].color.red,this.colorsArray[3*o+1]=t[o].color.green,this.colorsArray[3*o+2]=t[o].color.blue,this.specColorsArray[3*o+0]=t[o].specularColor.red,this.specColorsArray[3*o+1]=t[o].specularColor.green,this.specColorsArray[3*o+2]=t[o].specularColor.blue;this.lightsCount=t.length}},Ayce.LightContainer.prototype={},Ayce.Buffer=function(t,e,i,r,n,o){o=o||t.TRIANGLES;var a,s,h,c,u=[],l=[],d=[];this.indices=null,this.useTexture=!1,this.useSpecularMap=!1,this.useTransparency=!1,this.texturesO3D=null,this.isSkybox=!1;var y=!1,f=!1,p=!1,g=0,m=0;this.init=function(){y=this.useTexture,f=this.useSpecularMap,p=this.useNormalMap;var o,x=0;for(g=0;g<r.length;g++)o=r[g],o[3]=i.getAttribLocation(o[0]),o[4]=x,x+=4*o[1],m+=4*o[1];for(g=0;g<n.length;g++){var v=n[g];v[4]=new Array(1+v[3].length),v[4][0]=i.getUniformLocation(v[0])}if(this.useTexture)for(i.samplerUniform=i.getUniformLocation("uSampler"),g=0;g<this.texturesO3D.length;g++)u.push(this.loadImage(t,this.texturesO3D[g],this.isSkybox));if(this.useSpecularMap)for(this.texturesO3D=Array.isArray(e.specularMap)?e.specularMap:[e.specularMap],i.specularMapUniform=i.getUniformLocation("uSpecularMapSampler"),g=0;g<this.texturesO3D.length;g++)l.push(this.loadImage(t,this.texturesO3D[g],this.isSkybox));if(this.useNormalMap)for(this.texturesO3D=Array.isArray(e.normalMap)?e.normalMap:[e.normalMap],i.normalMapUniform=i.getUniformLocation("uNormalMapSampler"),g=0;g<this.texturesO3D.length;g++)d.push(this.loadImage(t,this.texturesO3D[g],this.isSkybox));for(var A=[],w=0;w<r[0][2].length/r[0][1];w++)for(g=0;g<r.length;g++)o=r[g],this.pushData(A,o[2],w,o[1]);if(s=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,new Float32Array(A),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),a=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),h=this.indices.length,t.ext){for(c=t.ext.createVertexArrayOES(),t.ext.bindVertexArrayOES(c),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.bindBuffer(t.ARRAY_BUFFER,s),g=0;g<r.length;g++)o=r[g],this.setupAttribPointer(t,o[3],o[1],m,o[4]),x+=4*o[1];t.bindBuffer(t.ARRAY_BUFFER,null),t.ext.bindVertexArrayOES(null)}},this.update=function(){y&&(y=x(y,u)),f&&(f=x(f,l)),p&&(p=x(p,d))};var x=function(t,e){if(t){var i=!0;for(g=0;g<e.length;g++)if(!e[g].loaded){i=!1;break}t=!i}return t};this.render=function(){if(!(y||f||p)){if(this.useTransparency&&(t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA)),i.initShaders(),this.useTexture&&this.activateTextures(t,i.samplerUniform,u),this.useSpecularMap){for(g=0;g<l.length;g++)t.activeTexture(t.TEXTURE0+u.length+g),t.bindTexture(t.TEXTURE_2D,l[g]);t.uniform1i(i.specularMapUniform,1)}if(this.useNormalMap){for(g=0;g<d.length;g++)t.activeTexture(t.TEXTURE0+u.length+g),t.bindTexture(t.TEXTURE_2D,d[g]);t.uniform1i(i.normalMapUniform,1)}for(g=0;g<n.length;g++){var e=n[g];if(e[4][1]=e[3],e[2])for(var x=0;x<e[3].length;x++)e[4][x+1]=e[2][e[3][x]]}for(g=0;g<n.length;g++)if("uniform1f"===n[g][1])t.uniform1f(n[g][4][0],n[g][4][1]);else if("uniform1fv"===n[g][1])t.uniform1fv(n[g][4][0],n[g][4][1]);else if("uniform1i"===n[g][1])t.uniform1i(n[g][4][0],n[g][4][1]);else if("uniform1iv"===n[g][1])t.uniform1iv(n[g][4][0],n[g][4][1]);else if("uniform2f"===n[g][1])t.uniform2f(n[g][4][0],n[g][4][1],n[g][4][2]);else if("uniform2fv"===n[g][1])t.uniform2fv(n[g][4][0],n[g][4][1]);else if("uniform2i"===n[g][1])t.uniform2i(n[g][4][0],n[g][4][1],n[g][4][2]);else if("uniform2iv"===n[g][1])t.uniform2iv(n[g][4][0],n[g][4][1]);else if("uniform3f"===n[g][1])t.uniform3f(n[g][4][0],n[g][4][1],n[g][4][2],n[g][4][3]);else if("uniform3fv"===n[g][1])t.uniform3fv(n[g][4][0],n[g][4][1]);else if("uniform3i"===n[g][1])t.uniform3i(n[g][4][0],n[g][4][1],n[g][4][2],n[g][4][3]);else if("uniform3iv"===n[g][1])t.uniform3iv(n[g][4][0],n[g][4][1]);else if("uniform4f"===n[g][1])t.uniform4f(n[g][4][0],n[g][4][1],n[g][4][2],n[g][4][3],n[g][4][4]);else if("uniform4fv"===n[g][1])t.uniform4fv(n[g][4][0],n[g][4][1]);else if("uniform4i"===n[g][1])t.uniform4i(n[g][4][0],n[g][4][1],n[g][4][2],n[g][4][3],n[g][4][4]);else if("uniform4iv"===n[g][1])t.uniform4iv(n[g][4][0],n[g][4][1]);else if("uniformMatrix2fv"===n[g][1])t.uniformMatrix2fv(n[g][4][0],n[g][4][1],n[g][4][2]);else if("uniformMatrix3fv"===n[g][1])t.uniformMatrix3fv(n[g][4][0],n[g][4][1],n[g][4][2]);else{if("uniformMatrix4fv"!==n[g][1])throw"Unkown: "+n[g][1];t.uniformMatrix4fv(n[g][4][0],n[g][4][1],n[g][4][2])}if(t.ext)t.ext.bindVertexArrayOES(c),t.drawElements(o,h,t.UNSIGNED_SHORT,0),t.ext.bindVertexArrayOES(null);else{for(t.bindBuffer(t.ARRAY_BUFFER,s),g=0;g<r.length;g++){var v=r[g];this.setupAttribPointer(t,v[3],v[1],m,v[4])}t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.drawElements(o,h,t.UNSIGNED_SHORT,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}this.useTransparency&&t.disable(t.BLEND)}},this.dispose=function(){t.deleteBuffer(a),t.deleteBuffer(s)},this.getTextureData=function(){return{textures:u,specularMaps:l,normalMaps:d}}},Ayce.Buffer.prototype={pushData:function(t,e,i,r){var n;for(n=0;n<r;n++)t.push(e[i*r+n])},setupAttribPointer:function(t,e,i,r,n){t.enableVertexAttribArray(e),t.vertexAttribPointer(e,i,t.FLOAT,!1,r,n)},loadedTextures:{},loadImage:function(t,e,i){var r=this,n=t.createTexture();n.loaded=!1;var o=t.REPEAT;return(i||e.clamp)&&(o=t.CLAMP_TO_EDGE),e=e.source?e.source:e,this.loadedTextures[e]?(n.loaded=!0,this.loadedTextures[e]):(n.image=new Image,n.image.src=e,n.image.onload=function(){r.loadTexture(t,n,n.image,o),n.loaded=!0},this.loadedTextures[e]=n,n)},loadTexture:function(t,e,i,r){r=r||t.REPEAT,t.bindTexture(t.TEXTURE_2D,e),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,r),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)},activateTextures:function(t,e,i){for(var r=[],n=0;n<i.length;n++)t.activeTexture(t.TEXTURE0+n),t.bindTexture(t.TEXTURE_2D,i[n]),r.push(n);t.uniform1iv(e,r)}},Ayce.BufferMulti=function(t,e,i){if(!e instanceof Ayce.Object3D)throw"Can't create buffers for "+e;var r=new Ayce.Matrix4;r.transposeUniform=!1;var n=new Ayce.Matrix4,o=new Ayce.Matrix4,a=new Ayce.Matrix3,s=new Ayce.Matrix3,h=null,c=null,u=3,l=3,d=2,y=1,f=4,p=Boolean(e.normals)&&i.lightsCount>0,g=Boolean(e.normals)&&(p||e.shader),m=Array.isArray(e.imageSrc)?e.imageSrc.length:1,x=e.isWireframe;this.transparent=e.transparent;var v=Boolean(e.geometries&&e.velocities&&e.rotationAngles&&e.lifetimes&&e.gravities&&e.gravityExps),A=[];A.push(["aVertexPosition",u,e.vertices]),e.textureCoords&&e.imageSrc&&A.push(["aTextureCoord",d,e.textureCoords]),e.textureCoords&&e.imageSrc&&e.textureIndices&&m>1&&A.push(["aTextureIndex",y,e.textureIndices]),e.colors&&A.push(["aVertexColor",f,e.colors]),g&&A.push(["aVertexNormal",l,e.normals]),e.shaderAttributes&&Array.prototype.push.apply(A,e.shaderAttributes);var w={transposeUniform:!1,data:[]},M={time:0,startTime:Date.now()},R={useTexture:Boolean(e.textureCoords&&e.imageSrc),useLighting:p,useMultiTex:Boolean(e.textureIndices),normalMatrix:new Ayce.Matrix3,useSpecularMap:Boolean(e.specularMap),useNormalMap:Boolean(e.normalMap)},b=[];b.push(["uPMatrix","uniformMatrix4fv",w,["transposeUniform","data"]]),b.push(["uMVMatrix","uniformMatrix4fv",r,["transposeUniform","data"]]),g&&(R.normalMatrix.transposeUniform=!1,b.push(["uNMatrix","uniformMatrix3fv",R.normalMatrix,["transposeUniform","data"]])),p&&(b.push(["uAmbientColor","uniform3f",i.ambientLight,["red","green","blue"]]),b.push(["uPointLightingLocations","uniform3fv",i,["locationsArray"]]),b.push(["uPointLightingColors","uniform3fv",i,["colorsArray"]]),b.push(["uSpecularColors","uniform3fv",i,["specColorsArray"]]),b.push(["uShininess","uniform1f",e,["shininess"]])),v&&b.push(["uTime","uniform1f",M,["time"]]),e.shaderUniforms&&Array.prototype.push.apply(b,e.shaderUniforms);var S=null,V=null,C="";if(e.shader)S=Ayce.XMLLoader.getSourceSynch(e.shader+".vert"),V=Ayce.XMLLoader.getSourceSynch(e.shader+".frag"),C="A"+e.shader,e.logVertexShader&&console.log(S),e.logFragmentShader&&console.log(V);else{var T=new Ayce.ShaderGenerator;p&&(T.useVertexLighting=Boolean(e.normals&&!e.useFragmentLighting),T.lightsCount=i.lightsCount,T.useFragmentLighting=Boolean(e.normals&&e.useFragmentLighting),T.useSpecularLighting=e.useSpecularLighting),T.useNormals=g,T.useColor=Boolean(e.colors),T.texturesCount=Array.isArray(e.imageSrc)?e.imageSrc.length:1,T.useTexture=Boolean(e.imageSrc&&e.textureCoords),T.useSpecularMap=Boolean(e.specularMap&&e.useSpecularLighting),T.useNormalMap=Boolean(e.normalMap),T.isParticleSystem=v,T.init(),S=T.vertexShader,V=T.fragmentShader,C="B"+T.useNormals+T.lightsCount+T.texturesCount+T.useVertexLighting+T.useFragmentLighting+T.useTexture+T.useColor+T.useSpecularMap+T.useNormalMap+T.isParticleSystem,e.logVertexShader&&console.log(S.replace(/;/g,";\n").replace(/{/g,"{\n").replace(/}/g,"}\n")),e.logFragmentShader&&console.log(V.replace(/;/g,";\n").replace(/{/g,"{\n").replace(/}/g,"}\n"))}var E=null;t.shaders[C]?E=t.shaders[C]:(E=new Ayce.Shader(t,S,V),t.shaders[C]=E);var P=x?t.LINES:void 0,z=new Ayce.Buffer(t,e,E,A,b,P);if(e.twoFaceTransparency){var D=e.indices;D=D.slice().reverse().concat(D),z.indices=new Uint16Array(D)}else z.indices=new Uint16Array(e.indices);z.useTexture=Boolean(e.textureCoords&&e.imageSrc),z.useSpecularMap=Boolean(e.textureCoords&&e.specularMap),z.useNormalMap=Boolean(e.textureCoords&&e.normalMap),z.useTransparency=e.transparent,z.texturesO3D=Array.isArray(e.imageSrc)?e.imageSrc:[e.imageSrc],z.isSkybox=Boolean(e.isSkybox),z.init();var L=new Ayce.Matrix4;this.update=function(t){Ayce.Matrix4.prototype.copyToMatrix(e.modelMatrix,r),r.apply(t.getViewMatrix()),Ayce.Matrix4.prototype.copyToMatrix(r,L),L.invert(),L.transpose(),L.getMatrix3(R.normalMatrix),w.data=t.getPerspectiveMatrix().data,M=Date.now()-M.startTime,z.update()},this.render=function(){e.visible&&z.render()},this.updateVR=function(t){Ayce.Matrix4.prototype.copyToMatrix(e.modelMatrix,n),n.apply(t.getViewMatrix("left")),Ayce.Matrix4.prototype.copyToMatrix(n,L),L.invert(),L.transpose(),L.getMatrix3(a),Ayce.Matrix4.prototype.copyToMatrix(e.modelMatrix,o),o.apply(t.getViewMatrix("right")),Ayce.Matrix4.prototype.copyToMatrix(o,L),L.invert(),L.transpose(),L.getMatrix3(s),h=t.getPerspectiveMatrix("left"),c=t.getPerspectiveMatrix("right"),z.update()},this.renderVR=function(t){e.visible&&("left"===t?(r.data=n.data,R.normalMatrix.data=a.data,w.data=h.data,i.locationsArray=i.locationsArrayLeftEye):"right"===t&&(r.data=o.data,R.normalMatrix.data=s.data,w.data=c.data,i.locationsArray=i.locationsArrayRightEye),z.render())},this.dispose=function(){z.dispose()},this.updateTexture=function(e,i){Ayce.Buffer.prototype.loadTexture(t,e,i)},this.getTextureData=function(){return z.getTextureData()}},Ayce.BufferMulti.prototype={},Ayce.Shader=function(t,e,i){var r=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))return alert("ShaderVert: \n"+t.getShaderInfoLog(r)),null;var n=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(n,i),t.compileShader(n),!t.getShaderParameter(r,t.COMPILE_STATUS))return alert("ShaderFrag: \n"+t.getShaderInfoLog(n)),null;var o=t.createProgram();t.attachShader(o,r),t.attachShader(o,n),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)||alert("Could not initialise shaders"),t.validateProgram(o),this.initShaders=function(){o!==Ayce.Shader.prototype.currentShader&&(t.useProgram(o),Ayce.Shader.prototype.currentShader=o)},this.getAttribLocation=function(e){return t.getAttribLocation(o,e)},this.getUniformLocation=function(e){return t.getUniformLocation(o,e)}},Ayce.Shader.prototype={currentShader:null},Ayce.ShaderGenerator=function(){this.lightsCount=2,this.texturesCount=1,this.useNormals=!1,this.useVertexLighting=!1,this.useFragmentLighting=!1,this.useSpecularLighting=!1,this.useTexture=!1,this.useColor=!1,this.useSpecularMap=!1,this.useNormalMap=!1,this.isParticleSystem=!1;var t=!1;this.vertexShader="",this.fragmentShader="",this.init=function(){this.useTexture||(this.useSpecularMap=!1,this.useNormalMap=!1),t=Boolean(this.texturesCount>1),this.vertexShader+="attribute vec3 aVertexPosition;",this.useColor&&(this.vertexShader+="attribute vec4 aVertexColor;"),this.useTexture&&(this.vertexShader+="attribute vec2 aTextureCoord;"),this.useNormals&&(this.vertexShader+="attribute vec3 aVertexNormal;"),this.isParticleSystem&&(this.vertexShader+="attribute vec3 aGeometryPosition;attribute vec3 aVertexVelocity;attribute vec3 aVertexRotation;attribute float aLifetime;attribute float aGravity;attribute float aGravityExponent;"),this.useTexture&&t&&(this.vertexShader+="attribute float aTextureIndex;"),this.vertexShader+="uniform mat4 uMVMatrix;uniform mat4 uPMatrix;",this.isParticleSystem&&(this.vertexShader+="uniform float uTime;"),this.useNormals&&(this.vertexShader+="uniform mat3 uNMatrix;"),this.useVertexLighting&&(this.vertexShader+="uniform vec3 uAmbientColor;uniform vec3 uPointLightingLocations["+this.lightsCount+"];uniform vec3 uPointLightingColors["+this.lightsCount+"];const int cLightCount = "+this.lightsCount+";",this.useSpecularLighting&&(this.vertexShader+="uniform float uShininess;"),this.useSpecularLighting&&(this.vertexShader+="uniform vec3 uSpecularColors["+this.lightsCount+"];")),this.useColor&&(this.vertexShader+="varying vec4 vColor;"),this.useTexture&&(this.vertexShader+="varying vec2 vTextureCoord;"),this.useVertexLighting?this.vertexShader+="varying vec3 vLightWeighting;":this.useFragmentLighting&&(this.vertexShader+="varying vec3 vTransformedNormal;varying vec4 vPosition;"),this.useTexture&&t&&(this.vertexShader+="varying float vTextureIndex;"),this.vertexShader+="void main(void) {",this.isParticleSystem?this.vertexShader+="float factor;if(aLifetime==0.0){factor = uTime;}else{factor = mod(uTime, aLifetime);}vec3 distance = aGeometryPosition - aVertexPosition;float xAngle = aVertexRotation.x*factor;float yAngle = aVertexRotation.y*factor;float zAngle = aVertexRotation.z*factor;mat4 xRotation = mat4(1.0,\t \t\t 0.0,\t\t\t 0.0,\t\t\t 0.0,0.0,\t\t\t cos(xAngle),\t sin(xAngle),\t 0.0,0.0,\t\t\t-sin(xAngle),\t cos(xAngle),\t 0.0,0.0,\t \t\t 0.0,\t\t\t 0.0,\t\t\t 1.0);mat4 yRotation = mat4(cos(yAngle),\t 0.0,\t\t\t-sin(yAngle),\t 0.0,0.0,\t\t\t 1.0,\t \t\t 0.0,\t\t\t 0.0,sin(yAngle),\t 0.0,\t \t\t cos(yAngle),\t 0.0,0.0,\t\t\t 0.0,\t \t\t 0.0,\t\t\t 1.0);mat4 zRotation = mat4(cos(zAngle),\t sin(zAngle),\t 0.0,\t\t\t 0.0,-sin(zAngle),\t cos(zAngle),\t 0.0,\t\t\t 0.0,0.0,\t\t\t 0.0,\t\t\t 1.0,\t\t\t 0.0,0.0,\t\t\t 0.0,\t\t\t 0.0,\t\t\t 1.0);vec4 position = vec4(aGeometryPosition, 1.0)*xRotation*yRotation*zRotation;position = position-vec4(distance, 0.0);vec3 velocity = aVertexVelocity+vec3(0.0, aGravity*pow(factor, aGravityExponent),0.0);position = uMVMatrix * vec4(position.xyz+velocity*factor, 1.0);":this.useFragmentLighting?this.useFragmentLighting&&(this.vertexShader+="vPosition = uMVMatrix * vec4(aVertexPosition, 1.0);vec4 position = vPosition;"):this.vertexShader+="vec4 position = uMVMatrix * vec4(aVertexPosition, 1.0);",this.vertexShader+="gl_Position = uPMatrix * position;",this.useTexture&&t&&(this.vertexShader+="vTextureIndex = aTextureIndex;"),this.useTexture&&(this.vertexShader+="vTextureCoord = aTextureCoord;"),this.useColor&&(this.vertexShader+="vColor = aVertexColor;"),this.useVertexLighting?(this.vertexShader+="vLightWeighting = uAmbientColor;",this.isParticleSystem?this.vertexShader+="vec3 transformedNormal = uNMatrix * (vec4(aVertexNormal, 1.0) * xRotation * yRotation * zRotation).xyz;":this.vertexShader+="vec3 transformedNormal = uNMatrix * aVertexNormal;",this.vertexShader+="vec3 normal = normalize(transformedNormal);vec3 eyeDirection = normalize(-position.xyz);"+this.getVertexLightingWeightCalcArrayVertex(this.lightsCount,this.useSpecularLighting)):this.useFragmentLighting&&(this.isParticleSystem?this.vertexShader+="vTransformedNormal = uNMatrix * (vec4(aVertexNormal, 1.0) * xRotation * yRotation * zRotation).xyz;":this.vertexShader+="vTransformedNormal = uNMatrix * aVertexNormal;"),this.vertexShader+="}",this.fragmentShader+="precision mediump float;",this.useVertexLighting?this.fragmentShader+="varying vec3 vLightWeighting;":this.useFragmentLighting&&(this.fragmentShader+="varying vec3 vTransformedNormal;varying vec4 vPosition;uniform vec3 uAmbientColor;uniform vec3 uPointLightingLocations["+this.lightsCount+"];uniform vec3 uPointLightingColors["+this.lightsCount+"];const int cLightCount = "+this.lightsCount+";",this.useSpecularLighting&&(this.fragmentShader+="uniform float uShininess;"),this.useSpecularLighting&&(this.fragmentShader+="uniform vec3 uSpecularColors["+this.lightsCount+"];")),this.useColor&&(this.fragmentShader+="varying vec4 vColor;"),this.useTexture&&(this.fragmentShader+="varying vec2 vTextureCoord;",t?this.fragmentShader+="varying float vTextureIndex;uniform sampler2D uSampler["+this.texturesCount+"];":this.fragmentShader+="uniform sampler2D uSampler;"),this.useSpecularMap&&(this.fragmentShader+="uniform sampler2D uSpecularMapSampler;"),this.useNormalMap&&(this.fragmentShader+="uniform sampler2D uNormalMapSampler;"),this.fragmentShader+="void main(void) {vec4 fragmentColor;",this.useFragmentLighting&&(this.fragmentShader+="vec3 lightWeighting = uAmbientColor;vec3 normal = normalize(vTransformedNormal);vec3 eyeDirection = normalize(-vPosition.xyz);"+this.getFragmentLightingWeightCalcArrayVertex(this.lightsCount,this.useSpecularMap,this.useNormalMap,this.useSpecularLighting)),this.useTexture&&t?(this.fragmentShader+="if (vTextureCoord.x > -0.5 && vTextureCoord.y > -0.5) {vec4 tex = vec4(0.0);float i = vTextureIndex;"+this.getTextureCalcArray(this.texturesCount)+"fragmentColor = tex;} else {",this.useColor?this.fragmentShader+="fragmentColor = vColor;":this.fragmentShader+="fragmentColor = vec4(0.5, 0.5, 0.5, 1.0);",this.fragmentShader+="}"):this.useTexture?this.fragmentShader+="fragmentColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));":this.useColor?this.fragmentShader+="fragmentColor = vColor;":this.fragmentShader+="fragmentColor = vec4(0.5, 0.5, 0.5, 1.0);",this.useVertexLighting?this.fragmentShader+="gl_FragColor = vec4(fragmentColor.rgb * vLightWeighting, fragmentColor.a);":this.useFragmentLighting?this.fragmentShader+="gl_FragColor = vec4(fragmentColor.rgb * lightWeighting, fragmentColor.a);":this.fragmentShader+="gl_FragColor = fragmentColor;",this.fragmentShader+="}"}},Ayce.ShaderGenerator.prototype={getVertexLightingWeightCalcArrayVertex:function(t,e){var i="";return i+="for(int i = 0; i < cLightCount; i++){vec3 lightDirection = normalize(uPointLightingLocations[i] - position.xyz);vec3 reflectionDirection = reflect(-lightDirection, normal);float diffuseLightWeighting = max(dot(normalize(transformedNormal), lightDirection), 0.0);",i+=e?"float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uShininess);vLightWeighting += uPointLightingColors[i] * diffuseLightWeighting + uSpecularColors[i] * specularLightWeighting;":"vLightWeighting += uPointLightingColors[i] * diffuseLightWeighting;",i+="}"},getFragmentLightingWeightCalcArrayVertex:function(t,e,i,r){var n="";return n+="for(int i = 0; i < cLightCount; i++){vec3 lightDirection = normalize(uPointLightingLocations[i] - vPosition.xyz);vec3 reflectionDirection = reflect(-lightDirection, normal);",e?n+="float shininess = texture2D(uSpecularMapSampler, 255.0-vec2(vTextureCoord.s, vTextureCoord.t)).r * 255.0 * uShininess;float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), shininess);":r&&(n+="float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uShininess);"),n+=i?"vec3 normalMap = texture2D(uNormalMapSampler, vec2(vTextureCoord.s, vTextureCoord.t)).rgb*2.0-1.0;float diffuseLightWeighting = max(dot(normalize(normalMap), lightDirection), 0.0);":"float diffuseLightWeighting = max(dot(normalize(vTransformedNormal), lightDirection), 0.0);",n+=r?"lightWeighting += uPointLightingColors[i] * diffuseLightWeighting + uSpecularColors[i] * specularLightWeighting;":"lightWeighting += uPointLightingColors[i] * diffuseLightWeighting;",n+="}"},getTextureCalcArray:function(t){for(var e="",i=0;i<t;i++)0!==i&&(e+="else "),e+="if(i-"+i+".0 < 0.01){tex = texture2D(uSampler["+i+"], vec2(vTextureCoord.s, vTextureCoord.t));}";return e}},Ayce.Sound=function(t){var e=this;this.soundLoaded=!1,this.position=new Ayce.Vector3(0,0,0),this.orientationFront=new Ayce.Vector3(0,0,0),this.orientationUp=new Ayce.Vector3(0,1,0),this.listenerPosition=new Ayce.Vector3(0,0,0),this.listenerOrientationFront=new Ayce.Vector3(0,0,0),
this.listenerOrientationUp=new Ayce.Vector3(0,1,0),this.loop=!0,this.is3D=!0,this.volume=1,this.isPlaying=!1;var i,r,n,o,a,s,h=0;this.init=function(r){i=r.audioContext;var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){i.decodeAudioData(this.response,function(t){o=t,e.soundLoaded=!0},function(){alert("Decoding the audio buffer failed")})},n.send()},this.update=function(){e.soundLoaded&&e.isPlaying&&(e.is3D&&(r.setPosition(e.position.x,e.position.y,e.position.z),r.panningModel="HRTF",r.distanceModel="linear",i.listener.setOrientation(-e.listenerOrientationFront.x,-e.listenerOrientationFront.y,e.listenerOrientationFront.z,e.listenerOrientationUp.x,e.listenerOrientationUp.y,-e.listenerOrientationUp.z),i.listener.setPosition(-e.listenerPosition.x,-e.listenerPosition.y,-e.listenerPosition.z)),a.gain.value=this.volume,n.loop=this.loop)},this.play=function(){e.soundLoaded?(n=i.createBufferSource(),n.buffer=o,a=i.createGain(),this.is3D?(r=i.createPanner(),n.connect(r),r.connect(a),r.panningModel="HRTF",r.distanceModel="linear"):n.connect(a),a.connect(i.destination),e.update(),n.start(h),s=Date.now(),this.isPlaying=!0):console.error("The audio file is not done loading.")},this.pause=function(){e.soundLoaded?(n.stop(),this.isPlaying=!1,h=(Date.now()-s)%Math.floor(1e3*o.duration)/1e3):console.error("The audio file is not done loading.")},this.stop=function(){e.soundLoaded?(n.stop(),this.isPlaying=!1,h=0):console.error("The audio file is not done loading.")}},Ayce.AudioContext=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext||null,window.AudioContext?this.audioContext=new AudioContext:(this.audioContext={},console.error("AudioContext is not supported by your browser"))},Ayce.Camera=function(t){var e=this;this.useVR=!1;var i=!1,r=new Ayce.Vector3,n=new Ayce.Quaternion,o=new Ayce.Matrix4,a=new Ayce.Matrix4,s=new Ayce.Matrix4,h=new Ayce.Matrix4,c=null,u=null,l=null;this.fieldOfView=60,this.nearPlane=.1,this.farPlane=200,this.width=1,this.height=1,this.isOrtho=!1;var d=new Ayce.Vector3;this.update=function(){t.update(),r=t.getGlobalPosition(),n=t.getGlobalRotation().getConjugate(),y()},this.updateProjectionMatrix=function(){var e=this.width/this.height;t&&t.isInputVR()&&t.cameraProperties.eyeFOVL?(u=Ayce.Matrix4.makeVRPerspective(t.cameraProperties.eyeFOVL,this.nearPlane,this.farPlane),l=Ayce.Matrix4.makeVRPerspective(t.cameraProperties.eyeFOVR,this.nearPlane,this.farPlane)):c=this.isOrtho?Ayce.Matrix4.makeOrthoPerspective(-1,1,1,-1,.5,1.5):Ayce.Matrix4.makePerspective(this.fieldOfView,e,this.nearPlane,this.farPlane)},this.setFullscreen=function(t,e){if(i!==t)return i=t,t?void(e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()):void(document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen())};var y=function(){if(e.useVR){var i=t.cameraProperties.eyeTranslationL,c=t.cameraProperties.eyeTranslationR;s.identity(),s.applyTranslation(-r.x,-r.y,-r.z),n.toRotationMatrix(o),s.apply(o),s.applyTranslation(-i,0,0),h.identity(),h.applyTranslation(-r.x,-r.y,-r.z),n.toRotationMatrix(o),h.apply(o),h.applyTranslation(-c,0,0)}else a.identity(),a.applyTranslation(-r.x,-r.y,-r.z),n.toRotationMatrix(o),a.apply(o)};this.getManager=function(){return t},this.getViewMatrix=function(t){return"left"===t?s:"right"===t?h:a},this.getPerspectiveMatrix=function(t){return"left"===t&&null!==u?u:"right"===t&&null!==l?l:c},this.getEyeTranslation=function(e){return"left"===e?t.cameraProperties.eyeTranslationL:"right"===e?t.cameraProperties.eyeTranslationR:null},this.getForwardVector=function(){return e.useVR?(d.x=-s.data[2],d.y=-s.data[6],d.z=-s.data[10],d):(d.x=-a.data[2],d.y=-a.data[6],d.z=-a.data[10],d)},this.isFullscreen=function(){return i}},Ayce.Camera.prototype={},Ayce.CameraManager=function(){var t=this,e=new Ayce.Vector3,i=new Ayce.Quaternion;this.cameraProperties={eyeTranslationL:-.03,eyeTranslationR:.03,eyeFOVR:90,eyeFOVL:null,renderRectWidth:null,renderRectHeight:null},this.modifiers=[],this.initHMDControls=function(){t.cameraProperties.eyeTranslationL=Ayce.HMDHandler.getEyeTranslationL(),t.cameraProperties.eyeTranslationR=Ayce.HMDHandler.getEyeTranslationR(),t.cameraProperties.eyeFOVL=Ayce.HMDHandler.getEyeFOVL(),t.cameraProperties.eyeFOVR=Ayce.HMDHandler.getEyeFOVR(),t.cameraProperties.renderRectWidth=Ayce.HMDHandler.getEyeWidthR()+Ayce.HMDHandler.getEyeWidthL(),t.cameraProperties.renderRectHeight=Math.max(Ayce.HMDHandler.getEyeHeightR(),Ayce.HMDHandler.getEyeHeightL())},this.update=function(){var t;for(t=0;t<this.modifiers.length;t++)this.modifiers[t].update(this.getGlobalRotation().getConjugate());for(e.nullVector(),i.reset(),t=0;t<this.modifiers.length;t++){i.multiply(i,this.modifiers[t].getOrientation());var r=this.modifiers[t].getPosition();e.add(r.x,r.y,r.z)}},this.getGlobalPosition=function(){return e},this.getGlobalRotation=function(){return i},this.clearModifiers=function(){this.modifiers=[]},this.isInputVR=function(){for(var t=0;t<this.modifiers.length;t++)if(this.modifiers[t]instanceof Ayce.WebVR)return!0;return!1}},Ayce.CameraManager.prototype={},Ayce.CameraModifier=function(){this.position=new Ayce.Vector3,this.orientation=new Ayce.Quaternion,this.update=function(){},this.getOrientation=function(){return this.orientation},this.getPosition=function(){return this.position}},Ayce.Cardboard=function(){Ayce.CameraModifier.call(this);var t=new Ayce.Quaternion,e=function(t){return t*Math.PI/180};this.update=function(){var i=e(-Ayce.SensorsHandler.getRoll()+180),r=e(-Ayce.SensorsHandler.getPitch()),n=e(Ayce.SensorsHandler.getYaw()+90),o=Math.cos(i/2),a=Math.cos(r/2),s=Math.cos(n/2),h=Math.sin(i/2),c=Math.sin(r/2),u=Math.sin(n/2);t.x=h*c*s+o*a*u,t.y=h*a*s+o*c*u,t.z=-(o*c*s-h*a*u),t.w=o*a*s-h*c*u},this.getOrientation=function(){return t}},Ayce.Cardboard.prototype=new Ayce.CameraModifier,Ayce.WebVR=function(){var t=new Ayce.Vector3,e=new Ayce.Quaternion;this.update=function(i){Ayce.HMDHandler.update(),Ayce.KeyboardHandler.isKeyDown("R")&&Ayce.HMDHandler.resetSensor();var r=Ayce.HMDHandler.getPosition(),n=Ayce.HMDHandler.getRotation();e=n.getConjugate(),t=n.multiply(i,e).rotatePoint(r)},this.getPosition=function(){return t},this.getOrientation=function(){return e}},Ayce.WebVR.prototype=new Ayce.CameraModifier,Ayce.MouseKeyboard=function(t,e){var i=.2,r=new Ayce.Vector3,n=new Ayce.Quaternion;t.requestPointerLock=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock,document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock;var o=new Ayce.Vector3,a=Date.now(),s=new Ayce.Quaternion,h=new Ayce.Quaternion,c=new Ayce.Vector3(1,0,0),u=new Ayce.Vector3(0,1,0),l=new Ayce.Vector2(0,0),d=0,y=0;this.update=function(t){Ayce.MouseHandler.setNewFrameTrue();var e=(Date.now()-a)/1e3,f=5,p=null;o.x=0,o.y=0,o.z=0,Ayce.KeyboardHandler.isKeyDown("W")&&(p=o.add(0,0,-1)),Ayce.KeyboardHandler.isKeyDown("S")&&(p=o.add(0,0,1)),Ayce.KeyboardHandler.isKeyDown("D")&&(p=o.add(1,0,0)),Ayce.KeyboardHandler.isKeyDown("A")&&(p=o.add(-1,0,0)),p&&(p=t.getRotatedPoint(p),r.add(p.x*f*e,p.y*f*e,p.z*f*e)),a=Date.now(),l=Ayce.MouseHandler.getMovement(),d+=l.x,y+=l.y,y*i>90?y=90/i:y*i<-90&&(y=-90/i),h.reset(),h.fromAxisAngle(u,d*i*Math.PI/180),s.reset(),s.fromAxisAngle(c,y*i*Math.PI/180),s.multiply(s,h),n=s},this.getPosition=function(){return r},this.getOrientation=function(){return n},e.onclick=function(){t.requestPointerLock()},this.isMouseLocked=function(){return document.pointerLockElement===t||document.mozPointerLockElement===t||document.webkitPointerLockElement===t}},Ayce.MouseKeyboard.prototype=new Ayce.CameraModifier,Ayce.Gamepad=function(){var t=this;this.gamepads=[];var e,i=0,r=0,n=.3,o=6,a=3,s=new Ayce.Vector3,h=new Ayce.Vector3;this.getPosition=function(i){var r=.02;for(h.nullVector(),t.gamepads=Ayce.GamepadHandler.getGamepads(),e=0;e<t.gamepads.length;e++)if(t.gamepads[e]){var a=0,c=0;(t.gamepads[e].axes[0]>n||t.gamepads[e].axes[0]<-n)&&(a=t.gamepads[e].axes[0]*o),(t.gamepads[e].axes[1]>n||t.gamepads[e].axes[1]<-n)&&(c=t.gamepads[e].axes[1]*o),h.add(a,0,c)}return h=i.getConjugate().getRotatedPoint(h),s.add(h.x*r,h.y*r,h.z*r),s};var c=new Ayce.Quaternion,u=new Ayce.Quaternion,l=new Ayce.Vector3(1,0,0),d=new Ayce.Vector3(0,1,0);this.getOrientation=function(){for(c.reset(),t.gamepads=Ayce.GamepadHandler.getGamepads(),e=0;e<t.gamepads.length;e++)t.gamepads[e]&&((t.gamepads[e].axes[2]>n||t.gamepads[e].axes[2]<-n)&&(i+=t.gamepads[e].axes[2]*a),(t.gamepads[e].axes[3]>n||t.gamepads[e].axes[3]<-n)&&(r+=t.gamepads[e].axes[3]*a),u.reset(),u.fromAxisAngle(d,i*Math.PI/180),c.reset(),c.fromAxisAngle(l,r*Math.PI/180),c.multiply(c,u));return c}},Ayce.Gamepad.prototype=new Ayce.CameraModifier,Ayce.Object3D=function(){var t=this;this.position=new Ayce.Vector3,this.rotation=new Ayce.Quaternion;var e=new Ayce.Vector3,i=new Ayce.Quaternion,r=new Ayce.Matrix4;this.scale=new Ayce.Vector3(1,1,1),this.modelMatrix=new Ayce.Matrix4,this.parent=null,this.parentPositionWeight=new Ayce.Vector3(1,1,1),this.parentRotationWeight=new Ayce.Vector3(1,1,1),this.vertices=null,this.normals=null,this.textureCoords=null,this.textureIndices=null,this.colors=null,this.indices=null,this.transparent=!1,this.isWireframe=!1,this.twoFaceTransparency=!1,this.buffer=null,this.imageSrc=null,this.shader=null,this.shaderAttributes=null,this.shaderUniforms=null,this.useFragmentLighting=!1,this.specularMap=null,this.normalMap=null,this.useSpecularLighting=!1,this.shininess=1,this.soundFile=null,this.sound=null,this.isSkybox=!1,this.boundingBox=null,this.boundingSphere=null,this.gravity=null,this.velocity=new Ayce.Vector3,this.collision=!1,this.useBoundingSphere=!1,this.collideWith=null,this.onCollision=null;var n=Ayce.Timer.prototype.getCurrentTimeMs();this.onUpdate=null,this.renderPriority=null,this.visible=!0,this.logVertexShader=!1,this.logFragmentShader=!1,this.calcBoundingBox=function(){this.vertices||console.error("No Vertices set. Can't calc Bounding Box."),s();for(var t=this.vertices[0],r=this.vertices[0],n=this.vertices[1],o=this.vertices[1],a=this.vertices[2],h=this.vertices[2],c=0;c<this.vertices.length;c+=3){var u=this.vertices[c+0],l=this.vertices[c+1],d=this.vertices[c+2];u>r&&(r=u),u<t&&(t=u),l>o&&(o=l),l<n&&(n=l),d>h&&(h=d),d<a&&(a=d)}var y=r-t,f=o-n,p=h-a;this.boundingBox=new Ayce.Geometry.Box(y,f,p),this.boundingBox.position=e,this.boundingBox.offset=new Ayce.Vector3(t,n,a),this.boundingBox.rotation=i,this.boundingBox.scale=this.scale},this.calcBoundingSphere=function(){s();var t,r,n,o,a=this.scale,h=this.vertices[0]*a.x,c=this.vertices[0]*a.x,u=this.vertices[1]*a.y,l=this.vertices[1]*a.y,d=this.vertices[2]*a.z,y=this.vertices[2]*a.z;for(t=0;t<this.vertices.length;t+=3)r=this.vertices[t+0]*a.x,n=this.vertices[t+1]*a.y,o=this.vertices[t+2]*a.z,r>c&&(c=r),r<h&&(h=r),n>l&&(l=n),n<u&&(u=n),o>y&&(y=o),o<d&&(d=o);var f=new Ayce.Vector3((c+h)/2,(l+u)/2,(y+d)/2),p=0;for(t=0;t<this.vertices.length;t+=3){r=this.vertices[t+0]*this.scale.x,n=this.vertices[t+1]*this.scale.y,o=this.vertices[t+2]*this.scale.z;var g=Ayce.Vector3.prototype.distance(f,new Ayce.Vector3(r,n,o));g>p&&(p=g)}this.boundingSphere=new Ayce.Geometry.Sphere(p),this.boundingSphere.position=e,this.boundingSphere.offset=f,this.boundingSphere.rotation=i},this.update=function(){var t=Ayce.Timer.prototype.getCurrentTimeMs(),o=t-n,a=this.gravity,h=this.velocity;if((a||0!==h.x||0!==h.y||0!==h.z)&&o>0){var c=o/1e3;if(a&&((a.x>0&&h.x<a.x||a.x<0&&h.x>a.x)&&(h.x=h.x+a.x*c),(a.y>0&&h.y<a.y||a.y<0&&h.y>a.y)&&(h.y=h.y+a.y*c),(a.z>0&&h.z<a.z||a.z<0&&h.z>a.z)&&(h.z=h.z+a.z*c)),this.position.x+=h.x*c,this.position.y+=h.y*c,this.position.z+=h.z*c,s(),this.collision&&this.collideWith)for(var u=0;u<this.collideWith.length;u++){var l=this.collideWith[u],d=this.boundingSphere.position.x+this.boundingSphere.offset.x-(l.boundingSphere.position.x+l.boundingSphere.offset.x),y=this.boundingSphere.position.y+this.boundingSphere.offset.y-(l.boundingSphere.position.y+l.boundingSphere.offset.y),f=this.boundingSphere.position.z+this.boundingSphere.offset.z-(l.boundingSphere.position.z+l.boundingSphere.offset.z),p=Math.sqrt(d*d+y*y+f*f),g=this.boundingSphere.r+l.boundingSphere.r;if(!(p>1.3*g)){var m;if(m=l.useBoundingSphere&&this.useBoundingSphere?Ayce.Geometry.prototype.sphereSphereCollision(this.boundingSphere,l.boundingSphere):l.useBoundingSphere?Ayce.Geometry.prototype.boxSphereCollision(this.boundingBox,l.boundingSphere,!0):this.useBoundingSphere?Ayce.Geometry.prototype.boxSphereCollision(l.boundingBox,this.boundingSphere):Ayce.Geometry.prototype.boxBoxCollision(this.boundingBox,l.boundingBox),m&&(this.position.subtract(m.x,m.y,m.z),this.onCollision)){var x={collisionWith:l,collisionVector:m.negate()};this.onCollision(x)}}}}n=t,s(),this.modelMatrix.identity(),this.modelMatrix.applyScale(this.scale.x,this.scale.y,this.scale.z),i.toRotationMatrix(r),this.modelMatrix.apply(r),this.modelMatrix.applyTranslation(e.x,e.y,e.z),this.onUpdate&&this.onUpdate()};var o=new Ayce.Vector3,a=new Ayce.Quaternion,s=function(){if(t.parent){var r=t.parent.getGlobalRotation(),n=t.parentRotationWeight;i.x=r.x*n.x,i.y=r.y*n.y,i.z=r.z*n.z,i.w=r.w,Ayce.Quaternion.prototype.copyToQuaternion(i,a),i.getConjugate(a),i.normalize(),i.multiply(t.rotation,i);var s=t.parent.getGlobalPosition(),h=t.parentPositionWeight;o.x=t.position.x,o.y=t.position.y,o.z=t.position.z,a.rotatePoint(o),e.x=s.x*h.x+o.x,e.y=s.y*h.y+o.y,e.z=s.z*h.z+o.z}else Ayce.Vector3.prototype.copyToVector(t.position,e),Ayce.Quaternion.prototype.copyToQuaternion(t.rotation,i)};this.getGlobalPosition=function(){return e},this.getGlobalRotation=function(){return i}},Ayce.Object3D.prototype={addShaderAttribute:function(t,e,i){this.shaderAttributes||(this.shaderAttributes=[]),this.shaderAttributes.push([t,e,i])},addShaderUniform:function(t,e,i,r){this.shaderUniforms||(this.shaderUniforms=[]),this.shaderUniforms.push([t,e,i,r])}},Ayce.OBJLoader=function(t){for(var e=/(.*[\/|\\])(.*)/,i=e.exec(t)[1],r=e.exec(t)[2],n=Ayce.XMLLoader.getSourceSynch(i+r),o=this.getMtlName(n),a=Ayce.XMLLoader.getSourceSynch(i+o),s=this.readObj(n),h=o?this.readMtl(a):null,c=[],u=0;u<s.length;u++){var l=this.createO3DFromOBJ(s[u],h,i),d=s[u].name;c.push(l),c[d]=l}return c},Ayce.OBJLoader.prototype={readObj:function(t){var e=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,i=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,r=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,n=/f( +-?\d+)( +-?\d+)( +-?\d+)( +-?\d+)?/,o=/f( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))?/,a=/f( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))?/,s=/f( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))?/,h=[],c={};c.name="",c.vertices=[],c.normals=[],c.uvs=[],c.faces=[];for(var u,l=function(t,e,i){if(void 0!==t[3])throw"obj quad rendering not supported";for(var r=[],n=0;n<3;n++){var o=t[n],a=e?e[n]:void 0,s=i?i[n]:void 0;r.push([o,a,s])}r.push(u),c.faces.push(r)},d=t.split("\n"),y=0;y<d.length;y++){var f=d[y];f=f.trim();var p;0!==f.length&&"#"!==f.charAt(0)&&(null!==(p=e.exec(f))?c.vertices.push([parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3])]):null!==(p=i.exec(f))?c.normals.push([parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3])]):null!==(p=r.exec(f))?c.uvs.push([parseFloat(p[1]),parseFloat(p[2])]):null!==(p=n.exec(f))?l([p[1],p[2],p[3],p[4]]):null!==(p=o.exec(f))?l([p[2],p[5],p[8],p[11]],[p[3],p[6],p[9],p[12]]):null!==(p=a.exec(f))?l([p[2],p[6],p[10],p[14]],[p[3],p[7],p[11],p[15]],[p[4],p[8],p[12],p[16]]):null!==(p=s.exec(f))?l([p[2],p[5],p[8],p[11]],void 0,[p[3],p[6],p[9],p[12]]):/^o /.test(f)||/^g /.test(f)?(c.faces.length>0&&(c.faces=this.getCorrectIndices(c.faces)),c.faces.length>0&&h.push(c),c={},c.name=f.substring(2).trim(),c.vertices=[],c.normals=[],c.uvs=[],c.faces=[]):/^g /.test(f)||/^mtllib /.test(f)||(/^usemtl /.test(f)?u=f.substring(7).trim():/^s /.test(f)))}return h.length>0&&(c.faces=this.getCorrectIndices(c.faces)),h.push(c),h},getMtlName:function(t){for(var e=t.split("\n"),i=0;i<e.length;i++){var r=e[i];if(r=r.trim(),/^mtllib /.test(r))return r.substring(7).trim()}return null},readMtl:function(t){var e=t.split("\n"),i=/Kd ([\d|\.|\+|\-|e|E]+) ([\d|\.|\+|\-|e|E]+) ([\d|\.|\+|\-|e|E]+)/,r={},n=-1;r.mtlName=[],r.kd=[],r.mapKd=[];for(var o=0;o<e.length;o++){var a,s=e[o];/^newmtl /.test(s)?(n++,r.mtlName[n]=s.substring(7).trim()):null!==(a=i.exec(s))?r.kd[n]=[parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]),1]:/^map_Kd /.test(s)&&(r.mapKd[n]=s.substring(7).trim())}return r},getCorrectIndices:function(t){for(var e=parseInt(t[0][0][0]),i=parseInt(t[0][0][1]),r=parseInt(t[0][0][2]),n=0;n<t.length;n++)for(var o=0;o<3;o++)parseInt(t[n][o][0])<e&&(e=parseInt(t[n][o][0])),parseInt(t[n][o][1])<i&&(i=parseInt(t[n][o][1])),parseInt(t[n][o][2])<r&&(r=parseInt(t[n][o][2]));e-=1,i-=1,r-=1;for(var n=0;n<t.length;n++)for(var o=0;o<3;o++)t[n][o][0]-=e,t[n][o][1]-=i,t[n][o][2]-=r;return t},createO3DFromOBJ:function(t,e,i){for(var r=[],n=[],o=[],a=[],s=[],h=[],c=[],u=0,l=!e||e.mapKd.length>0,d=!e||l&&e.mapKd.length>1,y=0;y<t.faces.length;y++){var f,p=t.faces[y],g=0,m=!1;if(!e||0===e.kd.length&&0===e.mapKd.length)f=[.5,.5,.5,1];else{var x=e.mtlName.indexOf(p[3]);m=Boolean(e.mapKd[x]),f=m?e.mapKd[x]:e.kd[x],m&&(g=c.indexOf(f),g<0&&(c.push(f),g=c.indexOf(f)))}for(var v=0;v<3;v++){var A=p[v][0]-1,w=p[v][1]-1,M=p[v][2]-1,R=!1;R||(Array.prototype.push.apply(r,t.vertices[A]),Array.prototype.push.apply(s,t.normals[M]),m?(Array.prototype.push.apply(o,t.uvs[w]),Array.prototype.push.apply(n,[.5,.5,.5,2])):(Array.prototype.push.apply(n,f),Array.prototype.push.apply(o,t.uvs[w])),a.push(g),h.push(u++))}}var b=new Ayce.Object3D;if(r.length>0&&(b.vertices=r),n.length>0&&(b.colors=n),o.length>0&&(b.textureCoords=o),d&&(b.textureIndices=a),s.length>0&&(b.normals=s),h.length>0&&(b.indices=h),l){for(var y=0;y<c.length;y++)c[y]=i+c[y].replace(/\\/g,"/");if(c&&c.length>10)throw"OBJ Loader: Can't use more than 10 Textures";c.length>0&&(b.imageSrc=c)}return b},copyOBJO3D:function(t){var e=new Ayce.Object3D;return t.vertices&&(e.vertices=t.vertices.slice()),t.colors&&(e.colors=t.colors.slice()),t.textureCoords&&(e.textureCoords=t.textureCoords.slice()),t.textureIndices&&(e.textureIndices=t.textureIndices.slice()),t.normals&&(e.normals=t.normals.slice()),t.indices&&(e.indices=t.indices.slice()),e.imageSrc=t.imageSrc,e}},Ayce.VRSquare=function(){Ayce.Object3D.call(this),this.shader="vr-canvas",this.vertices=[-1,-1,1,1,-1,1,-1,1,1,1,1,1],this.textureCoords=[0,0,1,0,0,1,1,1]},Ayce.VRSquare.prototype=new Ayce.Object3D,Ayce.ParticleSystem=function(t,e,i,r){Ayce.Object3D.call(this);var n=3,o=3,a=3,s=1,h=1,c=1;this.particles=[];var u;for(u=0;u<i;u++)this.particles.push(new Ayce.Particle);this.vertices=[],this.colors=null,this.textureCoords=null,this.indices=[],this.velocities=[],this.lifetimes=[],this.gravities=[],this.gravityExps=[],this.geometries=[],this.rotationAngles=[],this.normals=null,this.imageSrc=e.imageSrc,this.shader=null;var l={time:0,startTime:Date.now()};this.shaderAttributes=[],this.shaderAttributes.push(["aGeometryPosition",n,this.geometries]),this.shaderAttributes.push(["aVertexVelocity",o,this.velocities]),this.shaderAttributes.push(["aVertexRotation",a,this.rotationAngles]),this.shaderAttributes.push(["aLifetime",s,this.lifetimes]),this.shaderAttributes.push(["aGravity",h,this.gravities]),this.shaderAttributes.push(["aGravityExponent",c,this.gravityExps]),this.shaderUniforms=[],this.shaderUniforms.push(["uTime","uniform1f",l,["time"]]),this.initParticleArrays=function(){var t;for(u=0;u<this.particles.length;u++){var i=this.particles[u];for(t=0;t<e.vertices.length;t+=3)this.vertices.push(e.vertices[t]*i.scale.x+i.position.x),this.vertices.push(e.vertices[t+1]*i.scale.y+i.position.y),this.vertices.push(e.vertices[t+2]*i.scale.z+i.position.z),this.geometries.push(e.vertices[t]*i.scale.x),this.geometries.push(e.vertices[t+1]*i.scale.y),this.geometries.push(e.vertices[t+2]*i.scale.z)}if(e.textureCoords&&e.textureCoords[0]!=-1)for(this.textureCoords=[],u=0;u<this.particles.length;u++)this.textureCoords=this.textureCoords.concat(e.textureCoords);else for(this.colors=[],u=0;u<this.particles.length;u++)this.particles[u].colors?this.colors=this.colors.concat(this.particles[u].colors):this.colors=this.colors.concat(e.colors);for(u=0;u<this.particles.length;u++)for(t=0;t<e.indices.length;t++)this.indices.push(e.indices[t]+u*e.vertices.length/n);for(u=0;u<this.particles.length;u++)for(t=0;t<e.vertices.length/n;t++)e.velocities?(this.velocities.push(this.particles[u].velocity.x+e.velocities[t*o]),this.velocities.push(this.particles[u].velocity.y+e.velocities[t*o+1]),this.velocities.push(this.particles[u].velocity.z+e.velocities[t*o+2])):(this.velocities.push(this.particles[u].velocity.x),this.velocities.push(this.particles[u].velocity.y),this.velocities.push(this.particles[u].velocity.z));for(u=0;u<this.particles.length;u++)for(t=0;t<e.vertices.length/n;t++)e.lifetimes?0===e.lifetimes[t]?this.lifetimes.push(this.particles[u].lifetime):this.lifetimes.push(Math.min(this.particles[u].lifetime,e.lifetimes[t])):this.lifetimes.push(this.particles[u].lifetime);for(u=0;u<this.particles.length;u++)for(t=0;t<e.vertices.length/n;t++)e.gravities?this.gravities.push(this.particles[u].gravity+e.gravities[t]):this.gravities.push(this.particles[u].gravity),this.gravityExps.push(this.particles[u].gravityExponent);for(u=0;u<this.particles.length;u++)for(t=0;t<e.vertices.length/n;t++)this.rotationAngles.push(this.particles[u].rotationAngle.x),this.rotationAngles.push(this.particles[u].rotationAngle.y),this.rotationAngles.push(this.particles[u].rotationAngle.z);if(e.normals)for(this.normals=[],u=0;u<this.particles.length;u++)this.normals=this.normals.concat(e.normals)};var d=this.update;this.update=function(){d.call(this),l.time=Date.now()+r-l.startTime}},Ayce.ParticleSystem.prototype=new Ayce.Object3D,Ayce.Particle=function(){this.position=new Ayce.Vector3(0,0,0),this.rotationAngle=new Ayce.Vector3(0,0,0),this.scale=new Ayce.Vector3(1,1,1),this.vertices=[],this.colors=null,this.velocity=new Ayce.Vector3(0,0,0),this.lifetime=0,this.gravity=0,this.gravityExponent=1},Ayce.Skybox=function(t,e,i,r,n,o,a,s,h){this.isSkybox=!0,this.imageSrc=[a+t,a+e,a+i,a+r,a+n,a+o],this.parent=s,this.parentRotationWeight=new Ayce.Vector3(0,0,0),this.parentPositionWeight=new Ayce.Vector3(1,1,1);var c=2*h/Math.sqrt(3);this.scale=new Ayce.Vector3(c,c,c),this.vertices=[-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5],this.textureCoords=[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0],this.textureIndices=[0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5],this.normals=null,this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],this.indices.reverse(),this.calcBoundingBox()},Ayce.Skybox.prototype=new Ayce.Object3D,Ayce.Cube3D=function(){Ayce.Object3D.call(this),this.vertices=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],this.colors=[1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1,.5,.5,1,1,.5,.5,1,1,.5,.5,1,1,.5,.5,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1],this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},Ayce.Cube3D.prototype=new Ayce.Object3D,Ayce.Pyramid3D=function(){Ayce.Object3D.call(this),this.vertices=[0,1,0,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1],this.colors=[1,0,0,.5,0,1,0,.5,0,0,1,.5,0,0,1,.5,0,1,0,.5],this.indices=[0,2,1,0,3,2,0,4,3,0,1,4,1,2,3,1,3,4],this.transparent=!0},Ayce.Pyramid3D.prototype=Ayce.Object3D.prototype,Ayce.Sphere3D=function(){Ayce.Object3D.call(this),this.imageSrc="earth.jpg",this.specularMap="earth-specular.gif",this.shininess=10,this.useFragmentLighting=!0;var t=30,e=30,i=5;this.vertices=[],this.normals=[],this.textureCoords=[];for(var r=0;r<=t;r++)for(var n=r*Math.PI/t,o=Math.sin(n),a=Math.cos(n),s=0;s<=e;s++){var h=2*s*Math.PI/e,c=Math.sin(h),u=Math.cos(h),l=u*o,d=a,y=c*o,f=1-s/e,p=1-r/t;this.normals.push(l),this.normals.push(d),this.normals.push(y),this.textureCoords.push(f),this.textureCoords.push(p),this.vertices.push(i*l),this.vertices.push(i*d),this.vertices.push(i*y)}for(console.log(this.normals),this.indices=[],r=0;r<t;r++)for(var s=0;s<e;s++){var g=r*(e+1)+s,m=g+e+1;this.indices.push(g+1),this.indices.push(m),this.indices.push(g),this.indices.push(g+1),this.indices.push(m+1),this.indices.push(m)}},Ayce.Sphere3D.prototype=Ayce.Object3D.prototype,Ayce.Square=function(){Ayce.Object3D.call(this),this.vertices=[-1,-1,0,1,-1,0,1,1,0,-1,1,0],this.colors=[0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1],this.indices=[0,1,2,0,2,3]},Ayce.Square.prototype=Ayce.Object3D.prototype,Ayce.KeyboardHandler=function(t){var e=[],i=[];Ayce.KeyboardHandler.keys=[],this.update=function(){var t;for(t=0;t<e.length;t++)Ayce.KeyboardHandler.keys[e[t]]=!0,e.splice(t,1);for(t=0;t<i.length;t++)Ayce.KeyboardHandler.keys[i[t]]=!1,i.splice(t,1)},window.addEventListener("keydown",function(t){var i=t.keyCode||t.which;Ayce.KeyboardHandler.keys[i]||e.push(i)},!0),window.addEventListener("keyup",function(t){var e=t.keyCode||t.which;i.push(e)},!0)},Ayce.KeyboardHandler.isKeyDown=function(t){if(!Ayce.KeyboardHandler.keys)return void console.log("KeyboardHandler not initialised");if(1===t.length){var e=t.charCodeAt(0);return Ayce.KeyboardHandler.keys[e]}return t.length>1,!1},Ayce.KeyboardHandler.prototype={},Ayce.GamepadHandler=function(){},Ayce.GamepadHandler.getGamepads=function(){if(APISupported)return navigator.getGamepads()};var APISupported=null,init=function(){navigator.getGamepads?(APISupported=!0,console.log("Gamepad API supported"),"ongamepadconnected"in window?console.log("ongamepadconnected supported"):console.log("ongamepadconnected not supported")):(APISupported=!1,console.log("Gamepad API not supported"))};init(),Ayce.MouseHandler=function(){function t(){document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement?document.addEventListener("mousemove",e.onMouseLockMove,!1):document.removeEventListener("mousemove",e.onMouseLockMove,!1)}var e=this;this.addedMovement=new Ayce.Vector2(0,0),this.movement=new Ayce.Vector2(0,0),this.onMouseLockMove=function(t){e.addedMovement.x+=t.movementX||t.mozMovementX||0,e.movement.x=t.movementX||t.mozMovementX||0,e.addedMovement.y+=t.movementY||t.mozMovementY||0,e.movement.y=t.movementY||t.mozMovementY||0},document.addEventListener("pointerlockchange",t,!1),document.addEventListener("mozpointerlockchange",t,!1),document.addEventListener("webkitpointerlockchange",t,!1)};var mouseHandler=null,lastMovement=new Ayce.Vector2(0,0),movement=new Ayce.Vector2(0,0),x=0,y=0,newFrame=!0;Ayce.MouseHandler.getMovement=function(){return null===mouseHandler&&(mouseHandler=new Ayce.MouseHandler),newFrame&&(lastMovement.x-mouseHandler.addedMovement.x===0?movement.x=0:(lastMovement.x=mouseHandler.addedMovement.x,movement.x=mouseHandler.movement.x),lastMovement.y-mouseHandler.addedMovement.y===0?movement.y=0:(lastMovement.y=mouseHandler.addedMovement.y,movement.y=mouseHandler.movement.y),newFrame=!1),movement},Ayce.MouseHandler.setNewFrameTrue=function(){newFrame=!0},Ayce.SensorsHandler=function(){var t=this;this.alpha=0,this.beta=0,this.gamma=0,window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",function(e){t.alpha=e.alpha,t.beta=e.beta,t.gamma=e.gamma},!0)};var sensorsHandler=null;Ayce.SensorsHandler.getRoll=function(){return null==sensorsHandler&&(sensorsHandler=new Ayce.SensorsHandler),sensorsHandler.alpha},Ayce.SensorsHandler.getPitch=function(){return null==sensorsHandler&&(sensorsHandler=new Ayce.SensorsHandler),sensorsHandler.beta},Ayce.SensorsHandler.getYaw=function(){return null==sensorsHandler&&(sensorsHandler=new Ayce.SensorsHandler),sensorsHandler.gamma},Ayce.SensorsHandler.prototype={},Ayce.HMDHandler={onHMDReady:null,getPosition:function(){},getRotation:function(){},update:function(){},showInHMD:function(){},renderToHMD:function(){},exitHMD:function(){},resetSensor:function(){return null},isWebVRReady:function(){return Boolean(navigator.getVRDisplays||navigator.getVRDevices)},isHMDReady:function(){return!1},getEyeTranslationL:function(){return null},getEyeTranslationR:function(){return null},getEyeFOVL:function(){return null},getEyeFOVR:function(){return null},getEyeWidthR:function(){return null},getEyeWidthL:function(){return null},getEyeHeightR:function(){return null},getEyeHeightL:function(){return null}},function(){navigator.getVRDisplays&&"VRFrameData"in window?(console.log("Using WebVR 1.1 API"),navigator.getVRDisplays().then(function(t){t.length<1&&console.warn("WebVR supported, but no VRDisplays found.");var e=t[0];Ayce.HMDHandler=new WebVRHMDHandler_1_1(e,Ayce.HMDHandler.onHMDReady)})):navigator.getVRDisplays?(console.log("Using WebVR 1.0 API"),navigator.getVRDisplays().then(function(t){t.length<1&&console.warn("WebVR supported, but no VRDisplays found.");var e=t[0];Ayce.HMDHandler=new WebVRHMDHandler_1_0(e,Ayce.HMDHandler.onHMDReady)})):navigator.getVRDevices&&(console.log("Using WebVR Deprecated API"),navigator.getVRDevices().then(function(t){var e,i=null,r=null;for(e in t)if(t[e]instanceof HMDVRDevice){i=t[e];break}for(e in t)if(t[e]instanceof PositionSensorVRDevice){r=t[e];break}Ayce.HMDHandler=new WebVRHMDHandler_Deprecated(i,r,Ayce.HMDHandler.onHMDReady),Ayce.HMDHandler.onHMDReady&&Ayce.HMDHandler.onHMDReady()}))}();
//# sourceMappingURL=AyceVR.min.js.map