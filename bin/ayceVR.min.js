var Ayce={};"undefined"!=typeof module&&(module.exports=Ayce),"undefined"==typeof navigator&&(navigator={}),Ayce.requestAnimFrame=function(t){var e=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)};e.call(window,t)},Ayce.Vector2=function(t,e){this.x=t||0,this.y=e||0},Ayce.Vector2.prototype={getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);return 0!==t&&(this.x/=t,this.y/=t),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},nullVector:function(){return this.x=0,this.y=0,this},scaleBy:function(t){return this.x*=t,this.y*=t,this},set:function(t,e){return this.x=t,this.y=e,this},add:function(t,e){return this.x+=t,this.y+=e,this},subtract:function(t,e){return this.x-=t,this.y-=e,this},multiply:function(t,e){return this.x*=t,this.y*=e,this},distance:function(t,e){var i=e.x-t.x,r=e.y-t.y;return Math.sqrt(i*i+r*r)},dotProduct:function(t){return this.x*t.x+this.y*t.y},addVector2:function(t){return this.x+=t.x,this.y+=t.y,this},copyToVector:function(t,e){e.x=t.x,e.y=t.y},copy:function(){return new Ayce.Vector2(this.x,this.y)}},Ayce.Vector3=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0},Ayce.Vector3.prototype={getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return 0!==t&&(this.x/=t,this.y/=t,this.z/=t),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},nullVector:function(){return this.x=0,this.y=0,this.z=0,this},scaleBy:function(t){return this.x*=t,this.y*=t,this.z*=t,this},set:function(t,e,i){return this.x=t,this.y=e,this.z=i,this},add:function(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this},subtract:function(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this},multiply:function(t,e,i){return this.x*=t,this.y*=e,this.z*=i,this},distance:function(t,e){var i=e.x-t.x,r=e.y-t.y,o=e.z-t.z;return Math.sqrt(i*i+r*r+o*o)},dotProduct:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},crossProduct:function(t){return new Ayce.Vector3(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},addVector3:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},copyToVector:function(t,e){e.x=t.x,e.y=t.y,e.z=t.z},copy:function(){return new Ayce.Vector3(this.x,this.y,this.z)}},Ayce.Quaternion=function(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=r||1},Ayce.Quaternion.prototype={multiply:function(t,e){var i=t.w,r=t.x,o=t.y,a=t.z,s=e.w,n=e.x,h=e.y,c=e.z;return this.w=i*s-r*n-o*h-a*c,this.x=i*n+r*s+o*c-a*h,this.y=i*h-r*c+o*s+a*n,this.z=i*c+r*h-o*n+a*s,this},set:function(t,e,i,r){this.x=t,this.y=e,this.z=i,this.w=r},fromAxisAngle:function(t,e){t.normalize();var i=Math.sin(e/2),r=Math.cos(e/2);return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=r,this.normalize(),this},fromEulerAngles:function(t,e,i){var r=.5*t,o=.5*e,a=.5*i,s=Math.cos(r),n=Math.sin(r),h=Math.cos(o),c=Math.sin(o),l=Math.cos(a),u=Math.sin(a);return this.w=s*h*l+n*c*u,this.x=n*h*l-s*c*u,this.y=s*c*l+n*h*u,this.z=s*h*u-n*c*l,this},normalize:function(){var t=this.x,e=this.y,i=this.z,r=this.w,o=1/Math.sqrt(t*t+e*e+i*i+r*r);return this.x*=o,this.y*=o,this.z*=o,this.w*=o,this},reset:function(){this.x=0,this.y=0,this.z=0,this.w=1},rotatePoint:function(t){var e=this.x,i=this.y,r=this.z,o=this.w,a=t.x,s=t.y,n=t.z,h=-e*a-i*s-r*n,c=o*a+i*n-r*s,l=o*s-e*n+r*a,u=o*n+e*s-i*a;return t.x=-h*e+c*o-l*r+u*i,t.y=-h*i+c*r+l*o-u*e,t.z=-h*r-c*i+l*e+u*o,t},getRotatedPoint:function(t,e){var i,r,o,a,s=this.x,n=this.y,h=this.z,c=this.w,l=t.x,u=t.y,d=t.z;a=-s*l-n*u-h*d,i=c*l+n*d-h*u,r=c*u-s*d+h*l,o=c*d+s*u-n*l;var y=e?e:new Ayce.Vector3;return y.x=-a*s+i*c-r*h+o*n,y.y=-a*n+i*h+r*c-o*s,y.z=-a*h-i*n+r*s+o*c,y},toRotationMatrix:function(t){var e=this.x,i=this.y,r=this.z,o=this.w,a=e*e,s=e*i,n=e*r,h=e*o,c=i*i,l=i*r,u=i*o,d=r*r,y=r*o;t.data[0]=1-2*(c+d),t.data[1]=2*(s-y),t.data[2]=2*(n+u),t.data[4]=2*(s+y),t.data[5]=1-2*(a+d),t.data[6]=2*(l-h),t.data[8]=2*(n-u),t.data[9]=2*(l+h),t.data[10]=1-2*(a+c),t.data[3]=t.data[7]=t.data[11]=t.data[12]=t.data[13]=t.data[14]=0,t.data[15]=1},getConjugate:function(t){return this.normalize(),t?(t.x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t):new Ayce.Quaternion(-this.x,-this.y,-this.z,this.w)},copy:function(){return new Ayce.Quaternion(this.x,this.y,this.z,this.w)},copyToQuaternion:function(t,e){e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w},slerp:function(t,e,i){var r=t.w,o=t.x,a=t.y,s=t.z,n=e.w,h=e.x,c=e.y,l=e.z,u=r*n+o*h+a*c+s*l;if(0>u&&(u=-u,n=-n,h=-h,c=-c,l=-l),.95>u){var d=Math.acos(u),y=1/Math.sin(d),p=Math.sin(d*(1-i))*y,f=Math.sin(d*i)*y;this.w=r*p+n*f,this.x=o*p+h*f,this.y=a*p+c*f,this.z=s*p+l*f}else{this.w=r+i*(n-r),this.x=o+i*(h-o),this.y=a+i*(c-a),this.z=s+i*(l-s);var g=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=g,this.x*=g,this.y*=g,this.z*=g}},getForwardVector:function(){return new Ayce.Vector3(2*(this.x*this.z+this.w*this.y),2*(this.y*this.x-this.w*this.x),1-2*(this.x*this.x+this.y*this.y))},getUpVector:function(){return new Ayce.Vector3(2*(this.x*this.y-this.w*this.z),1-2*(this.x*this.x+this.z*this.z),2*(this.y*this.z+this.w*this.x))},getRightVector:function(){return new Ayce.Vector3(1-2*(this.y*this.y+this.z*this.z),2*(this.x*this.y+this.w*this.z),2*(this.x*this.z-this.w*this.y))}},Ayce.Matrix4=function(){this.data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},Ayce.Matrix4.makePerspective=function(t,e,i,r){var o=new Ayce.Matrix4,a=t/2*Math.PI/180,s=Math.sin(a),n=Math.cos(a)/s,h=!0,c=h?-1:1;return o.data=new Float32Array([n/e,0,0,0,0,n,0,0,0,0,r/(i-r)*-c,c,0,0,r*i/(i-r),0]),o},Ayce.Matrix4.makeOrthoPerspective=function(t,e,i,r,o,a){var s=new Ayce.Matrix4,n=1/(t-e),h=1/(r-i),c=1/(o-a);return s.data=new Float32Array([-2*n,0,0,0,0,-2*h,0,0,0,0,2*c,0,(t+e)*n,(i+r)*h,(a+o)*c,1]),s},Ayce.Matrix4.makeVRPerspective=function(t,e,i){var r=Math.PI/180,o=Math.tan(t.upDegrees*r),a=Math.tan(t.downDegrees*r),s=Math.tan(t.leftDegrees*r),n=Math.tan(t.rightDegrees*r),h=2/(s+n),c=(s-n)*h*.5,l=2/(o+a),u=(o-a)*l*.5,d=!0,y=d?-1:1,p=new Ayce.Matrix4;return p.data=new Float32Array([h,0,0,0,0,l,0,0,c*y,u*y,i/(e-i)*-y,y,0,0,i*e/(e-i),0]),p},Ayce.Matrix4.prototype={poolMatrix:new Ayce.Matrix4,poolVector3:new Ayce.Vector3,identity:function(){this.data[0]=1,this.data[1]=0,this.data[2]=0,this.data[3]=0,this.data[4]=0,this.data[5]=1,this.data[6]=0,this.data[7]=0,this.data[8]=0,this.data[9]=0,this.data[10]=1,this.data[11]=0,this.data[12]=0,this.data[13]=0,this.data[14]=0,this.data[15]=1},apply:function(t){var e=this.data[0],i=this.data[4],r=this.data[8],o=this.data[12],a=this.data[1],s=this.data[5],n=this.data[9],h=this.data[13],c=this.data[2],l=this.data[6],u=this.data[10],d=this.data[14],y=this.data[3],p=this.data[7],f=this.data[11],g=this.data[15],x=t.data[0],m=t.data[4],v=t.data[8],A=t.data[12],w=t.data[1],M=t.data[5],b=t.data[9],S=t.data[13],C=t.data[2],R=t.data[6],T=t.data[10],V=t.data[14],z=t.data[3],P=t.data[7],E=t.data[11],L=t.data[15];this.data[0]=e*x+a*m+c*v+y*A,this.data[1]=e*w+a*M+c*b+y*S,this.data[2]=e*C+a*R+c*T+y*V,this.data[3]=e*z+a*P+c*E+y*L,this.data[4]=i*x+s*m+l*v+p*A,this.data[5]=i*w+s*M+l*b+p*S,this.data[6]=i*C+s*R+l*T+p*V,this.data[7]=i*z+s*P+l*E+p*L,this.data[8]=r*x+n*m+u*v+f*A,this.data[9]=r*w+n*M+u*b+f*S,this.data[10]=r*C+n*R+u*T+f*V,this.data[11]=r*z+n*P+u*E+f*L,this.data[12]=o*x+h*m+d*v+g*A,this.data[13]=o*w+h*M+d*b+g*S,this.data[14]=o*C+h*R+d*T+g*V,this.data[15]=o*z+h*P+d*E+g*L},applyRotation:function(t,e,i){if(this.poolMatrix.data[0]=1,this.poolMatrix.data[1]=0,this.poolMatrix.data[2]=0,this.poolMatrix.data[3]=0,this.poolMatrix.data[4]=0,this.poolMatrix.data[5]=1,this.poolMatrix.data[6]=0,this.poolMatrix.data[7]=0,this.poolMatrix.data[8]=0,this.poolMatrix.data[9]=0,this.poolMatrix.data[10]=1,this.poolMatrix.data[11]=0,this.poolMatrix.data[12]=0,this.poolMatrix.data[13]=0,this.poolMatrix.data[14]=0,this.poolMatrix.data[15]=1,this.getAxisRotation(e.x,e.y,e.z,t,this.poolMatrix),void 0!==i){var r=i;this.poolMatrix.applyTranslation(r.x,r.y,r.z)}this.apply(this.poolMatrix)},applyScale:function(t,e,i){this.poolMatrix.data[0]=t,this.poolMatrix.data[1]=0,this.poolMatrix.data[2]=0,this.poolMatrix.data[3]=0,this.poolMatrix.data[4]=0,this.poolMatrix.data[5]=e,this.poolMatrix.data[6]=0,this.poolMatrix.data[7]=0,this.poolMatrix.data[8]=0,this.poolMatrix.data[9]=0,this.poolMatrix.data[10]=i,this.poolMatrix.data[11]=0,this.poolMatrix.data[12]=0,this.poolMatrix.data[13]=0,this.poolMatrix.data[14]=0,this.poolMatrix.data[15]=1,this.apply(this.poolMatrix)},applyTranslation:function(t,e,i){this.data[12]+=t,this.data[13]+=e,this.data[14]+=i},getAxisRotation:function(t,e,i,r,o){var a;a=o?o:new Ayce.Matrix4;var s=this.poolVector3;s.x=t,s.y=e,s.z=i;var n=-r*(Math.PI/180),h=Math.cos(n),c=Math.sin(n),l=1-h;a.data[0]=h+s.x*s.x*l,a.data[5]=h+s.y*s.y*l,a.data[10]=h+s.z*s.z*l;var u=s.x*s.y*l,d=s.z*c;return a.data[4]=u+d,a.data[1]=u-d,u=s.x*s.z*l,d=s.y*c,a.data[8]=u-d,a.data[2]=u+d,u=s.y*s.z*l,d=s.x*c,a.data[9]=u+d,a.data[6]=u-d,a},getDeterminant:function(){return 1*((this.data[0]*this.data[5]-this.data[4]*this.data[1])*(this.data[10]*this.data[15]-this.data[14]*this.data[11])-(this.data[0]*this.data[9]-this.data[8]*this.data[1])*(this.data[6]*this.data[15]-this.data[14]*this.data[7])+(this.data[0]*this.data[13]-this.data[12]*this.data[1])*(this.data[6]*this.data[11]-this.data[10]*this.data[7])+(this.data[4]*this.data[9]-this.data[8]*this.data[5])*(this.data[2]*this.data[15]-this.data[14]*this.data[3])-(this.data[4]*this.data[13]-this.data[12]*this.data[5])*(this.data[2]*this.data[11]-this.data[10]*this.data[3])+(this.data[8]*this.data[13]-this.data[12]*this.data[9])*(this.data[2]*this.data[7]-this.data[6]*this.data[3]))},transpose:function(){this.copyToMatrix(this,this.poolMatrix),this.data[1]=this.poolMatrix.data[4],this.data[2]=this.poolMatrix.data[8],this.data[3]=this.poolMatrix.data[12],this.data[4]=this.poolMatrix.data[1],this.data[6]=this.poolMatrix.data[9],this.data[7]=this.poolMatrix.data[13],this.data[8]=this.poolMatrix.data[2],this.data[9]=this.poolMatrix.data[6],this.data[11]=this.poolMatrix.data[14],this.data[12]=this.poolMatrix.data[3],this.data[13]=this.poolMatrix.data[7],this.data[14]=this.poolMatrix.data[11]},invert:function(){var t=this.getDeterminant(),e=Math.abs(t)>1e-11;if(!e)throw"Can't invert Matrix";t=1/t;var i=this.data[0],r=this.data[4],o=this.data[8],a=this.data[12],s=this.data[1],n=this.data[5],h=this.data[9],c=this.data[13],l=this.data[2],u=this.data[6],d=this.data[10],y=this.data[14],p=this.data[3],f=this.data[7],g=this.data[11],x=this.data[15];return this.data[0]=t*(n*(d*x-y*g)-h*(u*x-y*f)+c*(u*g-d*f)),this.data[1]=-t*(s*(d*x-y*g)-h*(l*x-y*p)+c*(l*g-d*p)),this.data[2]=t*(s*(u*x-y*f)-n*(l*x-y*p)+c*(l*f-u*p)),this.data[3]=-t*(s*(u*g-d*f)-n*(l*g-d*p)+h*(l*f-u*p)),this.data[4]=-t*(r*(d*x-y*g)-o*(u*x-y*f)+a*(u*g-d*f)),this.data[5]=t*(i*(d*x-y*g)-o*(l*x-y*p)+a*(l*g-d*p)),this.data[6]=-t*(i*(u*x-y*f)-r*(l*x-y*p)+a*(l*f-u*p)),this.data[7]=t*(i*(u*g-d*f)-r*(l*g-d*p)+o*(l*f-u*p)),this.data[8]=t*(r*(h*x-c*g)-o*(n*x-c*f)+a*(n*g-h*f)),this.data[9]=-t*(i*(h*x-c*g)-o*(s*x-c*p)+a*(s*g-h*p)),this.data[10]=t*(i*(n*x-c*f)-r*(s*x-c*p)+a*(s*f-n*p)),this.data[11]=-t*(i*(n*g-h*f)-r*(s*g-h*p)+o*(s*f-n*p)),this.data[12]=-t*(r*(h*y-c*d)-o*(n*y-c*u)+a*(n*d-h*u)),this.data[13]=t*(i*(h*y-c*d)-o*(s*y-c*l)+a*(s*d-h*l)),this.data[14]=-t*(i*(n*y-c*u)-r*(s*y-c*l)+a*(s*u-n*l)),this.data[15]=t*(i*(n*d-h*u)-r*(s*d-h*l)+o*(s*u-n*l)),e},transformVector:function(t){var e=t.x,i=t.y,r=t.z;return t.x=e*this.data[0]+i*this.data[4]+r*this.data[8]+this.data[12],t.y=e*this.data[1]+i*this.data[5]+r*this.data[9]+this.data[13],t.z=e*this.data[2]+i*this.data[6]+r*this.data[10]+this.data[14],t},copyToMatrix:function(t,e){e.data[0]=t.data[0],e.data[1]=t.data[1],e.data[2]=t.data[2],e.data[3]=t.data[3],e.data[4]=t.data[4],e.data[5]=t.data[5],e.data[6]=t.data[6],e.data[7]=t.data[7],e.data[8]=t.data[8],e.data[9]=t.data[9],e.data[10]=t.data[10],e.data[11]=t.data[11],e.data[12]=t.data[12],e.data[13]=t.data[13],e.data[14]=t.data[14],e.data[15]=t.data[15]},copy:function(){var t=new Ayce.Matrix4;return t.data=new Float32Array(this.data),t},getMatrix3:function(t){var e;return e=t?t:new Ayce.Matrix3,e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=this.data[2],e.data[3]=this.data[4],e.data[4]=this.data[5],e.data[5]=this.data[6],e.data[6]=this.data[8],e.data[7]=this.data[9],e.data[8]=this.data[10],e}},Ayce.Matrix3=function(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1])},Ayce.Matrix3.prototype={},Ayce.Geometry=function(){this.position=new Ayce.Vector3(0,0,0),this.rotation=new Ayce.Quaternion,this.scale=new Ayce.Vector3(1,1,1),this.offset=new Ayce.Vector3(0,0,0)},Ayce.Geometry.prototype={},Ayce.Geometry.Box=function(t,e,i){Ayce.Geometry.call(this),this.a=t||0,this.b=e||0,this.c=i||0},Ayce.Geometry.Box.prototype=new Ayce.Geometry,Ayce.Geometry.Box.prototype.getO3D=function(t){var e=new Ayce.Object3D,i=this.offset,r=this.a,o=this.b,a=this.c;return e.vertices=[],e.vertices.push(i.x+0,i.y+0,i.z+0),e.vertices.push(i.x+r,i.y+0,i.z+0),e.vertices.push(i.x+0,i.y+o,i.z+0),e.vertices.push(i.x+r,i.y+o,i.z+0),e.vertices.push(i.x+0,i.y+0,i.z+a),e.vertices.push(i.x+r,i.y+0,i.z+a),e.vertices.push(i.x+0,i.y+o,i.z+a),e.vertices.push(i.x+r,i.y+o,i.z+a),e.normals=[],e.normals.push(-1,-1,-1),e.normals.push(1,-1,-1),e.normals.push(-1,1,-1),e.normals.push(1,1,-1),e.normals.push(-1,-1,1),e.normals.push(1,-1,1),e.normals.push(-1,1,1),e.normals.push(1,1,1),e.indices=[],t?(e.indices.push(0,1),e.indices.push(5,1),e.indices.push(4,0),e.indices.push(4,5),e.indices.push(2,6),e.indices.push(6,7),e.indices.push(7,3),e.indices.push(3,2),e.indices.push(0,2),e.indices.push(4,6),e.indices.push(5,7),e.indices.push(3,1),e.isWireframe=!0):(e.indices.push(2,1,0),e.indices.push(2,3,1),e.indices.push(7,4,5),e.indices.push(7,6,4),e.indices.push(6,0,4),e.indices.push(6,2,0),e.indices.push(3,5,1),e.indices.push(3,7,5),e.indices.push(0,5,4),e.indices.push(0,1,5),e.indices.push(6,3,2),e.indices.push(6,7,3)),e.position=this.position,e.rotation=this.rotation,e.scale=this.scale,e},Ayce.Geometry.Box.prototype.containsPoint=function(t){var e=this,i=function(t){var i=e.position.copy().addVector3(t).addVector3(e.offset);return i.multiply(e.scale.x,e.scale.y,e.scale.z),i=e.rotation.getRotatedPoint(i)},r=function(t,e,i,r){e=e.copy().subtract(t.x,t.y,t.z),i=i.copy().subtract(t.x,t.y,t.z);var o=e.copy().crossProduct(i).normalize(),a=r.copy().subtract(t.x,t.y,t.z),s=o.dotProduct(a);return s},o=i(new Ayce.Vector3(0,0,0)),a=i(new Ayce.Vector3(0,this.b,0)),s=i(new Ayce.Vector3(this.a,this.b,0)),n=i(new Ayce.Vector3(0,0,this.c)),h=i(new Ayce.Vector3(this.a,0,this.c)),c=i(new Ayce.Vector3(0,this.b,this.c)),l=i(new Ayce.Vector3(this.a,this.b,this.c)),u=r(c,a,l,t),d=r(n,h,o,t),y=r(c,n,o,t),p=r(l,s,h,t),f=r(c,l,n,t),g=r(a,o,s,t),n=u>0&&d>0&&y>0&&p>0&&f>0&&g>0;return n},Ayce.Geometry.Sphere=function(t){Ayce.Geometry.call(this),this.r=t||0},Ayce.Geometry.Sphere.prototype=new Ayce.Geometry,Ayce.Geometry.Sphere.prototype.getO3D=function(t,e,i){this.scale=null;var r,o,a=e||10,s=i||10,n=this.r,h=this.offset,c=new Ayce.Object3D;for(c.vertices=[],c.normals=[],c.textureCoords=[],r=0;s>=r;r++){var l=r*Math.PI/s,u=Math.sin(l),d=Math.cos(l);for(o=0;a>=o;o++){var y=2*o*Math.PI/a,p=Math.sin(y),f=Math.cos(y),g=f*u,x=d,m=p*u,v=1-o/a,A=1-r/s;c.normals.push(g,x,m),c.textureCoords.push(v,A),c.vertices.push(n*g+h.x,n*x+h.y,n*m+h.z)}}for(t&&(c.isWireframe=!0),c.indices=[],r=0;s>r;r++)for(o=0;a>o;o++){var w=r*(a+1)+o,M=w+a+1;t?(c.indices.push(M+1,M),c.indices.push(M,w),c.indices.push(w+1,w),c.indices.push(w+1,M+1)):(c.indices.push(w+1,M,w),c.indices.push(w+1,M+1,M))}return c.position=this.position,c.rotation=this.rotation,c},Ayce.Geometry.Plane=function(t,e,i,r,o){Ayce.Geometry.call(this),this.a=t||0,this.b=e||0,this.xVertices=i||2,this.yVertices=r||2,this.splitSquares=o},Ayce.Geometry.Plane.prototype=new Ayce.Geometry,Ayce.Geometry.Plane.prototype.getO3D=function(){var t=new Ayce.Object3D,e=this.offset,i=this.a,r=this.b,o=this.xVertices,a=this.yVertices;t.vertices=[];var s,n,h=i/o,c=r/a;if(this.splitSquares){for(n=0;n<this.yVertices-1;n++)for(s=0;s<this.xVertices-1;s++)t.vertices.push(e.x+s*h,e.y+n*c,e.z,e.x+s*h+h,e.y+n*c,e.z,e.x+s*h,e.y+n*c+c,e.z,e.x+s*h+h,e.y+n*c,e.z,e.x+s*h+h,e.y+n*c+c,e.z,e.x+s*h,e.y+n*c+c,e.z);t.normals=[],t.indices=[];for(var l=0;l<t.vertices.length/3;l++)t.normals.push(0,0,1),t.indices.push(l)}else{for(n=0;n<this.yVertices;n++)for(s=0;s<this.xVertices;s++)t.vertices.push(e.x+s*h,e.y+n*c,e.z);for(t.normals=[],l=0;o*a>l;l++)t.normals.push(0,0,1);for(t.indices=[],l=0;o*(a-1)>l;l++)(l+1)%o!=0&&t.indices.push(l+1,l+o,l,l+o+1,l+o,l+1)}return t.position=this.position,t.rotation=this.rotation,t.scale=this.scale,t},Ayce.Geometry.Icosahedron=function(t){this.subdivisions=t,Ayce.Geometry.call(this)},Ayce.Geometry.Icosahedron.prototype=new Ayce.Geometry,Ayce.Geometry.Icosahedron.prototype.getO3D=function(){var t=new Ayce.Object3D,e=new Ayce.Vector2(.5,(1+Math.sqrt(5))/2-(1+Math.sqrt(5))/2/2),i=new Ayce.Vector2(-e.x,e.y),r=new Ayce.Vector2(e.x,e.y),o=new Ayce.Vector2(-e.x,-e.y),a=new Ayce.Vector2(e.x,-e.y),s=[];s.push(i.x,i.y,0,r.x,r.y,0,o.x,o.y,0,a.x,a.y,0,0,i.x,i.y,0,r.x,r.y,0,o.x,o.y,0,a.x,a.y,i.y,0,i.x,r.y,0,r.x,o.y,0,o.x,a.y,0,a.x),t.vertices=[s[0],s[1],s[2],s[15],s[16],s[17],s[3],s[4],s[5],s[0],s[1],s[2],s[3],s[4],s[5],s[21],s[22],s[23],s[0],s[1],s[2],s[30],s[31],s[32],s[33],s[34],s[35],s[0],s[1],s[2],s[21],s[22],s[23],s[30],s[31],s[32],s[0],s[1],s[2],s[33],s[34],s[35],s[15],s[16],s[17],s[3],s[4],s[5],s[27],s[28],s[29],s[24],s[25],s[26],s[3],s[4],s[5],s[24],s[25],s[26],s[21],s[22],s[23],s[3],s[4],s[5],s[15],s[16],s[17],s[27],s[28],s[29],s[12],s[13],s[14],s[27],s[28],s[29],s[15],s[16],s[17],s[12],s[13],s[14],s[9],s[10],s[11],s[27],s[28],s[29],s[12],s[13],s[14],s[15],s[16],s[17],s[33],s[34],s[35],s[6],s[7],s[8],s[33],s[34],s[35],s[30],s[31],s[32],s[6],s[7],s[8],s[12],s[13],s[14],s[33],s[34],s[35],s[6],s[7],s[8],s[9],s[10],s[11],s[12],s[13],s[14],s[9],s[10],s[11],s[24],s[25],s[26],s[27],s[28],s[29],s[18],s[19],s[20],s[6],s[7],s[8],s[30],s[31],s[32],s[18],s[19],s[20],s[9],s[10],s[11],s[6],s[7],s[8],s[18],s[19],s[20],s[24],s[25],s[26],s[9],s[10],s[11],s[18],s[19],s[20],s[21],s[22],s[23],s[24],s[25],s[26],s[18],s[19],s[20],s[30],s[31],s[32],s[21],s[22],s[23]];var n=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2)),h=[t.vertices],c=this.subdivisions-1;i=new Ayce.Vector3(0,0,0),r=new Ayce.Vector3(0,0,0),o=new Ayce.Vector3(0,0,0);for(var l,u=new Ayce.Vector3(0,0,0),d=new Ayce.Vector3(0,0,0),y=new Ayce.Vector3(0,0,0),p=1;c+1>p;p++)h[p]=[];for(p=0;p<h.length-1;p++)for(var f=0;f<h[p].length;f+=9)i.set(h[p][f],h[p][f+1],i.z=h[p][f+2]),r.set(h[p][f+3],h[p][f+4],h[p][f+5]),o.set(h[p][f+6],h[p][f+7],h[p][f+8]),u.set((i.x+r.x)/2,(i.y+r.y)/2,(i.z+r.z)/2),l=n/Math.sqrt(u.x*u.x+u.y*u.y+u.z*u.z),u.x*=l,u.y*=l,u.z*=l,d.set((r.x+o.x)/2*l,(r.y+o.y)/2*l,(r.z+o.z)/2*l),y.set((i.x+o.x)/2*l,(i.y+o.y)/2*l,(i.z+o.z)/2*l),h[p+1].push(i.x,i.y,i.z,u.x,u.y,u.z,y.x,y.y,y.z,r.x,r.y,r.z,d.x,d.y,d.z,u.x,u.y,u.z,o.x,o.y,o.z,y.x,y.y,y.z,d.x,d.y,d.z,u.x,u.y,u.z,d.x,d.y,d.z,y.x,y.y,y.z),f==h[p].length-1&&c--;for(t.vertices=h[h.length-1],t.indices=[],p=0;p<t.vertices.length/3;p++)t.indices.push(p);var g;for(t.normals=[],p=0;p<t.vertices.length;p+=9)i.set(t.vertices[p],t.vertices[p+1],t.vertices[p+2]),r.set(t.vertices[p+3],t.vertices[p+4],t.vertices[p+5]),o.set(t.vertices[p+6],t.vertices[p+7],t.vertices[p+8]),u=r.subtract(i.x,i.y,i.z),y=o.subtract(i.x,i.y,i.z),g=u.crossProduct(y),t.normals.push(g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z);return t.position=this.position,t.rotation=this.rotation,t.scale=this.scale,t},Ayce.Geometry.CollisionMath={},Ayce.Geometry.CollisionMath.ObjectPool={corners1:[new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3],corners2:[new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3],normals:[new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3],edgeNormalV1:new Ayce.Vector3,edgeNormalV2:new Ayce.Vector3},Ayce.Geometry.CollisionMath.calcCorner=function(t,e,i,r,o){t.x=i?e.a:0,t.y=r?e.b:0,t.z=o?e.c:0,t.addVector3(e.offset),t.multiply(e.scale.x,e.scale.y,e.scale.z),e.rotation.getConjugate().rotatePoint(t),t.addVector3(e.position)},Ayce.Geometry.CollisionMath.calcNormal=function(t,e,i,r){var o=i.x-e.x,a=i.y-e.y,s=i.z-e.z,n=r.x-e.x,h=r.y-e.y,c=r.z-e.z;t.x=a*c-s*h,t.y=s*n-o*c,t.z=o*h-a*n,t.normalize()},Ayce.Geometry.CollisionMath.getEdgeNormal=function(t,e,i,r){var o=Ayce.Geometry.CollisionMath.ObjectPool.edgeNormalV1;o.x=i.x-e.x,o.y=i.y-e.y,o.z=i.z-e.z,o.normalize();var a=o.x*(r.x-e.x)+o.y*(r.y-e.y)+o.z*(r.z-e.z);t.x=o.x*a+e.x-r.x,t.y=o.y*a+e.y-r.y,t.z=o.z*a+e.z-r.z,t.normalize()},Ayce.Geometry.prototype.boxBoxCollision=function(t,e){var i=Ayce.Geometry.CollisionMath.calcCorner,r=Ayce.Geometry.CollisionMath.calcNormal,o=Ayce.Geometry.CollisionMath.ObjectPool.corners1;i(o[0],t,!1,!1,!1),i(o[1],t,!0,!1,!1),i(o[2],t,!1,!0,!1),i(o[3],t,!0,!0,!1),i(o[4],t,!1,!1,!0),i(o[5],t,!0,!1,!0),i(o[6],t,!1,!0,!0),i(o[7],t,!0,!0,!0);var a=Ayce.Geometry.CollisionMath.ObjectPool.corners2;i(a[0],e,!1,!1,!1),i(a[1],e,!0,!1,!1),i(a[2],e,!1,!0,!1),i(a[3],e,!0,!0,!1),i(a[4],e,!1,!1,!0),i(a[5],e,!0,!1,!0),i(a[6],e,!1,!0,!0),i(a[7],e,!0,!0,!0);var s=Ayce.Geometry.CollisionMath.ObjectPool.normals,n=6;r(s[0],o[0],o[1],o[2]),r(s[1],o[0],o[4],o[2]),r(s[2],o[0],o[1],o[4]),r(s[3],a[0],a[1],a[2]),r(s[4],a[0],a[4],a[2]),r(s[5],a[0],a[1],a[4]);var h,c,l=null;for(h=0;n>h;h++){var u=s[h];if(0!==u.x||0!==u.y||0!==u.z){var d=null,y=null;for(c=0;c<o.length;c++){var p=u.dotProduct(o[c]);(null===d||d>p)&&(d=p),(null===y||p>y)&&(y=p)}var f=null,g=null;for(c=0;c<a.length;c++){var p=u.dotProduct(a[c]);(null===f||f>p)&&(f=p),(null===g||p>g)&&(g=p)}if(f>y||d>g)return null;var x=y-f;Math.abs(g-d)<Math.abs(x)&&(x=g-d),Math.abs(d-g)<Math.abs(x)&&(x=d-g),Math.abs(f-y)<Math.abs(x)&&(x=f-y),d>f&&(x=-x);var m=u.copy().scaleBy(x);(null===l||l.getLength()>m.getLength())&&(l=m,l.normal=u,l.distance=x)}}return l},Ayce.Geometry.prototype.boxSphereCollision=function(t,e,i){(0===t.a||0===t.b||0===t.c)&&(i=!0);var r=Ayce.Geometry.CollisionMath.calcCorner,o=Ayce.Geometry.CollisionMath.calcNormal,a=Ayce.Geometry.CollisionMath.getEdgeNormal,s=Ayce.Geometry.CollisionMath.ObjectPool.corners1;r(s[0],t,!1,!1,!1),r(s[1],t,!0,!1,!1),r(s[2],t,!1,!0,!1),r(s[3],t,!0,!0,!1),r(s[4],t,!1,!1,!0),r(s[5],t,!0,!1,!0),r(s[6],t,!1,!0,!0),r(s[7],t,!0,!0,!0);var n=e.position.copy().addVector3(e.offset),h=Ayce.Geometry.CollisionMath.ObjectPool.normals,c=15;o(h[0],s[0],s[1],s[2]),o(h[1],s[0],s[2],s[4]),o(h[2],s[0],s[4],s[1]),a(h[3],s[0],s[1],n),a(h[4],s[1],s[5],n),a(h[5],s[4],s[5],n),a(h[6],s[4],s[0],n),a(h[7],s[2],s[6],n),a(h[8],s[7],s[6],n),a(h[9],s[7],s[3],n),a(h[10],s[3],s[2],n),a(h[11],s[0],s[2],n),a(h[12],s[1],s[3],n),a(h[13],s[7],s[5],n),a(h[14],s[6],s[4],n);var l,u,d=null;for(l=0;c>l;l++){var y=h[l];if(0!==y.x||0!==y.y||0!==y.z){var p=null,f=null;for(u=0;u<s.length;u++){var g=y.dotProduct(s[u]);(null===p||p>g)&&(p=g),(null===f||g>f)&&(f=g)}var x=y.dotProduct(n),m=x-e.r,v=x+e.r;if(m>f||p>v)return null;var A=f-m;Math.abs(v-p)<Math.abs(A)&&(A=v-p),Math.abs(p-v)<Math.abs(A)&&(A=p-v),Math.abs(m-f)<Math.abs(A)&&(A=m-f);var w=y.copy().scaleBy(A);(i&&p>m||!i&&m>p)&&w.negate(),(null===d||d.getLength()>w.getLength())&&(d=w,d.distance=A,d.normal=y)}}return d},Ayce.Geometry.prototype.sphereSphereCollision=function(t,e){var i=t.position.copy().addVector3(t.offset),r=e.position.copy().addVector3(e.offset),o=i.copy().subtract(r.x,r.y,r.z).getLength();if(o<t.r+e.r){var a=t.position,s=e.position.copy().subtract(a.x,a.y,a.z).normalize().scaleBy(t.r+e.r-o);return s.distance=o,s.normal=s,s}return null},Ayce.Timer=function(){},Ayce.Timer.prototype={},Ayce.Timer.prototype.getCurrentTimeMs=function(){return(new Date).getTime()},Ayce.XMLLoader=function(){},Ayce.XMLLoader.getSourceSynch=function(t){var e=new XMLHttpRequest;return e.open("GET",t,!1),e.send(),200==e.status?e.responseText:null},Ayce.XMLLoader.prototype={},Ayce.Renderer=function(t){var e,i=0,r=this;this.width=0,this.height=0,this.clearColor={red:0,green:0,blue:0},this.init=function(){t.width=this.width,t.height=this.height,a(t),o()},this.resize=function(){t.width=this.width,t.height=this.height,e.viewportWidth=t.width,e.viewportHeight=t.height,r.setViewportAndScissor(0,0,e.viewportWidth,e.viewportHeight)};var o=function(){e.clearColor(r.clearColor.red,r.clearColor.green,r.clearColor.blue,1),r.setViewportAndScissor(0,0,e.viewportWidth,e.viewportHeight),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.cullFace(e.FRONT),e.frontFace(e.CW),e.enable(e.SCISSOR_TEST)},a=function(t){try{var i={alpha:!1};e=t.getContext("webgl",i),e||(e=t.getContext("experimental-webgl",i)),e.viewportWidth=t.width,e.viewportHeight=t.height,e.ext=null,e.shaders={}}catch(r){}e||alert("Could not initialise WebGL.")};this.update=function(t,e,r){for(i=0;i<e.length;i++)e[i].buffer.update(t);for(i=0;i<r.length;i++)r[i].buffer.update(t)},this.render=function(t,r,o){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var a;for(i=0;i<r.length;i++)a=r[i].buffer,a.render();for(i=0;i<o.length;i++)a=o[i].buffer,a.render()},this.setViewportAndScissor=function(t,i,r,o){e.viewport(t,i,r,o),e.scissor(t,i,r,o),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)},this.getBuffer=function(t,i){if(!t instanceof Ayce.Object3D)throw"Can't get Buffer for "+t;return new Ayce.BufferMulti(e,t,i)},this.getCanvasHeight=function(){return e.viewportHeight},this.getCanvasWidth=function(){return e.viewportWidth},this.getGL=function(){return e}},Ayce.Renderer.prototype={},Ayce.VRRenderer=function(t,e,i){function r(){var t=h.createFramebuffer();h.bindFramebuffer(h.FRAMEBUFFER,t),y=t.width=1024,p=t.height=1024;var e=h.createTexture();h.bindTexture(h.TEXTURE_2D,e),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.LINEAR),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,t.width,t.height,0,h.RGBA,h.UNSIGNED_BYTE,null);var i=h.createRenderbuffer();return h.bindRenderbuffer(h.RENDERBUFFER,i),h.renderbufferStorage(h.RENDERBUFFER,h.DEPTH_COMPONENT16,t.width,t.height),h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,e,0),h.framebufferRenderbuffer(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.RENDERBUFFER,i),h.bindTexture(h.TEXTURE_2D,null),h.bindRenderbuffer(h.RENDERBUFFER,null),h.bindFramebuffer(h.FRAMEBUFFER,null),[t,e]}function o(){var t,e=x.vertices.slice();for(t=M;t<=x.vertices.length;t+=M)e.splice(t+(t/M-1)*b,0,x.textureCoords[(t/M-1)*b],x.textureCoords[(t/M-1)*b+1]);w=4*(M+b),g=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,g),h.bufferData(h.ARRAY_BUFFER,new Float32Array(e),h.STATIC_DRAW),g.numItems=4,h.enableVertexAttribArray(f.vertexPositionAttribute),h.vertexAttribPointer(f.vertexPositionAttribute,M,h.FLOAT,!1,w,0),h.enableVertexAttribArray(f.textureCoordAttribute),h.vertexAttribPointer(f.textureCoordAttribute,b,h.FLOAT,!1,w,4*M)}function a(t,e){h.bindFramebuffer(h.FRAMEBUFFER,c),v.setViewportAndScissor(0,0,y,p),n(t,"left"),n(e,"left"),h.bindFramebuffer(h.FRAMEBUFFER,l),v.setViewportAndScissor(0,0,y,p),n(t,"right"),n(e,"right"),h.bindFramebuffer(h.FRAMEBUFFER,null),f.initShaders(),h.bindBuffer(h.ARRAY_BUFFER,g),h.vertexAttribPointer(f.vertexPositionAttribute,M,h.FLOAT,!1,w,0),h.vertexAttribPointer(f.textureCoordAttribute,b,h.FLOAT,!1,w,4*M),h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,u),h.uniform1i(f.samplerUniform,0),v.setViewportAndScissor(0,0,h.viewportWidth,h.viewportHeight),h.uniformMatrix4fv(f.pMatrixUniform,!1,m.getPerspectiveMatrix().data),h.uniformMatrix4fv(f.mvMatrixUniform,!1,m.getViewMatrix().data),h.drawArrays(h.TRIANGLE_STRIP,0,g.numItems),h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,d),h.uniform1i(f.samplerUniform,0),v.setViewportAndScissor(h.viewportWidth,0,h.viewportWidth,h.viewportHeight),h.uniformMatrix4fv(f.pMatrixUniform,!1,m.getPerspectiveMatrix().data),h.uniformMatrix4fv(f.mvMatrixUniform,!1,m.getViewMatrix().data),h.drawArrays(h.TRIANGLE_STRIP,0,g.numItems),h.bindTexture(h.TEXTURE_2D,null)}function s(t,e){v.setViewportAndScissor(0,0,h.viewportWidth,h.viewportHeight),n(t,"left"),n(e,"left"),v.setViewportAndScissor(h.viewportWidth,0,h.viewportWidth,h.viewportHeight),n(t,"right"),n(e,"right")}function n(t,e){for(var i=0;i<t.length;i++)t[i].buffer.renderVR(e)}Ayce.Renderer.call(this,t);var h,c,l,u,d,y,p,f,g,x,m,v=this,A=0,w=0,M=3,b=2;this.resize=function(){i?(t.width=i.cameraProperties.renderRectWidth,t.height=i.cameraProperties.renderRectHeight):(console.warn("Can't get renderRect from cameraProperties."),t.width=this.width*window.devicePixelRatio,t.height=this.height*window.devicePixelRatio),t.style.width=this.width+"px",t.style.height=this.height+"px",console.log("Resolution: "+t.width+"x"+t.height," Style: "+t.style.width+" - "+t.style.height),h.viewportWidth=t.width/2,h.viewportHeight=t.height,v.setViewportAndScissor(0,0,h.viewportWidth,h.viewportHeight)};var S=this.init;this.init=function(){console.log("Initializing VRRenderer"),S(),h=this.getGL();var t=r();c=t[0],u=t[1],t=r(),l=t[0],d=t[1],x=new Ayce.VRSquare;var e=Ayce.VRRenderer.prototype.vrCanvasVert,i=Ayce.VRRenderer.prototype.vrCanvasFrag;f=new Ayce.Shader(h,e,i),f.pMatrixUniform=f.getUniformLocation("uPMatrix"),f.mvMatrixUniform=f.getUniformLocation("uMVMatrix"),f.vertexPositionAttribute=f.getAttribLocation("aVertexPosition"),f.textureCoordAttribute=f.getAttribLocation("aTextureCoord"),f.samplerUniform=f.getUniformLocation("uSampler");var a=new Ayce.CameraModifier;a.getPosition().set(0,0,2.3),a.getOrientation().set(0,0,0,1);var s=new Ayce.CameraManager;s.modifiers.push(a),m=new Ayce.Camera(s),m.isOrtho=!0,m.updateProjectionMatrix(),m.update(),o(),h.enable(h.SCISSOR_TEST)},this.update=function(t,e,i){for(A=0;A<e.length;A++)e[A].buffer.updateVR(t);for(A=0;A<i.length;A++)i[A].buffer.updateVR(t)},this.render=function(t,i,r){e?a(i,r):s(i,r)}},Ayce.VRRenderer.prototype=new Ayce.Renderer,Ayce.VRRenderer.prototype.vrCanvasVert="attribute vec3 aVertexPosition;attribute vec2 aTextureCoord;uniform mat4 uMVMatrix;uniform mat4 uPMatrix;varying vec2 vTextureCoord;void main(void) {gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);vTextureCoord = aTextureCoord;}",Ayce.VRRenderer.prototype.vrCanvasFrag="precision mediump float;uniform sampler2D uSampler;uniform bool uUseTextures;varying vec2 vTextureCoord;varying vec4 vColor;void main(void) {    float distance = sqrt(abs(0.5-vTextureCoord.s)*abs(0.5-vTextureCoord.s)+abs(0.5-vTextureCoord.t)*abs(0.5-vTextureCoord.t));    float distanceS = (0.5-vTextureCoord.s);    float distanceT = (0.5-vTextureCoord.t);    float factor = 1.0+0.22*distance*distance+0.24*distance*distance*distance*distance;    float newCoordS = (vTextureCoord.s-0.5)*factor;    float newCoordT = (vTextureCoord.t-0.5)*factor;    float offsetR = 1.0;    float offsetG = 0.995;    float offsetB = 0.980;    float newCoordSR = newCoordS/offsetR+0.5;    float newCoordSG = newCoordS/offsetG+0.5;    float newCoordSB = newCoordS/offsetB+0.5;    float newCoordTR = newCoordT/offsetR+0.5;    float newCoordTG = newCoordT/offsetG+0.5;    float newCoordTB = newCoordT/offsetB+0.5;    if(newCoordSR<0.0||newCoordSR>1.0    ||newCoordSG<0.0||newCoordSG>1.0    ||newCoordSB<0.0||newCoordSB>1.0    ||newCoordTR<0.0||newCoordTR>1.0    ||newCoordTG<0.0||newCoordTG>1.0    ||newCoordTB<0.0||newCoordTB>1.0){        gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);    }else{        float r = texture2D(uSampler, vec2(newCoordSR, newCoordTR)).r;        float g = texture2D(uSampler, vec2(newCoordSG, newCoordTG)).g;        float b = texture2D(uSampler, vec2(newCoordSB, newCoordTB)).b;        gl_FragColor = vec4(r, g, b, 1.0);    }}",Ayce.Scene=function(t){var e=0,i=!0,r=new Ayce.Camera(new Ayce.CameraManager),o=new Ayce.AudioContext,a=null,s=new Ayce.KeyboardHandler;
this.render=!0,this.width=t.parentNode.clientWidth,this.height=t.parentNode.clientHeight;var n=[],h=[],c=new Ayce.LightContainer,l=[];this.resize=function(){this.width=t.parentNode.clientWidth,this.height=t.parentNode.clientHeight,a.width=this.width,a.height=this.height,a.resize(),r.width=a.getCanvasWidth(),r.height=a.getCanvasHeight(),r.updateProjectionMatrix()},this.useWebVR=function(){var e=r.getManager().modifiers;if(e&&e.length>0)throw"Camera modifiers not empty. Please call camera.getManager().clearModifiers() first.";if(!Ayce.HMDHandler.isWebVRReady())return console.warn("Browser dosen't support WebVR."),!1;var i=r.getManager();return i.modifiers.push(new Ayce.WebVR),r.update(),this.setRenderer(new Ayce.VRRenderer(t,!1,i)),r.useVR=!0,!0},this.useCardboard=function(t){this.useMotionSensor(),this.setRendererVR(t),r.useVR=!0,this.resize()},this.useMotionSensor=function(){var t=r.getManager().modifiers;if(t&&t.length>0)throw"Camera modifiers not empty. Please call camera.getManager().clearModifiers() first.";t.push(new Ayce.Cardboard)},this.setRendererDesktop=function(){this.setRenderer(new Ayce.Renderer(t)),r.useVR=!1,this.resize()},this.setRendererVR=function(e){this.setRenderer(new Ayce.VRRenderer(t,e)),r.useVR=!0,this.resize()},this.setRenderer=function(e){var i=null;a&&(e.clearColor=a.clearColor,i=a.getGL().shaders),a=e,a.width=this.width,a.height=this.height,a.init(),t.style.width="auto",t.style.height="auto",i&&(a.getGL().shaders=i)},this.setRendererNull=function(){a=null},this.setRendererDesktop(),window.attachEvent?window.attachEvent("onresize",this.resize):window.addEventListener&&window.addEventListener("resize",this.resize,!0),this.updateScene=function(){for(i&&(u(n),u(h),i=!1),s.update(),r.update(),c.update(r),e=0;e<n.length;e++)n[e].update();for(e=0;e<h.length;e++)h[e].update();for(a.update(r,n,h),e=0;e<l.length;e++){l[e].listenerPosition=r.getManager().getGlobalPosition();var t=r.getManager().getGlobalRotation(),o=t.getForwardVector(),d=t.getUpVector();l[e].listenerOrientationFront.x=o.x,l[e].listenerOrientationFront.y=o.y,l[e].listenerOrientationFront.z=o.z,l[e].listenerOrientationUp.x=d.x,l[e].listenerOrientationUp.y=d.y,l[e].listenerOrientationUp.z=d.z,l[e].update()}},this.drawScene=function(){if(this.render&&!i){for(var t=0,e=0;e<h.length;e++)if(!h[e].renderPriority){var o=h[e].getGlobalPosition(),s=r.getManager();h[e].distance=Math.sqrt(Math.pow(s.getGlobalPosition().x-o.x,2)+Math.pow(s.getGlobalPosition().y-o.y,2)+Math.pow(s.getGlobalPosition().z-o.z,2)),h[e].distance>t&&(t=h[e].distance)}for(e=0;e<h.length;e++)h[e].renderPriority&&(h[e].distance=h[e].renderPriority>0?t+h[e].renderPriority:h[e].renderPriority);h.sort(function(t,e){return e.distance-t.distance}),a.render(r,n,h)}};var u=function(t){for(e=0;e<t.length;e++)t[e].buffer&&t[e].buffer.dispose(),t[e].buffer=a.getBuffer(t[e],c)};this.addToScene=function(t){if(t instanceof Ayce.Light)c.addLight(t),i=!0;else if(t instanceof Ayce.Object3D)i||(t.buffer=a.getBuffer(t,c)),t.calcBoundingBox(),t.calcBoundingSphere(),t.transparent?h.push(t):n.push(t);else{if(!(t instanceof Ayce.Sound))throw"Can't add to scene. Unknown type: "+typeof t;t.init(o),l.push(t)}},this.removeFromScene=function(t){if(t instanceof Ayce.Light)c.removeLight(t);else if(t instanceof Ayce.Object3D){for(e=0;e<n.length;e++)n[e]===t&&n.splice(e,1);for(e=0;e<h.length;e++)h[e]===t&&h.splice(e,1)}else{if(!(t instanceof Ayce.Sound))throw"Can't remove from scene: "+typeof t;for(e=0;e<l.length;e++)l[e]===t&&(l[e].stop(),l.splice(e,1))}},this.getCamera=function(){return r},this.setClearColor=function(t,e,i){a.clearColor.red=t,a.clearColor.green=e,a.clearColor.blue=i,a.getGL().clearColor(t,e,i,1)},this.setAmbientLight=function(t,e,i){c.ambientLight.red=t,c.ambientLight.green=e,c.ambientLight.blue=i}},Ayce.Light=function(){this.position=new Ayce.Vector3,this.color={red:1,green:1,blue:1},this.specularColor={red:1,green:1,blue:1}},Ayce.LightContainer=function(){var t=[];this.locationsArray=[],this.locationsArrayLeftEye=[],this.locationsArrayRightEye=[],this.colorsArray=[],this.specColorsArray=[],this.lightsCount=0,this.ambientLight={red:.5,green:.5,blue:.5};var e=new Ayce.Vector3;this.addLight=function(e){t.push(e),this.lightsCount=t.length},this.removeLight=function(e){var i=t.indexOf(e);-1!==i&&t.splice(i,1),this.locationsArray.splice(i,1),this.colorsArray.splice(i,1),this.specColorsArray.splice(i,1)},this.update=function(i){var r,o,a=0;if(i.useVR){for(r=i.getViewMatrix("left"),a=0;a<t.length;a++)Ayce.Vector3.prototype.copyToVector(t[a].position,e),o=r.transformVector(e),this.locationsArrayLeftEye[3*a+0]=o.x,this.locationsArrayLeftEye[3*a+1]=o.y,this.locationsArrayLeftEye[3*a+2]=o.z;for(r=i.getViewMatrix("right"),a=0;a<t.length;a++)Ayce.Vector3.prototype.copyToVector(t[a].position,e),o=r.transformVector(e),this.locationsArrayRightEye[3*a+0]=o.x,this.locationsArrayRightEye[3*a+1]=o.y,this.locationsArrayRightEye[3*a+2]=o.z}else for(r=i.getViewMatrix(),a=0;a<t.length;a++)Ayce.Vector3.prototype.copyToVector(t[a].position,e),o=r.transformVector(e),this.locationsArray[3*a+0]=o.x,this.locationsArray[3*a+1]=o.y,this.locationsArray[3*a+2]=o.z;for(a=0;a<t.length;a++)this.colorsArray[3*a+0]=t[a].color.red,this.colorsArray[3*a+1]=t[a].color.green,this.colorsArray[3*a+2]=t[a].color.blue,this.specColorsArray[3*a+0]=t[a].specularColor.red,this.specColorsArray[3*a+1]=t[a].specularColor.green,this.specColorsArray[3*a+2]=t[a].specularColor.blue;this.lightsCount=t.length}},Ayce.LightContainer.prototype={},Ayce.Buffer=function(t,e,i,r,o,a){a=a||t.TRIANGLES;var s,n,h,c,l=[],u=[],d=[];this.indices=null,this.useTexture=!1,this.useSpecularMap=!1,this.useTransparency=!1,this.texturesO3D=null,this.isSkybox=!1;var y=!1,p=!1,f=!1,g=0,x=0;this.init=function(){y=this.useTexture,p=this.useSpecularMap,f=this.useNormalMap;var a,m=0;for(g=0;g<r.length;g++)a=r[g],a[3]=i.getAttribLocation(a[0]),a[4]=m,m+=4*a[1],x+=4*a[1];for(g=0;g<o.length;g++){var v=o[g];v[4]=new Array(1+v[3].length),v[4][0]=i.getUniformLocation(v[0])}if(this.useTexture)for(i.samplerUniform=i.getUniformLocation("uSampler"),g=0;g<this.texturesO3D.length;g++)l.push(this.loadTexture(t,this.texturesO3D[g],this.isSkybox));if(this.useSpecularMap)for(this.texturesO3D=Array.isArray(e.specularMap)?e.specularMap:[e.specularMap],i.specularMapUniform=i.getUniformLocation("uSpecularMapSampler"),g=0;g<this.texturesO3D.length;g++)u.push(this.loadTexture(t,this.texturesO3D[g],this.isSkybox));if(this.useNormalMap)for(this.texturesO3D=Array.isArray(e.normalMap)?e.normalMap:[e.normalMap],i.normalMapUniform=i.getUniformLocation("uNormalMapSampler"),g=0;g<this.texturesO3D.length;g++)d.push(this.loadTexture(t,this.texturesO3D[g],this.isSkybox));for(var A=[],w=0;w<r[0][2].length/r[0][1];w++)for(g=0;g<r.length;g++)a=r[g],this.pushData(A,a[2],w,a[1]);if(n=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,new Float32Array(A),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),s=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),h=this.indices.length,t.ext){for(c=t.ext.createVertexArrayOES(),t.ext.bindVertexArrayOES(c),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s),t.bindBuffer(t.ARRAY_BUFFER,n),g=0;g<r.length;g++)a=r[g],this.setupAttribPointer(t,a[3],a[1],x,a[4]),m+=4*a[1];t.bindBuffer(t.ARRAY_BUFFER,null),t.ext.bindVertexArrayOES(null)}},this.update=function(){y&&(y=m(y,l)),p&&(p=m(p,u)),f&&(f=m(f,d))};var m=function(t,e){if(t){var i=!0;for(g=0;g<e.length;g++)if(!e[g].loaded){i=!1;break}t=!i}return t};this.render=function(){if(!(y||p||f)){if(this.useTransparency&&(t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA)),i.initShaders(),this.useTexture&&this.activateTextures(t,i.samplerUniform,l),this.useSpecularMap){for(g=0;g<u.length;g++)t.activeTexture(t.TEXTURE0+l.length+g),t.bindTexture(t.TEXTURE_2D,u[g]);t.uniform1i(i.specularMapUniform,1)}if(this.useNormalMap){for(g=0;g<d.length;g++)t.activeTexture(t.TEXTURE0+l.length+g),t.bindTexture(t.TEXTURE_2D,d[g]);t.uniform1i(i.normalMapUniform,1)}for(g=0;g<o.length;g++){var e=o[g];if(e[4][1]=e[3],e[2])for(var m=0;m<e[3].length;m++)e[4][m+1]=e[2][e[3][m]]}for(g=0;g<o.length;g++)t[o[g][1]].apply(t,o[g][4]);if(t.ext)t.ext.bindVertexArrayOES(c),t.drawElements(a,h,t.UNSIGNED_SHORT,0),t.ext.bindVertexArrayOES(null);else{for(t.bindBuffer(t.ARRAY_BUFFER,n),g=0;g<r.length;g++){var v=r[g];this.setupAttribPointer(t,v[3],v[1],x,v[4])}t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s),t.drawElements(a,h,t.UNSIGNED_SHORT,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}this.useTransparency&&t.disable(t.BLEND)}},this.dispose=function(){t.deleteBuffer(s),t.deleteBuffer(n)}},Ayce.Buffer.prototype={pushData:function(t,e,i,r){var o;for(o=0;r>o;o++)t.push(e[i*r+o])},setupAttribPointer:function(t,e,i,r,o){t.enableVertexAttribArray(e),t.vertexAttribPointer(e,i,t.FLOAT,!1,r,o)},loadedTextures:{},loadTexture:function(t,e,i){var r=t.createTexture();r.loaded=!1;var o=t.REPEAT;return(i||e.clamp)&&(o=t.CLAMP_TO_EDGE),e=e.source?e.source:e,this.loadedTextures[e]?(r.loaded=!0,this.loadedTextures[e]):(r.image=new Image,r.image.src=e,r.image.onload=function(){t.bindTexture(t.TEXTURE_2D,r),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r.image),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,o),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null),r.loaded=!0},this.loadedTextures[e]=r,r)},activateTextures:function(t,e,i){for(var r=[],o=0;o<i.length;o++)t.activeTexture(t.TEXTURE0+o),t.bindTexture(t.TEXTURE_2D,i[o]),r.push(o);t.uniform1iv(e,r)}},Ayce.BufferMulti=function(t,e,i){if(!e instanceof Ayce.Object3D)throw"Can't create buffers for "+e;var r=new Ayce.Matrix4;r.transposeUniform=!1;var o=new Ayce.Matrix4,a=new Ayce.Matrix4,s=new Ayce.Matrix3,n=new Ayce.Matrix3,h=null,c=null,l=3,u=3,d=2,y=1,p=4,f=Boolean(e.normals)&&i.lightsCount>0,g=Boolean(e.normals)&&(f||e.shader),x=Array.isArray(e.imageSrc)?e.imageSrc.length:1,m=e.isWireframe;this.transparent=e.transparent;var v=Boolean(e.geometries&&e.velocities&&e.rotationAngles&&e.lifetimes&&e.gravities&&e.gravityExps),A=[];A.push(["aVertexPosition",l,e.vertices]),e.textureCoords&&e.imageSrc&&A.push(["aTextureCoord",d,e.textureCoords]),e.textureCoords&&e.imageSrc&&e.textureIndices&&x>1&&A.push(["aTextureIndex",y,e.textureIndices]),e.colors&&A.push(["aVertexColor",p,e.colors]),g&&A.push(["aVertexNormal",u,e.normals]),e.shaderAttributes&&Array.prototype.push.apply(A,e.shaderAttributes);var w={transposeUniform:!1,data:[]},M={time:0,startTime:Date.now()},b={useTexture:Boolean(e.textureCoords&&e.imageSrc),useLighting:f,useMultiTex:Boolean(e.textureIndices),normalMatrix:new Ayce.Matrix3,useSpecularMap:Boolean(e.specularMap),useNormalMap:Boolean(e.normalMap)},S=[];S.push(["uPMatrix","uniformMatrix4fv",w,["transposeUniform","data"]]),S.push(["uMVMatrix","uniformMatrix4fv",r,["transposeUniform","data"]]),g&&(b.normalMatrix.transposeUniform=!1,S.push(["uNMatrix","uniformMatrix3fv",b.normalMatrix,["transposeUniform","data"]])),f&&(S.push(["uAmbientColor","uniform3f",i.ambientLight,["red","green","blue"]]),S.push(["uLightIndex","uniform1f",i,["lightsCount"]]),S.push(["uPointLightingLocations","uniform3fv",i,["locationsArray"]]),S.push(["uPointLightingColors","uniform3fv",i,["colorsArray"]]),S.push(["uSpecularColors","uniform3fv",i,["specColorsArray"]]),S.push(["uShininess","uniform1f",e,["shininess"]])),v&&S.push(["uTime","uniform1f",M,["time"]]),e.shaderUniforms&&Array.prototype.push.apply(S,e.shaderUniforms);var C=null,R=null,T="";if(e.shader)C=Ayce.XMLLoader.getSourceSynch(e.shader+".vert"),R=Ayce.XMLLoader.getSourceSynch(e.shader+".frag"),T="A"+e.shader,e.logVertexShader&&console.log(C),e.logFragmentShader&&console.log(R);else{var V=new Ayce.ShaderGenerator;f&&(V.useVertexLighting=Boolean(e.normals&&!e.useFragmentLighting),V.lightsCount=i.lightsCount,V.useFragmentLighting=Boolean(e.normals&&e.useFragmentLighting),V.useSpecularLighting=e.useSpecularLighting),V.useNormals=g,V.useColor=Boolean(e.colors),V.texturesCount=Array.isArray(e.imageSrc)?e.imageSrc.length:1,V.useTexture=Boolean(e.imageSrc&&e.textureCoords),V.useSpecularMap=Boolean(e.specularMap&&e.useSpecularLighting),V.useNormalMap=Boolean(e.normalMap),V.isParticleSystem=v,V.init(),C=V.vertexShader,R=V.fragmentShader,T="B"+V.useNormals+V.lightsCount+V.texturesCount+V.useVertexLighting+V.useFragmentLighting+V.useTexture+V.useColor+V.useSpecularMap+V.useNormalMap+V.isParticleSystem,e.logVertexShader&&console.log(C.replace(/;/g,";\n").replace(/{/g,"{\n").replace(/}/g,"}\n")),e.logFragmentShader&&console.log(R.replace(/;/g,";\n").replace(/{/g,"{\n").replace(/}/g,"}\n"))}var z=null;t.shaders[T]?z=t.shaders[T]:(z=new Ayce.Shader(t,C,R),t.shaders[T]=z);var P=m?t.LINES:void 0,E=new Ayce.Buffer(t,e,z,A,S,P);if(e.twoFaceTransparency){var L=e.indices;L=L.slice().reverse().concat(L),E.indices=new Uint16Array(L)}else E.indices=new Uint16Array(e.indices);E.useTexture=Boolean(e.textureCoords&&e.imageSrc),E.useSpecularMap=Boolean(e.textureCoords&&e.specularMap),E.useNormalMap=Boolean(e.textureCoords&&e.normalMap),E.useTransparency=e.transparent,E.texturesO3D=Array.isArray(e.imageSrc)?e.imageSrc:[e.imageSrc],E.isSkybox=Boolean(e.isSkybox),E.init();var D=new Ayce.Matrix4;this.update=function(t){Ayce.Matrix4.prototype.copyToMatrix(e.modelMatrix,r),r.apply(t.getViewMatrix()),Ayce.Matrix4.prototype.copyToMatrix(r,D),D.invert(),D.transpose(),D.getMatrix3(b.normalMatrix),w.data=t.getPerspectiveMatrix().data,M=Date.now()-M.startTime,E.update()},this.render=function(){e.visible&&E.render()},this.updateVR=function(t){Ayce.Matrix4.prototype.copyToMatrix(e.modelMatrix,o),o.apply(t.getViewMatrix("left")),Ayce.Matrix4.prototype.copyToMatrix(o,D),D.invert(),D.transpose(),D.getMatrix3(s),Ayce.Matrix4.prototype.copyToMatrix(e.modelMatrix,a),a.apply(t.getViewMatrix("right")),Ayce.Matrix4.prototype.copyToMatrix(a,D),D.invert(),D.transpose(),D.getMatrix3(n),h=t.getPerspectiveMatrix("left"),c=t.getPerspectiveMatrix("right"),E.update()},this.renderVR=function(t){e.visible&&("left"===t?(r.data=o.data,b.normalMatrix.data=s.data,w.data=h.data,i.locationsArray=i.locationsArrayLeftEye):"right"===t&&(r.data=a.data,b.normalMatrix.data=n.data,w.data=c.data,i.locationsArray=i.locationsArrayRightEye),E.render())},this.dispose=function(){E.dispose()}},Ayce.BufferMulti.prototype={},Ayce.Shader=function(t,e,i){var r=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))return alert("ShaderVert: \n"+t.getShaderInfoLog(r)),null;var o=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(o,i),t.compileShader(o),!t.getShaderParameter(r,t.COMPILE_STATUS))return alert("ShaderFrag: \n"+t.getShaderInfoLog(o)),null;var a=t.createProgram();t.attachShader(a,r),t.attachShader(a,o),t.linkProgram(a),t.getProgramParameter(a,t.LINK_STATUS)||alert("Could not initialise shaders"),t.validateProgram(a),this.initShaders=function(){t.useProgram(a)},this.getAttribLocation=function(e){return t.getAttribLocation(a,e)},this.getUniformLocation=function(e){return t.getUniformLocation(a,e)}},Ayce.Shader.prototype={},Ayce.ShaderGenerator=function(){this.lightsCount=4,this.texturesCount=1,this.useNormals=!1,this.useVertexLighting=!1,this.useFragmentLighting=!1,this.useSpecularLighting=!1,this.useTexture=!1,this.useColor=!1,this.useSpecularMap=!1,this.useNormalMap=!1,this.isParticleSystem=!1;var t=!1;this.vertexShader="",this.fragmentShader="",this.init=function(){this.useTexture||(this.useSpecularMap=!1,this.useNormalMap=!1),t=Boolean(this.texturesCount>1),this.vertexShader+="attribute vec3 aVertexPosition;",this.useColor&&(this.vertexShader+="attribute vec4 aVertexColor;"),this.useTexture&&(this.vertexShader+="attribute vec2 aTextureCoord;"),this.useNormals&&(this.vertexShader+="attribute vec3 aVertexNormal;"),this.isParticleSystem&&(this.vertexShader+="attribute vec3 aGeometryPosition;attribute vec3 aVertexVelocity;attribute vec3 aVertexRotation;attribute float aLifetime;attribute float aGravity;attribute float aGravityExponent;"),this.useTexture&&t&&(this.vertexShader+="attribute float aTextureIndex;"),this.vertexShader+="uniform mat4 uMVMatrix;uniform mat4 uPMatrix;",this.isParticleSystem&&(this.vertexShader+="uniform float uTime;"),this.useNormals&&(this.vertexShader+="uniform mat3 uNMatrix;"),this.useVertexLighting&&(this.vertexShader+="uniform vec3 uAmbientColor;uniform vec3 uPointLightingLocations["+this.lightsCount+"];uniform vec3 uPointLightingColors["+this.lightsCount+"];uniform float uLightIndex;",this.useSpecularLighting&&(this.vertexShader+="uniform float uShininess;"),this.useSpecularLighting&&(this.vertexShader+="uniform vec3 uSpecularColors["+this.lightsCount+"];")),this.useColor&&(this.vertexShader+="varying vec4 vColor;"),this.useTexture&&(this.vertexShader+="varying vec2 vTextureCoord;"),this.useVertexLighting?this.vertexShader+="varying vec3 vLightWeighting;":this.useFragmentLighting&&(this.vertexShader+="varying vec3 vTransformedNormal;varying vec4 vPosition;"),this.useTexture&&t&&(this.vertexShader+="varying float vTextureIndex;"),this.vertexShader+="void main(void) {",this.isParticleSystem?this.vertexShader+="float factor;if(aLifetime==0.0){factor = uTime;}else{factor = mod(uTime, aLifetime);}vec3 distance = aGeometryPosition - aVertexPosition;float xAngle = aVertexRotation.x*factor;float yAngle = aVertexRotation.y*factor;float zAngle = aVertexRotation.z*factor;mat4 xRotation = mat4(1.0,	 		 0.0,			 0.0,			 0.0,0.0,			 cos(xAngle),	 sin(xAngle),	 0.0,0.0,			-sin(xAngle),	 cos(xAngle),	 0.0,0.0,	 		 0.0,			 0.0,			 1.0);mat4 yRotation = mat4(cos(yAngle),	 0.0,			-sin(yAngle),	 0.0,0.0,			 1.0,	 		 0.0,			 0.0,sin(yAngle),	 0.0,	 		 cos(yAngle),	 0.0,0.0,			 0.0,	 		 0.0,			 1.0);mat4 zRotation = mat4(cos(zAngle),	 sin(zAngle),	 0.0,			 0.0,-sin(zAngle),	 cos(zAngle),	 0.0,			 0.0,0.0,			 0.0,			 1.0,			 0.0,0.0,			 0.0,			 0.0,			 1.0);vec4 position = vec4(aGeometryPosition, 1.0)*xRotation*yRotation*zRotation;position = position-vec4(distance, 0.0);vec3 velocity = aVertexVelocity+vec3(0.0, aGravity*pow(factor, aGravityExponent),0.0);position = uMVMatrix * vec4(position.xyz+velocity*factor, 1.0);":this.useFragmentLighting?this.useFragmentLighting&&(this.vertexShader+="vPosition = uMVMatrix * vec4(aVertexPosition, 1.0);vec4 position = vPosition;"):this.vertexShader+="vec4 position = uMVMatrix * vec4(aVertexPosition, 1.0);",this.vertexShader+="gl_Position = uPMatrix * position;",this.useTexture&&t&&(this.vertexShader+="vTextureIndex = aTextureIndex;"),this.useTexture&&(this.vertexShader+="vTextureCoord = aTextureCoord;"),this.useColor&&(this.vertexShader+="vColor = aVertexColor;"),this.useVertexLighting?(this.vertexShader+="vLightWeighting = uAmbientColor;",this.vertexShader+=this.isParticleSystem?"vec3 transformedNormal = uNMatrix * (vec4(aVertexNormal, 1.0) * xRotation * yRotation * zRotation).xyz;":"vec3 transformedNormal = uNMatrix * aVertexNormal;",this.vertexShader+="vec3 normal = normalize(transformedNormal);vec3 eyeDirection = normalize(-position.xyz);"+this.getVertexLightingWeightCalcArrayVertex(this.lightsCount,this.useSpecularLighting)):this.useFragmentLighting&&(this.vertexShader+=this.isParticleSystem?"vTransformedNormal = uNMatrix * (vec4(aVertexNormal, 1.0) * xRotation * yRotation * zRotation).xyz;":"vTransformedNormal = uNMatrix * aVertexNormal;"),this.vertexShader+="}",this.fragmentShader+="precision mediump float;",this.useVertexLighting?this.fragmentShader+="varying vec3 vLightWeighting;":this.useFragmentLighting&&(this.fragmentShader+="varying vec3 vTransformedNormal;varying vec4 vPosition;uniform vec3 uAmbientColor;uniform vec3 uPointLightingLocations["+this.lightsCount+"];uniform vec3 uPointLightingColors["+this.lightsCount+"];uniform float uLightIndex;",this.useSpecularLighting&&(this.fragmentShader+="uniform float uShininess;"),this.useSpecularLighting&&(this.fragmentShader+="uniform vec3 uSpecularColors["+this.lightsCount+"];")),this.useColor&&(this.fragmentShader+="varying vec4 vColor;"),this.useTexture&&(this.fragmentShader+="varying vec2 vTextureCoord;",this.fragmentShader+=t?"varying float vTextureIndex;uniform sampler2D uSampler["+this.texturesCount+"];":"uniform sampler2D uSampler;"),this.useSpecularMap&&(this.fragmentShader+="uniform sampler2D uSpecularMapSampler;"),this.useNormalMap&&(this.fragmentShader+="uniform sampler2D uNormalMapSampler;"),this.fragmentShader+="void main(void) {vec4 fragmentColor;",this.useFragmentLighting&&(this.fragmentShader+="vec3 lightWeighting = uAmbientColor;vec3 normal = normalize(vTransformedNormal);vec3 eyeDirection = normalize(-vPosition.xyz);"+this.getFragmentLightingWeightCalcArrayVertex(this.lightsCount,this.useSpecularMap,this.useNormalMap,this.useSpecularLighting)),this.useTexture&&t?(this.fragmentShader+="if (vTextureCoord.x > -0.5 && vTextureCoord.y > -0.5) {vec4 tex = vec4(0.0);float i = vTextureIndex;"+this.getTextureCalcArray(this.texturesCount)+"fragmentColor = tex;} else {",this.fragmentShader+=this.useColor?"fragmentColor = vColor;":"fragmentColor = vec4(0.5, 0.5, 0.5, 1.0);",this.fragmentShader+="}"):this.fragmentShader+=this.useTexture?"fragmentColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));":this.useColor?"fragmentColor = vColor;":"fragmentColor = vec4(0.5, 0.5, 0.5, 1.0);",this.fragmentShader+=this.useVertexLighting?"gl_FragColor = vec4(fragmentColor.rgb * vLightWeighting, fragmentColor.a);":this.useFragmentLighting?"gl_FragColor = vec4(fragmentColor.rgb * lightWeighting, fragmentColor.a);":"gl_FragColor = fragmentColor;",this.fragmentShader+="}"}},Ayce.ShaderGenerator.prototype={getVertexLightingWeightCalcArrayVertex:function(t,e){for(var i="",r=0;t>r;r++)i+="if(uLightIndex-"+(r+1)+".0>-0.01){vec3 lightDirection = normalize(uPointLightingLocations["+r+"] - position.xyz);vec3 reflectionDirection = reflect(-lightDirection, normal);float diffuseLightWeighting = max(dot(normalize(transformedNormal), lightDirection), 0.0);",i+=e?"float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uShininess);vLightWeighting += uPointLightingColors["+r+"] * diffuseLightWeighting + uSpecularColors["+r+"] * specularLightWeighting;":"vLightWeighting += uPointLightingColors["+r+"] * diffuseLightWeighting;",i+="}";return i},getFragmentLightingWeightCalcArrayVertex:function(t,e,i,r){for(var o="",a=0;t>a;a++)o+="if(uLightIndex-"+(a+1)+".0>-0.01){vec3 lightDirection = normalize(uPointLightingLocations["+a+"] - vPosition.xyz);vec3 reflectionDirection = reflect(-lightDirection, normal);",e?o+="float shininess = texture2D(uSpecularMapSampler, 255.0-vec2(vTextureCoord.s, vTextureCoord.t)).r * 255.0 * uShininess;float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), shininess);":r&&(o+="float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uShininess);"),o+=i?"vec3 normalMap = texture2D(uNormalMapSampler, vec2(vTextureCoord.s, vTextureCoord.t)).rgb*2.0-1.0;float diffuseLightWeighting = max(dot(normalize(normalMap), lightDirection), 0.0);":"float diffuseLightWeighting = max(dot(normalize(vTransformedNormal), lightDirection), 0.0);",o+=r?"lightWeighting += uPointLightingColors["+a+"] * diffuseLightWeighting + uSpecularColors["+a+"] * specularLightWeighting;":"lightWeighting += uPointLightingColors["+a+"] * diffuseLightWeighting;",o+="}";return o},getTextureCalcArray:function(t){for(var e="",i=0;t>i;i++)0!==i&&(e+="else "),e+="if(i-"+i+".0 < 0.01){tex = texture2D(uSampler["+i+"], vec2(vTextureCoord.s, vTextureCoord.t));}";return e}},Ayce.Sound=function(t){var e=this;this.soundLoaded=!1,this.position=new Ayce.Vector3(0,0,0),this.orientationFront=new Ayce.Vector3(0,0,0),this.orientationUp=new Ayce.Vector3(0,1,0),this.listenerPosition=new Ayce.Vector3(0,0,0),this.listenerOrientationFront=new Ayce.Vector3(0,0,0),this.listenerOrientationUp=new Ayce.Vector3(0,1,0),this.loop=!0,this.is3D=!0,this.volume=1,this.isPlaying=!1;var i,r,o,a,s,n,h=0;this.init=function(r){i=r.audioContext;var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="arraybuffer",o.onload=function(){i.decodeAudioData(this.response,function(t){a=t,e.soundLoaded=!0},function(){alert("Decoding the audio buffer failed")})},o.send()},this.update=function(){e.soundLoaded&&e.isPlaying&&(e.is3D&&(r.setPosition(e.position.x,e.position.y,e.position.z),r.panningModel="HRTF",r.distanceModel="linear",i.listener.setOrientation(-e.listenerOrientationFront.x,-e.listenerOrientationFront.y,e.listenerOrientationFront.z,e.listenerOrientationUp.x,e.listenerOrientationUp.y,-e.listenerOrientationUp.z),i.listener.setPosition(-e.listenerPosition.x,-e.listenerPosition.y,-e.listenerPosition.z)),s.gain.value=this.volume,o.loop=this.loop)},this.play=function(){e.soundLoaded?(o=i.createBufferSource(),o.buffer=a,s=i.createGain(),this.is3D?(r=i.createPanner(),o.connect(r),r.connect(s),r.panningModel="HRTF",r.distanceModel="linear"):o.connect(s),s.connect(i.destination),e.update(),o.start(h),n=Date.now(),this.isPlaying=!0):console.error("The audio file is not done loading.")},this.pause=function(){e.soundLoaded?(o.stop(),this.isPlaying=!1,h=(Date.now()-n)%Math.floor(1e3*a.duration)/1e3):console.error("The audio file is not done loading.")},this.stop=function(){e.soundLoaded?(o.stop(),this.isPlaying=!1,h=0):console.error("The audio file is not done loading.")}},Ayce.AudioContext=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext||null,window.AudioContext?this.audioContext=new AudioContext:(this.audioContext={},console.error("AudioContext is not supported by your browser"))},Ayce.Camera=function(t){var e=this;this.useVR=!1;var i=!1,r=new Ayce.Vector3,o=new Ayce.Quaternion,a=new Ayce.Matrix4,s=new Ayce.Matrix4,n=new Ayce.Matrix4,h=new Ayce.Matrix4,c=null,l=null,u=null;this.fieldOfView=60,this.nearPlane=.1,this.farPlane=200,this.width=1,this.height=1,this.isOrtho=!1;var d=new Ayce.Vector3;this.update=function(){t.update(),r=t.getGlobalPosition(),o=t.getGlobalRotation().getConjugate(),y()},this.updateProjectionMatrix=function(){var e=this.width/this.height;t&&t.isInputVR()&&t.cameraProperties.eyeFOVL?(l=Ayce.Matrix4.makeVRPerspective(t.cameraProperties.eyeFOVL,this.nearPlane,this.farPlane),u=Ayce.Matrix4.makeVRPerspective(t.cameraProperties.eyeFOVR,this.nearPlane,this.farPlane)):c=this.isOrtho?Ayce.Matrix4.makeOrthoPerspective(-1,1,1,-1,.5,1.5):Ayce.Matrix4.makePerspective(this.fieldOfView,e,this.nearPlane,this.farPlane)},this.setFullscreen=function(e,r){if(i!==e){if(i=e,!e)return void(document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen());var o={};void 0!==t.cameraProperties.vrDevice&&(o.vrDisplay=t.cameraProperties.vrDevice,o.vrTimewarp=!0),r.requestFullscreen?r.requestFullscreen(o):r.msRequestFullscreen?r.msRequestFullscreen(o):r.mozRequestFullScreen?r.mozRequestFullScreen(o):r.webkitRequestFullscreen&&r.webkitRequestFullscreen(o)}};var y=function(){if(e.useVR){var i=t.cameraProperties.eyeTranslationL,c=t.cameraProperties.eyeTranslationR;n.identity(),n.applyTranslation(-r.x,-r.y,-r.z),o.toRotationMatrix(a),n.apply(a),n.applyTranslation(-i,0,0),h.identity(),h.applyTranslation(-r.x,-r.y,-r.z),o.toRotationMatrix(a),h.apply(a),h.applyTranslation(-c,0,0)}else s.identity(),s.applyTranslation(-r.x,-r.y,-r.z),o.toRotationMatrix(a),s.apply(a)};this.getManager=function(){return t},this.getViewMatrix=function(t){return"left"===t?n:"right"===t?h:s},this.getPerspectiveMatrix=function(t){return"left"===t&&null!==l?l:"right"===t&&null!==u?u:c},this.getEyeTranslation=function(e){return"left"===e?t.cameraProperties.eyeTranslationL:"right"===e?t.cameraProperties.eyeTranslationR:null},this.getForwardVector=function(){return e.useVR?(d.x=-n.data[2],d.y=-n.data[6],d.z=-n.data[10],d):(d.x=-s.data[2],d.y=-s.data[6],d.z=-s.data[10],d)},this.isFullscreen=function(){return i}},Ayce.Camera.prototype={},Ayce.CameraManager=function(){var t=this,e=new Ayce.Vector3,i=new Ayce.Quaternion;this.cameraProperties={vrDevice:null,eyeTranslationL:-.03,eyeTranslationR:.03,eyeFOVR:90,renderRectWidth:null,renderRectHeight:null},this.modifiers=[];var r=!1,o=function(e){var i=e[0],r=e[1];t.cameraProperties.vrDevice=vrDevice,t.cameraProperties.eyeTranslationL=i.eyeTranslation.x,t.cameraProperties.eyeTranslationR=r.eyeTranslation.x,t.cameraProperties.eyeFOVL=i.recommendedFieldOfView,t.cameraProperties.eyeFOVR=r.recommendedFieldOfView;var o=i.renderRect,a=r.renderRect;t.cameraProperties.renderRectWidth=a.x+a.width,t.cameraProperties.renderRectHeight=Math.max(o.y+o.height,a.y+a.height)};this.update=function(){var t;for(t=0;t<this.modifiers.length;t++)this.modifiers[t].update(this.getGlobalRotation().getConjugate());for(e.nullVector(),i.reset(),t=0;t<this.modifiers.length;t++){if(!r&&this.modifiers[t]instanceof Ayce.WebVR){var a=this.modifiers[t].getHMDData();null!==a&&(o(a),r=!0)}i.multiply(i,this.modifiers[t].getOrientation());var s=this.modifiers[t].getPosition();e.add(s.x,s.y,s.z)}},this.getGlobalPosition=function(){return e},this.getGlobalRotation=function(){return i},this.clearModifiers=function(){this.modifiers=[]},this.isInputVR=function(){for(var t=0;t<this.modifiers.length;t++)if(this.modifiers[t]instanceof Ayce.WebVR)return!0;return!1}},Ayce.CameraManager.prototype={},Ayce.CameraModifier=function(){this.position=new Ayce.Vector3,this.orientation=new Ayce.Quaternion,this.update=function(){},this.getOrientation=function(){return this.orientation},this.getPosition=function(){return this.position},this.getHMDData=function(){return null}},Ayce.Cardboard=function(){Ayce.CameraModifier.call(this);var t=new Ayce.Quaternion,e=function(t){return t*Math.PI/180};this.update=function(){var i=e(-Ayce.SensorsHandler.getRoll()+180),r=e(-Ayce.SensorsHandler.getPitch()),o=e(Ayce.SensorsHandler.getYaw()+90),a=Math.cos(i/2),s=Math.cos(r/2),n=Math.cos(o/2),h=Math.sin(i/2),c=Math.sin(r/2),l=Math.sin(o/2);t.x=h*c*n+a*s*l,t.y=h*s*n+a*c*l,t.z=-(a*c*n-h*s*l),t.w=a*s*n-h*c*l},this.getOrientation=function(){return t}},Ayce.Cardboard.prototype=new Ayce.CameraModifier,Ayce.WebVR=function(){var t=new Ayce.Vector3,e=new Ayce.Quaternion,i=new Ayce.Quaternion,r=new Ayce.Vector3;this.getHMDData=function(){return Ayce.HMDHandler.getHMDData()},this.update=function(o){Ayce.KeyboardHandler.isKeyDown("R")&&Ayce.HMDHandler.resetSensor();var a=Ayce.HMDHandler.getPositionalData();a&&(a.position&&(t.x=a.position.x,t.y=a.position.y,t.z=a.position.z,t.w=a.position.w),e.x=a.orientation.x,e.y=a.orientation.y,e.z=a.orientation.z,e.w=a.orientation.w),t=i.multiply(o,e.getConjugate()).rotatePoint(r),e=e.getConjugate()},this.getPosition=function(){return t},this.getOrientation=function(){return e}},Ayce.WebVR.prototype=new Ayce.CameraModifier,Ayce.MouseKeyboard=function(t,e){var i=.2,r=new Ayce.Vector3,o=new Ayce.Quaternion;t.requestPointerLock=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock,document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock;var a=new Ayce.Vector3,s=Date.now(),n=new Ayce.Quaternion,h=new Ayce.Quaternion,c=new Ayce.Vector3(1,0,0),l=new Ayce.Vector3(0,1,0),u=new Ayce.Vector2(0,0),d=0,y=0;this.update=function(t){Ayce.MouseHandler.setNewFrameTrue();var e=(Date.now()-s)/1e3,p=5,f=null;a.x=0,a.y=0,a.z=0,Ayce.KeyboardHandler.isKeyDown("W")&&(f=a.add(0,0,-1)),Ayce.KeyboardHandler.isKeyDown("S")&&(f=a.add(0,0,1)),Ayce.KeyboardHandler.isKeyDown("D")&&(f=a.add(1,0,0)),Ayce.KeyboardHandler.isKeyDown("A")&&(f=a.add(-1,0,0)),f&&(f=t.getRotatedPoint(f),r.add(f.x*p*e,f.y*p*e,f.z*p*e)),s=Date.now(),u=Ayce.MouseHandler.getMovement(),d+=u.x,y+=u.y,y*i>90?y=90/i:-90>y*i&&(y=-90/i),h.reset(),h.fromAxisAngle(l,d*i*Math.PI/180),n.reset(),n.fromAxisAngle(c,y*i*Math.PI/180),n.multiply(n,h),o=n
},this.getPosition=function(){return r},this.getOrientation=function(){return o},e.onclick=function(){t.requestPointerLock()},this.isMouseLocked=function(){return document.pointerLockElement===t||document.mozPointerLockElement===t||document.webkitPointerLockElement===t}},Ayce.MouseKeyboard.prototype=new Ayce.CameraModifier,Ayce.Gamepad=function(){var t=this;this.gamepads=[];var e,i=0,r=0,o=.3,a=6,s=3,n=new Ayce.Vector3,h=new Ayce.Vector3;this.getPosition=function(i){var r=.02;for(h.nullVector(),t.gamepads=Ayce.GamepadHandler.getGamepads(),e=0;e<t.gamepads.length;e++)if(t.gamepads[e]){var s=0,c=0;(t.gamepads[e].axes[0]>o||t.gamepads[e].axes[0]<-o)&&(s=t.gamepads[e].axes[0]*a),(t.gamepads[e].axes[1]>o||t.gamepads[e].axes[1]<-o)&&(c=t.gamepads[e].axes[1]*a),h.add(s,0,c)}return h=i.getConjugate().getRotatedPoint(h),n.add(h.x*r,h.y*r,h.z*r),n};var c=new Ayce.Quaternion,l=new Ayce.Quaternion,u=new Ayce.Vector3(1,0,0),d=new Ayce.Vector3(0,1,0);this.getOrientation=function(){for(c.reset(),t.gamepads=Ayce.GamepadHandler.getGamepads(),e=0;e<t.gamepads.length;e++)t.gamepads[e]&&((t.gamepads[e].axes[2]>o||t.gamepads[e].axes[2]<-o)&&(i+=t.gamepads[e].axes[2]*s),(t.gamepads[e].axes[3]>o||t.gamepads[e].axes[3]<-o)&&(r+=t.gamepads[e].axes[3]*s),l.reset(),l.fromAxisAngle(d,i*Math.PI/180),c.reset(),c.fromAxisAngle(u,r*Math.PI/180),c.multiply(c,l));return c}},Ayce.Gamepad.prototype=new Ayce.CameraModifier,Ayce.Object3D=function(){var t=this;this.position=new Ayce.Vector3,this.rotation=new Ayce.Quaternion;var e=new Ayce.Vector3,i=new Ayce.Quaternion,r=new Ayce.Matrix4;this.scale=new Ayce.Vector3(1,1,1),this.modelMatrix=new Ayce.Matrix4,this.parent=null,this.parentPositionWeight=new Ayce.Vector3(1,1,1),this.parentRotationWeight=new Ayce.Vector3(1,1,1),this.vertices=null,this.normals=null,this.textureCoords=null,this.textureIndices=null,this.colors=null,this.indices=null,this.transparent=!1,this.isWireframe=!1,this.twoFaceTransparency=!1,this.buffer=null,this.imageSrc=null,this.shader=null,this.shaderAttributes=null,this.shaderUniforms=null,this.useFragmentLighting=!1,this.specularMap=null,this.normalMap=null,this.useSpecularLighting=!1,this.shininess=1,this.soundFile=null,this.sound=null,this.isSkybox=!1,this.boundingBox=null,this.boundingSphere=null,this.gravity=null,this.velocity=new Ayce.Vector3,this.collision=!1,this.useBoundingSphere=!1,this.collideWith=null,this.onCollision=null;var o=Ayce.Timer.prototype.getCurrentTimeMs();this.onUpdate=null,this.renderPriority=null,this.visible=!0,this.logVertexShader=!1,this.logFragmentShader=!1,this.calcBoundingBox=function(){this.vertices||console.error("No Vertices set. Can't calc Bounding Box."),n();for(var t=this.vertices[0],r=this.vertices[0],o=this.vertices[1],a=this.vertices[1],s=this.vertices[2],h=this.vertices[2],c=0;c<this.vertices.length;c+=3){var l=this.vertices[c+0],u=this.vertices[c+1],d=this.vertices[c+2];l>r&&(r=l),t>l&&(t=l),u>a&&(a=u),o>u&&(o=u),d>h&&(h=d),s>d&&(s=d)}var y=r-t,p=a-o,f=h-s;this.boundingBox=new Ayce.Geometry.Box(y,p,f),this.boundingBox.position=e,this.boundingBox.offset=new Ayce.Vector3(t,o,s),this.boundingBox.rotation=i,this.boundingBox.scale=this.scale},this.calcBoundingSphere=function(){n();var t,r,o,a,s=this.scale,h=this.vertices[0]*s.x,c=this.vertices[0]*s.x,l=this.vertices[1]*s.y,u=this.vertices[1]*s.y,d=this.vertices[2]*s.z,y=this.vertices[2]*s.z;for(t=0;t<this.vertices.length;t+=3)r=this.vertices[t+0]*s.x,o=this.vertices[t+1]*s.y,a=this.vertices[t+2]*s.z,r>c&&(c=r),h>r&&(h=r),o>u&&(u=o),l>o&&(l=o),a>y&&(y=a),d>a&&(d=a);var p=new Ayce.Vector3((c+h)/2,(u+l)/2,(y+d)/2),f=0;for(t=0;t<this.vertices.length;t+=3){r=this.vertices[t+0]*this.scale.x,o=this.vertices[t+1]*this.scale.y,a=this.vertices[t+2]*this.scale.z;var g=Ayce.Vector3.prototype.distance(p,new Ayce.Vector3(r,o,a));g>f&&(f=g)}this.boundingSphere=new Ayce.Geometry.Sphere(f),this.boundingSphere.position=e,this.boundingSphere.offset=p,this.boundingSphere.rotation=i},this.update=function(){var t=Ayce.Timer.prototype.getCurrentTimeMs(),a=t-o,s=this.gravity,h=this.velocity;if((s||0!==h.x||0!==h.y||0!==h.z)&&a>0){var c=a/1e3;if(s&&((s.x>0&&h.x<s.x||s.x<0&&h.x>s.x)&&(h.x=h.x+s.x*c),(s.y>0&&h.y<s.y||s.y<0&&h.y>s.y)&&(h.y=h.y+s.y*c),(s.z>0&&h.z<s.z||s.z<0&&h.z>s.z)&&(h.z=h.z+s.z*c)),this.position.x+=h.x*c,this.position.y+=h.y*c,this.position.z+=h.z*c,n(),this.collision&&this.collideWith)for(var l=0;l<this.collideWith.length;l++){var u=this.collideWith[l],d=this.boundingSphere.position.x+this.boundingSphere.offset.x-(u.boundingSphere.position.x+u.boundingSphere.offset.x),y=this.boundingSphere.position.y+this.boundingSphere.offset.y-(u.boundingSphere.position.y+u.boundingSphere.offset.y),p=this.boundingSphere.position.z+this.boundingSphere.offset.z-(u.boundingSphere.position.z+u.boundingSphere.offset.z),f=Math.sqrt(d*d+y*y+p*p),g=this.boundingSphere.r+u.boundingSphere.r;if(!(f>1.3*g)){var x;if(x=u.useBoundingSphere&&this.useBoundingSphere?Ayce.Geometry.prototype.sphereSphereCollision(this.boundingSphere,u.boundingSphere):u.useBoundingSphere?Ayce.Geometry.prototype.boxSphereCollision(this.boundingBox,u.boundingSphere,!0):this.useBoundingSphere?Ayce.Geometry.prototype.boxSphereCollision(u.boundingBox,this.boundingSphere):Ayce.Geometry.prototype.boxBoxCollision(this.boundingBox,u.boundingBox),x&&(this.position.subtract(x.x,x.y,x.z),this.onCollision)){var m={collisionWith:u,collisionVector:x.negate()};this.onCollision(m)}}}}o=t,n(),this.modelMatrix.identity(),this.modelMatrix.applyScale(this.scale.x,this.scale.y,this.scale.z),i.toRotationMatrix(r),this.modelMatrix.apply(r),this.modelMatrix.applyTranslation(e.x,e.y,e.z),this.onUpdate&&this.onUpdate()};var a=new Ayce.Vector3,s=new Ayce.Quaternion,n=function(){if(t.parent){var r=t.parent.getGlobalRotation(),o=t.parentRotationWeight;i.x=r.x*o.x,i.y=r.y*o.y,i.z=r.z*o.z,i.w=r.w,Ayce.Quaternion.prototype.copyToQuaternion(i,s),i.getConjugate(s),i.normalize(),i.multiply(t.rotation,i);var n=t.parent.getGlobalPosition(),h=t.parentPositionWeight;a.x=t.position.x,a.y=t.position.y,a.z=t.position.z,s.rotatePoint(a),e.x=n.x*h.x+a.x,e.y=n.y*h.y+a.y,e.z=n.z*h.z+a.z}else Ayce.Vector3.prototype.copyToVector(t.position,e),Ayce.Quaternion.prototype.copyToQuaternion(t.rotation,i)};this.getGlobalPosition=function(){return e},this.getGlobalRotation=function(){return i}},Ayce.Object3D.prototype={addShaderAttribute:function(t,e,i){this.shaderAttributes||(this.shaderAttributes=[]),this.shaderAttributes.push([t,e,i])},addShaderUniform:function(t,e,i,r){this.shaderUniforms||(this.shaderUniforms=[]),this.shaderUniforms.push([t,e,i,r])}},Ayce.OBJLoader=function(t){for(var e=/(.*[\/|\\])(.*)/,i=e.exec(t)[1],r=e.exec(t)[2],o=Ayce.XMLLoader.getSourceSynch(i+r),a=this.getMtlName(o),s=Ayce.XMLLoader.getSourceSynch(i+a),n=this.readObj(o),h=a?this.readMtl(s):null,c=[],l=0;l<n.length;l++){var u=this.createO3DFromOBJ(n[l],h,i),d=n[l].name;c.push(u),c[d]=u}return c},Ayce.OBJLoader.prototype={readObj:function(t){var e=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,i=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,r=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,o=/f( +-?\d+)( +-?\d+)( +-?\d+)( +-?\d+)?/,a=/f( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))?/,s=/f( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))?/,n=/f( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))?/,h=[],c={};c.name="",c.vertices=[],c.normals=[],c.uvs=[],c.faces=[];for(var l,u=function(t,e,i){if(void 0!==t[3])throw"obj quad rendering not supported";for(var r=[],o=0;3>o;o++){var a=t[o],s=e?e[o]:void 0,n=i?i[o]:void 0;r.push([a,s,n])}r.push(l),c.faces.push(r)},d=t.split("\n"),y=0;y<d.length;y++){var p=d[y];p=p.trim();var f;0!==p.length&&"#"!==p.charAt(0)&&(null!==(f=e.exec(p))?c.vertices.push([parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3])]):null!==(f=i.exec(p))?c.normals.push([parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3])]):null!==(f=r.exec(p))?c.uvs.push([parseFloat(f[1]),parseFloat(f[2])]):null!==(f=o.exec(p))?u([f[1],f[2],f[3],f[4]]):null!==(f=a.exec(p))?u([f[2],f[5],f[8],f[11]],[f[3],f[6],f[9],f[12]]):null!==(f=s.exec(p))?u([f[2],f[6],f[10],f[14]],[f[3],f[7],f[11],f[15]],[f[4],f[8],f[12],f[16]]):null!==(f=n.exec(p))?u([f[2],f[5],f[8],f[11]],void 0,[f[3],f[6],f[9],f[12]]):/^o /.test(p)||/^g /.test(p)?(c.faces.length>0&&(c.faces=this.getCorrectIndices(c.faces)),c.faces.length>0&&h.push(c),c={},c.name=p.substring(2).trim(),c.vertices=[],c.normals=[],c.uvs=[],c.faces=[]):/^g /.test(p)||/^mtllib /.test(p)||(/^usemtl /.test(p)?l=p.substring(7).trim():/^s /.test(p)))}return h.length>0&&(c.faces=this.getCorrectIndices(c.faces)),h.push(c),h},getMtlName:function(t){for(var e=t.split("\n"),i=0;i<e.length;i++){var r=e[i];if(r=r.trim(),/^mtllib /.test(r))return r.substring(7).trim()}return null},readMtl:function(t){var e=t.split("\n"),i=/Kd ([\d|\.|\+|\-|e|E]+) ([\d|\.|\+|\-|e|E]+) ([\d|\.|\+|\-|e|E]+)/,r={},o=-1;r.mtlName=[],r.kd=[],r.mapKd=[];for(var a=0;a<e.length;a++){var s,n=e[a];/^newmtl /.test(n)?(o++,r.mtlName[o]=n.substring(7).trim()):null!==(s=i.exec(n))?r.kd[o]=[parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]),1]:/^map_Kd /.test(n)&&(r.mapKd[o]=n.substring(7).trim())}return r},getCorrectIndices:function(t){for(var e=parseInt(t[0][0][0]),i=parseInt(t[0][0][1]),r=parseInt(t[0][0][2]),o=0;o<t.length;o++)for(var a=0;3>a;a++)parseInt(t[o][a][0])<e&&(e=parseInt(t[o][a][0])),parseInt(t[o][a][1])<i&&(i=parseInt(t[o][a][1])),parseInt(t[o][a][2])<r&&(r=parseInt(t[o][a][2]));e-=1,i-=1,r-=1;for(var o=0;o<t.length;o++)for(var a=0;3>a;a++)t[o][a][0]-=e,t[o][a][1]-=i,t[o][a][2]-=r;return t},createO3DFromOBJ:function(t,e,i){for(var r=[],o=[],a=[],s=[],n=[],h=[],c=[],l=0,u=!e||e.mapKd.length>0,d=!e||u&&e.mapKd.length>1,y=0;y<t.faces.length;y++){var p,f=t.faces[y],g=0,x=!1;if(!e||0===e.kd.length&&0===e.mapKd.length)p=[.5,.5,.5,1];else{var m=e.mtlName.indexOf(f[3]);x=Boolean(e.mapKd[m]),p=x?e.mapKd[m]:e.kd[m],x&&(g=c.indexOf(p),0>g&&(c.push(p),g=c.indexOf(p)))}for(var v=0;3>v;v++){var A=f[v][0]-1,w=f[v][1]-1,M=f[v][2]-1,b=!1;b||(Array.prototype.push.apply(r,t.vertices[A]),Array.prototype.push.apply(n,t.normals[M]),x?(Array.prototype.push.apply(a,t.uvs[w]),Array.prototype.push.apply(o,[.5,.5,.5,2])):(Array.prototype.push.apply(o,p),Array.prototype.push.apply(a,t.uvs[w])),s.push(g),h.push(l++))}}var S=new Ayce.Object3D;if(r.length>0&&(S.vertices=r),o.length>0&&(S.colors=o),a.length>0&&(S.textureCoords=a),d&&(S.textureIndices=s),n.length>0&&(S.normals=n),h.length>0&&(S.indices=h),u){for(var y=0;y<c.length;y++)c[y]=i+c[y].replace(/\\/g,"/");if(c&&c.length>10)throw"OBJ Loader: Can't use more than 10 Textures";c.length>0&&(S.imageSrc=c)}return S},copyOBJO3D:function(t){var e=new Ayce.Object3D;return t.vertices&&(e.vertices=t.vertices.slice()),t.colors&&(e.colors=t.colors.slice()),t.textureCoords&&(e.textureCoords=t.textureCoords.slice()),t.textureIndices&&(e.textureIndices=t.textureIndices.slice()),t.normals&&(e.normals=t.normals.slice()),t.indices&&(e.indices=t.indices.slice()),e.imageSrc=t.imageSrc,e}},Ayce.VRSquare=function(){Ayce.Object3D.call(this),this.shader="vr-canvas",this.vertices=[-1,-1,1,1,-1,1,-1,1,1,1,1,1],this.textureCoords=[0,0,1,0,0,1,1,1]},Ayce.VRSquare.prototype=new Ayce.Object3D,Ayce.ParticleSystem=function(t,e,i,r){Ayce.Object3D.call(this);var o=3,a=3,s=3,n=1,h=1,c=1;this.particles=[];var l;for(l=0;i>l;l++)this.particles.push(new Ayce.Particle);this.vertices=[],this.colors=null,this.textureCoords=null,this.indices=[],this.velocities=[],this.lifetimes=[],this.gravities=[],this.gravityExps=[],this.geometries=[],this.rotationAngles=[],this.normals=null,this.imageSrc=e.imageSrc,this.shader=null;var u={time:0,startTime:Date.now()};this.shaderAttributes=[],this.shaderAttributes.push(["aGeometryPosition",o,this.geometries]),this.shaderAttributes.push(["aVertexVelocity",a,this.velocities]),this.shaderAttributes.push(["aVertexRotation",s,this.rotationAngles]),this.shaderAttributes.push(["aLifetime",n,this.lifetimes]),this.shaderAttributes.push(["aGravity",h,this.gravities]),this.shaderAttributes.push(["aGravityExponent",c,this.gravityExps]),this.shaderUniforms=[],this.shaderUniforms.push(["uTime","uniform1f",u,["time"]]),this.initParticleArrays=function(){var t;for(l=0;l<this.particles.length;l++){var i=this.particles[l];for(t=0;t<e.vertices.length;t+=3)this.vertices.push(e.vertices[t]*i.scale.x+i.position.x),this.vertices.push(e.vertices[t+1]*i.scale.y+i.position.y),this.vertices.push(e.vertices[t+2]*i.scale.z+i.position.z),this.geometries.push(e.vertices[t]*i.scale.x),this.geometries.push(e.vertices[t+1]*i.scale.y),this.geometries.push(e.vertices[t+2]*i.scale.z)}if(e.textureCoords&&-1!=e.textureCoords[0])for(this.textureCoords=[],l=0;l<this.particles.length;l++)this.textureCoords=this.textureCoords.concat(e.textureCoords);else for(this.colors=[],l=0;l<this.particles.length;l++)this.colors=this.colors.concat(this.particles[l].colors?this.particles[l].colors:e.colors);for(l=0;l<this.particles.length;l++)for(t=0;t<e.indices.length;t++)this.indices.push(e.indices[t]+l*e.vertices.length/o);for(l=0;l<this.particles.length;l++)for(t=0;t<e.vertices.length/o;t++)e.velocities?(this.velocities.push(this.particles[l].velocity.x+e.velocities[t*a]),this.velocities.push(this.particles[l].velocity.y+e.velocities[t*a+1]),this.velocities.push(this.particles[l].velocity.z+e.velocities[t*a+2])):(this.velocities.push(this.particles[l].velocity.x),this.velocities.push(this.particles[l].velocity.y),this.velocities.push(this.particles[l].velocity.z));for(l=0;l<this.particles.length;l++)for(t=0;t<e.vertices.length/o;t++)this.lifetimes.push(e.lifetimes?0===e.lifetimes[t]?this.particles[l].lifetime:Math.min(this.particles[l].lifetime,e.lifetimes[t]):this.particles[l].lifetime);for(l=0;l<this.particles.length;l++)for(t=0;t<e.vertices.length/o;t++)this.gravities.push(e.gravities?this.particles[l].gravity+e.gravities[t]:this.particles[l].gravity),this.gravityExps.push(this.particles[l].gravityExponent);for(l=0;l<this.particles.length;l++)for(t=0;t<e.vertices.length/o;t++)this.rotationAngles.push(this.particles[l].rotationAngle.x),this.rotationAngles.push(this.particles[l].rotationAngle.y),this.rotationAngles.push(this.particles[l].rotationAngle.z);if(e.normals)for(this.normals=[],l=0;l<this.particles.length;l++)this.normals=this.normals.concat(e.normals)};var d=this.update;this.update=function(){d.call(this),u.time=Date.now()+r-u.startTime}},Ayce.ParticleSystem.prototype=new Ayce.Object3D,Ayce.Particle=function(){this.position=new Ayce.Vector3(0,0,0),this.rotationAngle=new Ayce.Vector3(0,0,0),this.scale=new Ayce.Vector3(1,1,1),this.vertices=[],this.colors=null,this.velocity=new Ayce.Vector3(0,0,0),this.lifetime=0,this.gravity=0,this.gravityExponent=1},Ayce.Skybox=function(t,e,i,r,o,a,s,n,h){this.isSkybox=!0,this.imageSrc=[s+t,s+e,s+i,s+r,s+o,s+a],this.parent=n,this.parentRotationWeight=new Ayce.Vector3(0,0,0),this.parentPositionWeight=new Ayce.Vector3(1,1,1);var c=2*h/Math.sqrt(3);this.scale=new Ayce.Vector3(c,c,c),this.vertices=[-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5],this.textureCoords=[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0],this.textureIndices=[0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5],this.normals=null,this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],this.indices.reverse(),this.calcBoundingBox()},Ayce.Skybox.prototype=new Ayce.Object3D,Ayce.Cube3D=function(){Ayce.Object3D.call(this),this.vertices=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],this.colors=[1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1,.5,.5,1,1,.5,.5,1,1,.5,.5,1,1,.5,.5,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1],this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},Ayce.Cube3D.prototype=new Ayce.Object3D,Ayce.Pyramid3D=function(){Ayce.Object3D.call(this),this.vertices=[0,1,0,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1],this.colors=[1,0,0,.5,0,1,0,.5,0,0,1,.5,0,0,1,.5,0,1,0,.5],this.indices=[0,2,1,0,3,2,0,4,3,0,1,4,1,2,3,1,3,4],this.transparent=!0},Ayce.Pyramid3D.prototype=Ayce.Object3D.prototype,Ayce.Sphere3D=function(){Ayce.Object3D.call(this),this.imageSrc="earth.jpg",this.specularMap="earth-specular.gif",this.shininess=10,this.useFragmentLighting=!0;var t=30,e=30,i=5;this.vertices=[],this.normals=[],this.textureCoords=[];for(var r=0;t>=r;r++)for(var o=r*Math.PI/t,a=Math.sin(o),s=Math.cos(o),n=0;e>=n;n++){var h=2*n*Math.PI/e,c=Math.sin(h),l=Math.cos(h),u=l*a,d=s,y=c*a,p=1-n/e,f=1-r/t;this.normals.push(u),this.normals.push(d),this.normals.push(y),this.textureCoords.push(p),this.textureCoords.push(f),this.vertices.push(i*u),this.vertices.push(i*d),this.vertices.push(i*y)}for(console.log(this.normals),this.indices=[],r=0;t>r;r++)for(var n=0;e>n;n++){var g=r*(e+1)+n,x=g+e+1;this.indices.push(g+1),this.indices.push(x),this.indices.push(g),this.indices.push(g+1),this.indices.push(x+1),this.indices.push(x)}},Ayce.Sphere3D.prototype=Ayce.Object3D.prototype,Ayce.Square=function(){Ayce.Object3D.call(this),this.vertices=[-1,-1,0,1,-1,0,1,1,0,-1,1,0],this.colors=[0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1],this.indices=[0,1,2,0,2,3]},Ayce.Square.prototype=Ayce.Object3D.prototype,Ayce.KeyboardHandler=function(){var t=[],e=[];Ayce.KeyboardHandler.keys=[],this.update=function(){var i;for(i=0;i<t.length;i++)Ayce.KeyboardHandler.keys[t[i]]=!0,t.splice(i,1);for(i=0;i<e.length;i++)Ayce.KeyboardHandler.keys[e[i]]=!1,e.splice(i,1)},window.addEventListener("keydown",function(e){var i=e.keyCode||e.which;Ayce.KeyboardHandler.keys[i]||t.push(i)},!0),window.addEventListener("keyup",function(t){var i=t.keyCode||t.which;e.push(i)},!0)},Ayce.KeyboardHandler.isKeyDown=function(t){if(!Ayce.KeyboardHandler.keys)return void console.log("KeyboardHandler not initialised");if(1===t.length){var e=t.charCodeAt(0);return Ayce.KeyboardHandler.keys[e]}return t.length>1?!1:!1},Ayce.KeyboardHandler.prototype={},Ayce.GamepadHandler=function(){},Ayce.GamepadHandler.getGamepads=function(){return APISupported?navigator.getGamepads():void 0};var APISupported=null,init=function(){navigator.getGamepads?(APISupported=!0,console.log("Gamepad API supported"),console.log("ongamepadconnected"in window?"ongamepadconnected supported":"ongamepadconnected not supported")):(APISupported=!1,console.log("Gamepad API not supported"))};init(),Ayce.MouseHandler=function(){function t(){document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement?document.addEventListener("mousemove",e.onMouseLockMove,!1):document.removeEventListener("mousemove",e.onMouseLockMove,!1)}var e=this;this.addedMovement=new Ayce.Vector2(0,0),this.movement=new Ayce.Vector2(0,0),this.onMouseLockMove=function(t){e.addedMovement.x+=t.movementX||t.mozMovementX||0,e.movement.x=t.movementX||t.mozMovementX||0,e.addedMovement.y+=t.movementY||t.mozMovementY||0,e.movement.y=t.movementY||t.mozMovementY||0},document.addEventListener("pointerlockchange",t,!1),document.addEventListener("mozpointerlockchange",t,!1),document.addEventListener("webkitpointerlockchange",t,!1)};var mouseHandler=null,lastMovement=new Ayce.Vector2(0,0),movement=new Ayce.Vector2(0,0),x=0,y=0,newFrame=!0;Ayce.MouseHandler.getMovement=function(){return null===mouseHandler&&(mouseHandler=new Ayce.MouseHandler),newFrame&&(lastMovement.x-mouseHandler.addedMovement.x===0?movement.x=0:(lastMovement.x=mouseHandler.addedMovement.x,movement.x=mouseHandler.movement.x),lastMovement.y-mouseHandler.addedMovement.y===0?movement.y=0:(lastMovement.y=mouseHandler.addedMovement.y,movement.y=mouseHandler.movement.y),newFrame=!1),movement},Ayce.MouseHandler.setNewFrameTrue=function(){newFrame=!0},Ayce.SensorsHandler=function(){var t=this;this.alpha=0,this.beta=0,this.gamma=0,window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",function(e){t.alpha=e.alpha,t.beta=e.beta,t.gamma=e.gamma},!0)};var sensorsHandler=null;Ayce.SensorsHandler.getRoll=function(){return null==sensorsHandler&&(sensorsHandler=new Ayce.SensorsHandler),sensorsHandler.alpha},Ayce.SensorsHandler.getPitch=function(){return null==sensorsHandler&&(sensorsHandler=new Ayce.SensorsHandler),sensorsHandler.beta},Ayce.SensorsHandler.getYaw=function(){return null==sensorsHandler&&(sensorsHandler=new Ayce.SensorsHandler),sensorsHandler.gamma},Ayce.SensorsHandler.prototype={},Ayce.HMDHandler=function(){};var vrDevice=null,positionDevice=null;Ayce.HMDHandler.getHMDData=function(){if(!vrDevice)return null;var t=vrDevice.getEyeParameters("left"),e=vrDevice.getEyeParameters("right");return[t,e]},Ayce.HMDHandler.getPositionalData=function(){return null!==positionDevice?positionDevice.getState():void 0},Ayce.HMDHandler.resetSensor=function(){void 0!==positionDevice&&("resetSensor"in positionDevice?positionDevice.resetSensor():"zeroSensor"in positionDevice?positionDevice.zeroSensor():console.log("Can't reset position sensor."))},function(){function t(t){for(var e in t)if(t[e]instanceof HMDVRDevice){vrDevice=t[e];break}for(var e in t)if(t[e]instanceof PositionSensorVRDevice){positionDevice=t[e];break}}navigator.getVRDevices&&navigator.getVRDevices().then(t)}(),Ayce.HMDHandler.isWebVRReady=function(){return void 0!==navigator.getVRDevices},Ayce.HMDHandler.prototype={};
//# sourceMappingURL=AyceVR.min.js.map