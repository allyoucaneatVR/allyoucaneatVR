var Ayce={};"undefined"!=typeof module&&(module.exports=Ayce),"undefined"==typeof navigator&&(navigator={}),Ayce.requestAnimFrame=function(e){var t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)};t.call(window,e)},Ayce.Vector2=function(e,t){this.x=e||0,this.y=t||0},Ayce.Vector2.prototype={getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var e=Math.sqrt(this.x*this.x+this.y*this.y);return 0!==e&&(this.x/=e,this.y/=e),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},nullVector:function(){return this.x=0,this.y=0,this},scaleBy:function(e){return this.x*=e,this.y*=e,this},set:function(e,t){return this.x=e,this.y=t,this},add:function(e,t){return this.x+=e,this.y+=t,this},subtract:function(e,t){return this.x-=e,this.y-=t,this},multiply:function(e,t){return this.x*=e,this.y*=t,this},distance:function(e,t){var i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)},dotProduct:function(e){return this.x*e.x+this.y*e.y},addVector2:function(e){return this.x+=e.x,this.y+=e.y,this},copyToVector:function(e,t){t.x=e.x,t.y=e.y},copy:function(){return new Ayce.Vector2(this.x,this.y)}},Ayce.Vector3=function(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0},Ayce.Vector3.prototype={getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return 0!==e&&(this.x/=e,this.y/=e,this.z/=e),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},nullVector:function(){return this.x=0,this.y=0,this.z=0,this},scaleBy:function(e){return this.x*=e,this.y*=e,this.z*=e,this},set:function(e,t,i){return this.x=e,this.y=t,this.z=i,this},add:function(e,t,i){return this.x+=e,this.y+=t,this.z+=i,this},subtract:function(e,t,i){return this.x-=e,this.y-=t,this.z-=i,this},multiply:function(e,t,i){return this.x*=e,this.y*=t,this.z*=i,this},distance:function(e,t){var i=t.x-e.x,r=t.y-e.y,o=t.z-e.z;return Math.sqrt(i*i+r*r+o*o)},dotProduct:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},crossProduct:function(e){return new Ayce.Vector3(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},addVector3:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},copyToVector:function(e,t){t.x=e.x,t.y=e.y,t.z=e.z},copy:function(){return new Ayce.Vector3(this.x,this.y,this.z)}},Ayce.Quaternion=function(e,t,i,r){this.x=e||0,this.y=t||0,this.z=i||0,this.w=r||1},Ayce.Quaternion.prototype={multiply:function(e,t){var i=e.w,r=e.x,o=e.y,a=e.z,n=t.w,s=t.x,h=t.y,c=t.z;return this.w=i*n-r*s-o*h-a*c,this.x=i*s+r*n+o*c-a*h,this.y=i*h-r*c+o*n+a*s,this.z=i*c+r*h-o*s+a*n,this},set:function(e,t,i,r){this.x=e,this.y=t,this.z=i,this.w=r},fromAxisAngle:function(e,t){e.normalize();var i=Math.sin(t/2),r=Math.cos(t/2);return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=r,this.normalize(),this},fromEulerAngles:function(e,t,i){var r=.5*e,o=.5*t,a=.5*i,n=Math.cos(r),s=Math.sin(r),h=Math.cos(o),c=Math.sin(o),l=Math.cos(a),u=Math.sin(a);return this.w=n*h*l+s*c*u,this.x=s*h*l-n*c*u,this.y=n*c*l+s*h*u,this.z=n*h*u-s*c*l,this},normalize:function(){var e=this.x,t=this.y,i=this.z,r=this.w,o=1/Math.sqrt(e*e+t*t+i*i+r*r);return this.x*=o,this.y*=o,this.z*=o,this.w*=o,this},reset:function(){this.x=0,this.y=0,this.z=0,this.w=1},rotatePoint:function(e){var t=this.x,i=this.y,r=this.z,o=this.w,a=e.x,n=e.y,s=e.z,h=-t*a-i*n-r*s,c=o*a+i*s-r*n,l=o*n-t*s+r*a,u=o*s+t*n-i*a;return e.x=-h*t+c*o-l*r+u*i,e.y=-h*i+c*r+l*o-u*t,e.z=-h*r-c*i+l*t+u*o,e},getRotatedPoint:function(e,t){var i,r,o,a,n=this.x,s=this.y,h=this.z,c=this.w,l=e.x,u=e.y,d=e.z;a=-n*l-s*u-h*d,i=c*l+s*d-h*u,r=c*u-n*d+h*l,o=c*d+n*u-s*l;var y=t?t:new Ayce.Vector3;return y.x=-a*n+i*c-r*h+o*s,y.y=-a*s+i*h+r*c-o*n,y.z=-a*h-i*s+r*n+o*c,y},toRotationMatrix:function(e){var t=this.x,i=this.y,r=this.z,o=this.w,a=t*t,n=t*i,s=t*r,h=t*o,c=i*i,l=i*r,u=i*o,d=r*r,y=r*o;e.data[0]=1-2*(c+d),e.data[1]=2*(n-y),e.data[2]=2*(s+u),e.data[4]=2*(n+y),e.data[5]=1-2*(a+d),e.data[6]=2*(l-h),e.data[8]=2*(s-u),e.data[9]=2*(l+h),e.data[10]=1-2*(a+c),e.data[3]=e.data[7]=e.data[11]=e.data[12]=e.data[13]=e.data[14]=0,e.data[15]=1},getConjugate:function(e){return this.normalize(),e?(e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e):new Ayce.Quaternion(-this.x,-this.y,-this.z,this.w)},copy:function(){return new Ayce.Quaternion(this.x,this.y,this.z,this.w)},copyToQuaternion:function(e,t){t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w},slerp:function(e,t,i){var r=e.w,o=e.x,a=e.y,n=e.z,s=t.w,h=t.x,c=t.y,l=t.z,u=r*s+o*h+a*c+n*l;if(0>u&&(u=-u,s=-s,h=-h,c=-c,l=-l),.95>u){var d=Math.acos(u),y=1/Math.sin(d),p=Math.sin(d*(1-i))*y,f=Math.sin(d*i)*y;this.w=r*p+s*f,this.x=o*p+h*f,this.y=a*p+c*f,this.z=n*p+l*f}else{this.w=r+i*(s-r),this.x=o+i*(h-o),this.y=a+i*(c-a),this.z=n+i*(l-n);var g=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=g,this.x*=g,this.y*=g,this.z*=g}},getForwardVector:function(){return new Ayce.Vector3(2*(this.x*this.z+this.w*this.y),2*(this.y*this.x-this.w*this.x),1-2*(this.x*this.x+this.y*this.y))},getUpVector:function(){return new Ayce.Vector3(2*(this.x*this.y-this.w*this.z),1-2*(this.x*this.x+this.z*this.z),2*(this.y*this.z+this.w*this.x))},getRightVector:function(){return new Ayce.Vector3(1-2*(this.y*this.y+this.z*this.z),2*(this.x*this.y+this.w*this.z),2*(this.x*this.z-this.w*this.y))}},Ayce.Matrix4=function(){this.data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},Ayce.Matrix4.makePerspective=function(e,t,i,r){var o=new Ayce.Matrix4,a=e/2*Math.PI/180,n=Math.sin(a),s=Math.cos(a)/n,h=!0,c=h?-1:1;return o.data=new Float32Array([s/t,0,0,0,0,s,0,0,0,0,r/(i-r)*-c,c,0,0,r*i/(i-r),0]),o},Ayce.Matrix4.makeOrthoPerspective=function(e,t,i,r,o,a){var n=new Ayce.Matrix4,s=1/(e-t),h=1/(r-i),c=1/(o-a);return n.data=new Float32Array([-2*s,0,0,0,0,-2*h,0,0,0,0,2*c,0,(e+t)*s,(i+r)*h,(a+o)*c,1]),n},Ayce.Matrix4.makeVRPerspective=function(e,t,i){var r=Math.PI/180,o=Math.tan(e.upDegrees*r),a=Math.tan(e.downDegrees*r),n=Math.tan(e.leftDegrees*r),s=Math.tan(e.rightDegrees*r),h=2/(n+s),c=(n-s)*h*.5,l=2/(o+a),u=(o-a)*l*.5,d=!0,y=d?-1:1,p=new Ayce.Matrix4;return p.data=new Float32Array([h,0,0,0,0,l,0,0,c*y,u*y,i/(t-i)*-y,y,0,0,i*t/(t-i),0]),p},Ayce.Matrix4.prototype={poolMatrix:new Ayce.Matrix4,poolVector3:new Ayce.Vector3,identity:function(){this.data[0]=1,this.data[1]=0,this.data[2]=0,this.data[3]=0,this.data[4]=0,this.data[5]=1,this.data[6]=0,this.data[7]=0,this.data[8]=0,this.data[9]=0,this.data[10]=1,this.data[11]=0,this.data[12]=0,this.data[13]=0,this.data[14]=0,this.data[15]=1},apply:function(e){var t=this.data[0],i=this.data[4],r=this.data[8],o=this.data[12],a=this.data[1],n=this.data[5],s=this.data[9],h=this.data[13],c=this.data[2],l=this.data[6],u=this.data[10],d=this.data[14],y=this.data[3],p=this.data[7],f=this.data[11],g=this.data[15],m=e.data[0],x=e.data[4],v=e.data[8],A=e.data[12],w=e.data[1],M=e.data[5],b=e.data[9],S=e.data[13],C=e.data[2],R=e.data[6],T=e.data[10],V=e.data[14],z=e.data[3],P=e.data[7],E=e.data[11],L=e.data[15];this.data[0]=t*m+a*x+c*v+y*A,this.data[1]=t*w+a*M+c*b+y*S,this.data[2]=t*C+a*R+c*T+y*V,this.data[3]=t*z+a*P+c*E+y*L,this.data[4]=i*m+n*x+l*v+p*A,this.data[5]=i*w+n*M+l*b+p*S,this.data[6]=i*C+n*R+l*T+p*V,this.data[7]=i*z+n*P+l*E+p*L,this.data[8]=r*m+s*x+u*v+f*A,this.data[9]=r*w+s*M+u*b+f*S,this.data[10]=r*C+s*R+u*T+f*V,this.data[11]=r*z+s*P+u*E+f*L,this.data[12]=o*m+h*x+d*v+g*A,this.data[13]=o*w+h*M+d*b+g*S,this.data[14]=o*C+h*R+d*T+g*V,this.data[15]=o*z+h*P+d*E+g*L},applyRotation:function(e,t,i){if(this.poolMatrix.data[0]=1,this.poolMatrix.data[1]=0,this.poolMatrix.data[2]=0,this.poolMatrix.data[3]=0,this.poolMatrix.data[4]=0,this.poolMatrix.data[5]=1,this.poolMatrix.data[6]=0,this.poolMatrix.data[7]=0,this.poolMatrix.data[8]=0,this.poolMatrix.data[9]=0,this.poolMatrix.data[10]=1,this.poolMatrix.data[11]=0,this.poolMatrix.data[12]=0,this.poolMatrix.data[13]=0,this.poolMatrix.data[14]=0,this.poolMatrix.data[15]=1,this.getAxisRotation(t.x,t.y,t.z,e,this.poolMatrix),void 0!==i){var r=i;this.poolMatrix.applyTranslation(r.x,r.y,r.z)}this.apply(this.poolMatrix)},applyScale:function(e,t,i){this.poolMatrix.data[0]=e,this.poolMatrix.data[1]=0,this.poolMatrix.data[2]=0,this.poolMatrix.data[3]=0,this.poolMatrix.data[4]=0,this.poolMatrix.data[5]=t,this.poolMatrix.data[6]=0,this.poolMatrix.data[7]=0,this.poolMatrix.data[8]=0,this.poolMatrix.data[9]=0,this.poolMatrix.data[10]=i,this.poolMatrix.data[11]=0,this.poolMatrix.data[12]=0,this.poolMatrix.data[13]=0,this.poolMatrix.data[14]=0,this.poolMatrix.data[15]=1,this.apply(this.poolMatrix)},applyTranslation:function(e,t,i){this.data[12]+=e,this.data[13]+=t,this.data[14]+=i},getAxisRotation:function(e,t,i,r,o){var a;a=o?o:new Ayce.Matrix4;var n=this.poolVector3;n.x=e,n.y=t,n.z=i;var s=-r*(Math.PI/180),h=Math.cos(s),c=Math.sin(s),l=1-h;a.data[0]=h+n.x*n.x*l,a.data[5]=h+n.y*n.y*l,a.data[10]=h+n.z*n.z*l;var u=n.x*n.y*l,d=n.z*c;return a.data[4]=u+d,a.data[1]=u-d,u=n.x*n.z*l,d=n.y*c,a.data[8]=u-d,a.data[2]=u+d,u=n.y*n.z*l,d=n.x*c,a.data[9]=u+d,a.data[6]=u-d,a},getDeterminant:function(){return 1*((this.data[0]*this.data[5]-this.data[4]*this.data[1])*(this.data[10]*this.data[15]-this.data[14]*this.data[11])-(this.data[0]*this.data[9]-this.data[8]*this.data[1])*(this.data[6]*this.data[15]-this.data[14]*this.data[7])+(this.data[0]*this.data[13]-this.data[12]*this.data[1])*(this.data[6]*this.data[11]-this.data[10]*this.data[7])+(this.data[4]*this.data[9]-this.data[8]*this.data[5])*(this.data[2]*this.data[15]-this.data[14]*this.data[3])-(this.data[4]*this.data[13]-this.data[12]*this.data[5])*(this.data[2]*this.data[11]-this.data[10]*this.data[3])+(this.data[8]*this.data[13]-this.data[12]*this.data[9])*(this.data[2]*this.data[7]-this.data[6]*this.data[3]))},transpose:function(){this.copyToMatrix(this,this.poolMatrix),this.data[1]=this.poolMatrix.data[4],this.data[2]=this.poolMatrix.data[8],this.data[3]=this.poolMatrix.data[12],this.data[4]=this.poolMatrix.data[1],this.data[6]=this.poolMatrix.data[9],this.data[7]=this.poolMatrix.data[13],this.data[8]=this.poolMatrix.data[2],this.data[9]=this.poolMatrix.data[6],this.data[11]=this.poolMatrix.data[14],this.data[12]=this.poolMatrix.data[3],this.data[13]=this.poolMatrix.data[7],this.data[14]=this.poolMatrix.data[11]},invert:function(){var e=this.getDeterminant(),t=Math.abs(e)>1e-11;if(!t)throw"Can't invert Matrix";e=1/e;var i=this.data[0],r=this.data[4],o=this.data[8],a=this.data[12],n=this.data[1],s=this.data[5],h=this.data[9],c=this.data[13],l=this.data[2],u=this.data[6],d=this.data[10],y=this.data[14],p=this.data[3],f=this.data[7],g=this.data[11],m=this.data[15];return this.data[0]=e*(s*(d*m-y*g)-h*(u*m-y*f)+c*(u*g-d*f)),this.data[1]=-e*(n*(d*m-y*g)-h*(l*m-y*p)+c*(l*g-d*p)),this.data[2]=e*(n*(u*m-y*f)-s*(l*m-y*p)+c*(l*f-u*p)),this.data[3]=-e*(n*(u*g-d*f)-s*(l*g-d*p)+h*(l*f-u*p)),this.data[4]=-e*(r*(d*m-y*g)-o*(u*m-y*f)+a*(u*g-d*f)),this.data[5]=e*(i*(d*m-y*g)-o*(l*m-y*p)+a*(l*g-d*p)),this.data[6]=-e*(i*(u*m-y*f)-r*(l*m-y*p)+a*(l*f-u*p)),this.data[7]=e*(i*(u*g-d*f)-r*(l*g-d*p)+o*(l*f-u*p)),this.data[8]=e*(r*(h*m-c*g)-o*(s*m-c*f)+a*(s*g-h*f)),this.data[9]=-e*(i*(h*m-c*g)-o*(n*m-c*p)+a*(n*g-h*p)),this.data[10]=e*(i*(s*m-c*f)-r*(n*m-c*p)+a*(n*f-s*p)),this.data[11]=-e*(i*(s*g-h*f)-r*(n*g-h*p)+o*(n*f-s*p)),this.data[12]=-e*(r*(h*y-c*d)-o*(s*y-c*u)+a*(s*d-h*u)),this.data[13]=e*(i*(h*y-c*d)-o*(n*y-c*l)+a*(n*d-h*l)),this.data[14]=-e*(i*(s*y-c*u)-r*(n*y-c*l)+a*(n*u-s*l)),this.data[15]=e*(i*(s*d-h*u)-r*(n*d-h*l)+o*(n*u-s*l)),t},transformVector:function(e){var t=e.x,i=e.y,r=e.z;return e.x=t*this.data[0]+i*this.data[4]+r*this.data[8]+this.data[12],e.y=t*this.data[1]+i*this.data[5]+r*this.data[9]+this.data[13],e.z=t*this.data[2]+i*this.data[6]+r*this.data[10]+this.data[14],e},copyToMatrix:function(e,t){t.data[0]=e.data[0],t.data[1]=e.data[1],t.data[2]=e.data[2],t.data[3]=e.data[3],t.data[4]=e.data[4],t.data[5]=e.data[5],t.data[6]=e.data[6],t.data[7]=e.data[7],t.data[8]=e.data[8],t.data[9]=e.data[9],t.data[10]=e.data[10],t.data[11]=e.data[11],t.data[12]=e.data[12],t.data[13]=e.data[13],t.data[14]=e.data[14],t.data[15]=e.data[15]},copy:function(){var e=new Ayce.Matrix4;return e.data=new Float32Array(this.data),e},getMatrix3:function(e){var t;return t=e?e:new Ayce.Matrix3,t.data[0]=this.data[0],t.data[1]=this.data[1],t.data[2]=this.data[2],t.data[3]=this.data[4],t.data[4]=this.data[5],t.data[5]=this.data[6],t.data[6]=this.data[8],t.data[7]=this.data[9],t.data[8]=this.data[10],t}},Ayce.Matrix3=function(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1])},Ayce.Matrix3.prototype={},Ayce.Geometry=function(){this.position=new Ayce.Vector3(0,0,0),this.rotation=new Ayce.Quaternion,this.scale=new Ayce.Vector3(1,1,1),this.offset=new Ayce.Vector3(0,0,0)},Ayce.Geometry.prototype={},Ayce.Geometry.Box=function(e,t,i){Ayce.Geometry.call(this),this.a=e||0,this.b=t||0,this.c=i||0},Ayce.Geometry.Box.prototype=new Ayce.Geometry,Ayce.Geometry.Box.prototype.getO3D=function(e){var t=new Ayce.Object3D,i=this.offset,r=this.a,o=this.b,a=this.c;return t.vertices=[],t.vertices.push(i.x+0,i.y+0,i.z+0),t.vertices.push(i.x+r,i.y+0,i.z+0),t.vertices.push(i.x+0,i.y+o,i.z+0),t.vertices.push(i.x+r,i.y+o,i.z+0),t.vertices.push(i.x+0,i.y+0,i.z+a),t.vertices.push(i.x+r,i.y+0,i.z+a),t.vertices.push(i.x+0,i.y+o,i.z+a),t.vertices.push(i.x+r,i.y+o,i.z+a),t.normals=[],t.normals.push(-1,-1,-1),t.normals.push(1,-1,-1),t.normals.push(-1,1,-1),t.normals.push(1,1,-1),t.normals.push(-1,-1,1),t.normals.push(1,-1,1),t.normals.push(-1,1,1),t.normals.push(1,1,1),t.indices=[],e?(t.indices.push(0,1),t.indices.push(5,1),t.indices.push(4,0),t.indices.push(4,5),t.indices.push(2,6),t.indices.push(6,7),t.indices.push(7,3),t.indices.push(3,2),t.indices.push(0,2),t.indices.push(4,6),t.indices.push(5,7),t.indices.push(3,1),t.isWireframe=!0):(t.indices.push(2,1,0),t.indices.push(2,3,1),t.indices.push(7,4,5),t.indices.push(7,6,4),t.indices.push(6,0,4),t.indices.push(6,2,0),t.indices.push(3,5,1),t.indices.push(3,7,5),t.indices.push(0,5,4),t.indices.push(0,1,5),t.indices.push(6,3,2),t.indices.push(6,7,3)),t.position=this.position,t.rotation=this.rotation,t.scale=this.scale,t},Ayce.Geometry.Box.prototype.containsPoint=function(e){var t=this,i=function(e){var i=t.position.copy().addVector3(e).addVector3(t.offset);return i.multiply(t.scale.x,t.scale.y,t.scale.z),i=t.rotation.getRotatedPoint(i)},r=function(e,t,i,r){t=t.copy().subtract(e.x,e.y,e.z),i=i.copy().subtract(e.x,e.y,e.z);var o=t.copy().crossProduct(i).normalize(),a=r.copy().subtract(e.x,e.y,e.z),n=o.dotProduct(a);return n},o=i(new Ayce.Vector3(0,0,0)),a=i(new Ayce.Vector3(0,this.b,0)),n=i(new Ayce.Vector3(this.a,this.b,0)),s=i(new Ayce.Vector3(0,0,this.c)),h=i(new Ayce.Vector3(this.a,0,this.c)),c=i(new Ayce.Vector3(0,this.b,this.c)),l=i(new Ayce.Vector3(this.a,this.b,this.c)),u=r(c,a,l,e),d=r(s,h,o,e),y=r(c,s,o,e),p=r(l,n,h,e),f=r(c,l,s,e),g=r(a,o,n,e),s=u>0&&d>0&&y>0&&p>0&&f>0&&g>0;return s},Ayce.Geometry.Sphere=function(e){Ayce.Geometry.call(this),this.r=e||0},Ayce.Geometry.Sphere.prototype=new Ayce.Geometry,Ayce.Geometry.Sphere.prototype.getO3D=function(e,t,i){this.scale=null;var r,o,a=t||10,n=i||10,s=this.r,h=this.offset,c=new Ayce.Object3D;for(c.vertices=[],c.normals=[],c.textureCoords=[],r=0;n>=r;r++){var l=r*Math.PI/n,u=Math.sin(l),d=Math.cos(l);for(o=0;a>=o;o++){var y=2*o*Math.PI/a,p=Math.sin(y),f=Math.cos(y),g=f*u,m=d,x=p*u,v=1-o/a,A=1-r/n;c.normals.push(g,m,x),c.textureCoords.push(v,A),c.vertices.push(s*g+h.x,s*m+h.y,s*x+h.z)}}for(e&&(c.isWireframe=!0),c.indices=[],r=0;n>r;r++)for(o=0;a>o;o++){var w=r*(a+1)+o,M=w+a+1;e?(c.indices.push(M+1,M),c.indices.push(M,w),c.indices.push(w+1,w),c.indices.push(w+1,M+1)):(c.indices.push(w+1,M,w),c.indices.push(w+1,M+1,M))}return c.position=this.position,c.rotation=this.rotation,c},Ayce.Geometry.Plane=function(e,t,i,r,o){Ayce.Geometry.call(this),this.a=e||0,this.b=t||0,this.xVertices=i||2,this.yVertices=r||2,this.splitSquares=o},Ayce.Geometry.Plane.prototype=new Ayce.Geometry,Ayce.Geometry.Plane.prototype.getO3D=function(){var e=new Ayce.Object3D,t=this.offset,i=this.a,r=this.b,o=this.xVertices,a=this.yVertices;e.vertices=[];var n,s,h=i/o,c=r/a;if(this.splitSquares){for(s=0;s<this.yVertices-1;s++)for(n=0;n<this.xVertices-1;n++)e.vertices.push(t.x+n*h,t.y+s*c,t.z,t.x+n*h+h,t.y+s*c,t.z,t.x+n*h,t.y+s*c+c,t.z,t.x+n*h+h,t.y+s*c,t.z,t.x+n*h+h,t.y+s*c+c,t.z,t.x+n*h,t.y+s*c+c,t.z);e.normals=[],e.indices=[];for(var l=0;l<e.vertices.length/3;l++)e.normals.push(0,0,1),e.indices.push(l)}else{for(s=0;s<this.yVertices;s++)for(n=0;n<this.xVertices;n++)e.vertices.push(t.x+n*h,t.y+s*c,t.z);for(e.normals=[],l=0;o*a>l;l++)e.normals.push(0,0,1);for(e.indices=[],l=0;o*(a-1)>l;l++)(l+1)%o!=0&&e.indices.push(l+1,l+o,l,l+o+1,l+o,l+1)}return e.position=this.position,e.rotation=this.rotation,e.scale=this.scale,e},Ayce.Geometry.Icosahedron=function(e){this.subdivisions=e,Ayce.Geometry.call(this)},Ayce.Geometry.Icosahedron.prototype=new Ayce.Geometry,Ayce.Geometry.Icosahedron.prototype.getO3D=function(){var e=new Ayce.Object3D,t=new Ayce.Vector2(.5,(1+Math.sqrt(5))/2-(1+Math.sqrt(5))/2/2),i=new Ayce.Vector2(-t.x,t.y),r=new Ayce.Vector2(t.x,t.y),o=new Ayce.Vector2(-t.x,-t.y),a=new Ayce.Vector2(t.x,-t.y),n=[];n.push(i.x,i.y,0,r.x,r.y,0,o.x,o.y,0,a.x,a.y,0,0,i.x,i.y,0,r.x,r.y,0,o.x,o.y,0,a.x,a.y,i.y,0,i.x,r.y,0,r.x,o.y,0,o.x,a.y,0,a.x),e.vertices=[n[0],n[1],n[2],n[15],n[16],n[17],n[3],n[4],n[5],n[0],n[1],n[2],n[3],n[4],n[5],n[21],n[22],n[23],n[0],n[1],n[2],n[30],n[31],n[32],n[33],n[34],n[35],n[0],n[1],n[2],n[21],n[22],n[23],n[30],n[31],n[32],n[0],n[1],n[2],n[33],n[34],n[35],n[15],n[16],n[17],n[3],n[4],n[5],n[27],n[28],n[29],n[24],n[25],n[26],n[3],n[4],n[5],n[24],n[25],n[26],n[21],n[22],n[23],n[3],n[4],n[5],n[15],n[16],n[17],n[27],n[28],n[29],n[12],n[13],n[14],n[27],n[28],n[29],n[15],n[16],n[17],n[12],n[13],n[14],n[9],n[10],n[11],n[27],n[28],n[29],n[12],n[13],n[14],n[15],n[16],n[17],n[33],n[34],n[35],n[6],n[7],n[8],n[33],n[34],n[35],n[30],n[31],n[32],n[6],n[7],n[8],n[12],n[13],n[14],n[33],n[34],n[35],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[9],n[10],n[11],n[24],n[25],n[26],n[27],n[28],n[29],n[18],n[19],n[20],n[6],n[7],n[8],n[30],n[31],n[32],n[18],n[19],n[20],n[9],n[10],n[11],n[6],n[7],n[8],n[18],n[19],n[20],n[24],n[25],n[26],n[9],n[10],n[11],n[18],n[19],n[20],n[21],n[22],n[23],n[24],n[25],n[26],n[18],n[19],n[20],n[30],n[31],n[32],n[21],n[22],n[23]];var s=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)),h=[e.vertices],c=this.subdivisions-1;i=new Ayce.Vector3(0,0,0),r=new Ayce.Vector3(0,0,0),o=new Ayce.Vector3(0,0,0);for(var l,u=new Ayce.Vector3(0,0,0),d=new Ayce.Vector3(0,0,0),y=new Ayce.Vector3(0,0,0),p=1;c+1>p;p++)h[p]=[];for(p=0;p<h.length-1;p++)for(var f=0;f<h[p].length;f+=9)i.set(h[p][f],h[p][f+1],i.z=h[p][f+2]),r.set(h[p][f+3],h[p][f+4],h[p][f+5]),o.set(h[p][f+6],h[p][f+7],h[p][f+8]),u.set((i.x+r.x)/2,(i.y+r.y)/2,(i.z+r.z)/2),l=s/Math.sqrt(u.x*u.x+u.y*u.y+u.z*u.z),u.x*=l,u.y*=l,u.z*=l,d.set((r.x+o.x)/2*l,(r.y+o.y)/2*l,(r.z+o.z)/2*l),y.set((i.x+o.x)/2*l,(i.y+o.y)/2*l,(i.z+o.z)/2*l),h[p+1].push(i.x,i.y,i.z,u.x,u.y,u.z,y.x,y.y,y.z,r.x,r.y,r.z,d.x,d.y,d.z,u.x,u.y,u.z,o.x,o.y,o.z,y.x,y.y,y.z,d.x,d.y,d.z,u.x,u.y,u.z,d.x,d.y,d.z,y.x,y.y,y.z),f==h[p].length-1&&c--;for(e.vertices=h[h.length-1],e.indices=[],p=0;p<e.vertices.length/3;p++)e.indices.push(p);var g;for(e.normals=[],p=0;p<e.vertices.length;p+=9)i.set(e.vertices[p],e.vertices[p+1],e.vertices[p+2]),r.set(e.vertices[p+3],e.vertices[p+4],e.vertices[p+5]),o.set(e.vertices[p+6],e.vertices[p+7],e.vertices[p+8]),u=r.subtract(i.x,i.y,i.z),y=o.subtract(i.x,i.y,i.z),g=u.crossProduct(y),e.normals.push(g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z);return e.position=this.position,e.rotation=this.rotation,e.scale=this.scale,e},Ayce.Geometry.CollisionMath={},Ayce.Geometry.CollisionMath.ObjectPool={corners1:[new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3],corners2:[new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3],normals:[new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3,new Ayce.Vector3],edgeNormalV1:new Ayce.Vector3,edgeNormalV2:new Ayce.Vector3},Ayce.Geometry.CollisionMath.calcCorner=function(e,t,i,r,o){e.x=i?t.a:0,e.y=r?t.b:0,e.z=o?t.c:0,e.addVector3(t.offset),e.multiply(t.scale.x,t.scale.y,t.scale.z),t.rotation.getConjugate().rotatePoint(e),e.addVector3(t.position)},Ayce.Geometry.CollisionMath.calcNormal=function(e,t,i,r){var o=i.x-t.x,a=i.y-t.y,n=i.z-t.z,s=r.x-t.x,h=r.y-t.y,c=r.z-t.z;e.x=a*c-n*h,e.y=n*s-o*c,e.z=o*h-a*s,e.normalize()},Ayce.Geometry.CollisionMath.getEdgeNormal=function(e,t,i,r){var o=Ayce.Geometry.CollisionMath.ObjectPool.edgeNormalV1;o.x=i.x-t.x,o.y=i.y-t.y,o.z=i.z-t.z,o.normalize();var a=o.x*(r.x-t.x)+o.y*(r.y-t.y)+o.z*(r.z-t.z);e.x=o.x*a+t.x-r.x,e.y=o.y*a+t.y-r.y,e.z=o.z*a+t.z-r.z,e.normalize()},Ayce.Geometry.prototype.boxBoxCollision=function(e,t){var i=Ayce.Geometry.CollisionMath.calcCorner,r=Ayce.Geometry.CollisionMath.calcNormal,o=Ayce.Geometry.CollisionMath.ObjectPool.corners1;i(o[0],e,!1,!1,!1),i(o[1],e,!0,!1,!1),i(o[2],e,!1,!0,!1),i(o[3],e,!0,!0,!1),i(o[4],e,!1,!1,!0),i(o[5],e,!0,!1,!0),i(o[6],e,!1,!0,!0),i(o[7],e,!0,!0,!0);var a=Ayce.Geometry.CollisionMath.ObjectPool.corners2;i(a[0],t,!1,!1,!1),i(a[1],t,!0,!1,!1),i(a[2],t,!1,!0,!1),i(a[3],t,!0,!0,!1),i(a[4],t,!1,!1,!0),i(a[5],t,!0,!1,!0),i(a[6],t,!1,!0,!0),i(a[7],t,!0,!0,!0);var n=Ayce.Geometry.CollisionMath.ObjectPool.normals,s=6;r(n[0],o[0],o[1],o[2]),r(n[1],o[0],o[4],o[2]),r(n[2],o[0],o[1],o[4]),r(n[3],a[0],a[1],a[2]),r(n[4],a[0],a[4],a[2]),r(n[5],a[0],a[1],a[4]);var h,c,l=null;for(h=0;s>h;h++){var u=n[h];if(0!==u.x||0!==u.y||0!==u.z){var d=null,y=null;for(c=0;c<o.length;c++){var p=u.dotProduct(o[c]);(null===d||d>p)&&(d=p),(null===y||p>y)&&(y=p)}var f=null,g=null;for(c=0;c<a.length;c++){var p=u.dotProduct(a[c]);(null===f||f>p)&&(f=p),(null===g||p>g)&&(g=p)}if(f>y||d>g)return null;var m=y-f;Math.abs(g-d)<Math.abs(m)&&(m=g-d),Math.abs(d-g)<Math.abs(m)&&(m=d-g),Math.abs(f-y)<Math.abs(m)&&(m=f-y),d>f&&(m=-m);var x=u.copy().scaleBy(m);(null===l||l.getLength()>x.getLength())&&(l=x,l.normal=u,l.distance=m)}}return l},Ayce.Geometry.prototype.boxSphereCollision=function(e,t,i){(0===e.a||0===e.b||0===e.c)&&(i=!0);var r=Ayce.Geometry.CollisionMath.calcCorner,o=Ayce.Geometry.CollisionMath.calcNormal,a=Ayce.Geometry.CollisionMath.getEdgeNormal,n=Ayce.Geometry.CollisionMath.ObjectPool.corners1;r(n[0],e,!1,!1,!1),r(n[1],e,!0,!1,!1),r(n[2],e,!1,!0,!1),r(n[3],e,!0,!0,!1),r(n[4],e,!1,!1,!0),r(n[5],e,!0,!1,!0),r(n[6],e,!1,!0,!0),r(n[7],e,!0,!0,!0);var s=t.position.copy().addVector3(t.offset),h=Ayce.Geometry.CollisionMath.ObjectPool.normals,c=15;o(h[0],n[0],n[1],n[2]),o(h[1],n[0],n[2],n[4]),o(h[2],n[0],n[4],n[1]),a(h[3],n[0],n[1],s),a(h[4],n[1],n[5],s),a(h[5],n[4],n[5],s),a(h[6],n[4],n[0],s),a(h[7],n[2],n[6],s),a(h[8],n[7],n[6],s),a(h[9],n[7],n[3],s),a(h[10],n[3],n[2],s),a(h[11],n[0],n[2],s),a(h[12],n[1],n[3],s),a(h[13],n[7],n[5],s),a(h[14],n[6],n[4],s);var l,u,d=null;for(l=0;c>l;l++){var y=h[l];if(0!==y.x||0!==y.y||0!==y.z){var p=null,f=null;for(u=0;u<n.length;u++){var g=y.dotProduct(n[u]);(null===p||p>g)&&(p=g),(null===f||g>f)&&(f=g)}var m=y.dotProduct(s),x=m-t.r,v=m+t.r;if(x>f||p>v)return null;var A=f-x;Math.abs(v-p)<Math.abs(A)&&(A=v-p),Math.abs(p-v)<Math.abs(A)&&(A=p-v),Math.abs(x-f)<Math.abs(A)&&(A=x-f);var w=y.copy().scaleBy(A);(i&&p>x||!i&&x>p)&&w.negate(),(null===d||d.getLength()>w.getLength())&&(d=w,d.distance=A,d.normal=y)}}return d},Ayce.Geometry.prototype.sphereSphereCollision=function(e,t){var i=e.position.copy().addVector3(e.offset),r=t.position.copy().addVector3(t.offset),o=i.copy().subtract(r.x,r.y,r.z).getLength();if(o<e.r+t.r){var a=e.position,n=t.position.copy().subtract(a.x,a.y,a.z).normalize().scaleBy(e.r+t.r-o);return n.distance=o,n.normal=n,n}return null},Ayce.Timer=function(){},Ayce.Timer.prototype={},Ayce.Timer.prototype.getCurrentTimeMs=function(){return(new Date).getTime()},Ayce.XMLLoader=function(){},Ayce.XMLLoader.getSourceSynch=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(),200==t.status?t.responseText:null},Ayce.XMLLoader.prototype={},Ayce.Renderer=function(e){var t,i=0,r=this;this.width=0,this.height=0,this.clearColor={red:0,green:0,blue:0},this.init=function(){e.width=this.width,e.height=this.height,a(e),o()},this.resize=function(){e.width=this.width,e.height=this.height,t.viewportWidth=e.width,t.viewportHeight=e.height,r.setViewportAndScissor(0,0,t.viewportWidth,t.viewportHeight)};var o=function(){t.clearColor(r.clearColor.red,r.clearColor.green,r.clearColor.blue,1),r.setViewportAndScissor(0,0,t.viewportWidth,t.viewportHeight),t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),t.cullFace(t.FRONT),t.frontFace(t.CW),t.enable(t.SCISSOR_TEST)},a=function(e){try{var i={alpha:!1};t=e.getContext("webgl",i),t||(t=e.getContext("experimental-webgl",i)),t.viewportWidth=e.width,t.viewportHeight=e.height,t.ext=t.getExtension("OES_vertex_array_object"),t.shaders={},t.ext||console.warn("Can't get OES_vertex_array_object extension.")}catch(r){}t||alert("Could not initialise WebGL.")};this.update=function(e,t,r){for(i=0;i<t.length;i++)t[i].buffer.update(e);for(i=0;i<r.length;i++)r[i].buffer.update(e)},this.render=function(e,r,o){t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);var a;for(i=0;i<r.length;i++)a=r[i].buffer,a.render();for(i=0;i<o.length;i++)a=o[i].buffer,a.render()},this.setViewportAndScissor=function(e,i,r,o){t.viewport(e,i,r,o),t.scissor(e,i,r,o),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)},this.getBuffer=function(e,i){if(!e instanceof Ayce.Object3D)throw"Can't get Buffer for "+e;return new Ayce.BufferMulti(t,e,i)},this.getCanvasHeight=function(){return t.viewportHeight},this.getCanvasWidth=function(){return t.viewportWidth},this.getGL=function(){return t}},Ayce.Renderer.prototype={},Ayce.VRRenderer=function(e,t,i){function r(){var e=h.createFramebuffer();h.bindFramebuffer(h.FRAMEBUFFER,e),y=e.width=1024,p=e.height=1024;var t=h.createTexture();h.bindTexture(h.TEXTURE_2D,t),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.LINEAR),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,e.width,e.height,0,h.RGBA,h.UNSIGNED_BYTE,null);var i=h.createRenderbuffer();return h.bindRenderbuffer(h.RENDERBUFFER,i),h.renderbufferStorage(h.RENDERBUFFER,h.DEPTH_COMPONENT16,e.width,e.height),h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,t,0),h.framebufferRenderbuffer(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.RENDERBUFFER,i),h.bindTexture(h.TEXTURE_2D,null),h.bindRenderbuffer(h.RENDERBUFFER,null),h.bindFramebuffer(h.FRAMEBUFFER,null),[e,t]}function o(){var e,t=m.vertices.slice();for(e=M;e<=m.vertices.length;e+=M)t.splice(e+(e/M-1)*b,0,m.textureCoords[(e/M-1)*b],m.textureCoords[(e/M-1)*b+1]);w=4*(M+b),g=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,g),h.bufferData(h.ARRAY_BUFFER,new Float32Array(t),h.STATIC_DRAW),g.numItems=4,h.enableVertexAttribArray(f.vertexPositionAttribute),h.vertexAttribPointer(f.vertexPositionAttribute,M,h.FLOAT,!1,w,0),h.enableVertexAttribArray(f.textureCoordAttribute),h.vertexAttribPointer(f.textureCoordAttribute,b,h.FLOAT,!1,w,4*M)}function a(e,t){h.bindFramebuffer(h.FRAMEBUFFER,c),v.setViewportAndScissor(0,0,y,p),s(e,"left"),s(t,"left"),h.bindFramebuffer(h.FRAMEBUFFER,l),v.setViewportAndScissor(0,0,y,p),s(e,"right"),s(t,"right"),h.bindFramebuffer(h.FRAMEBUFFER,null),f.initShaders(),h.bindBuffer(h.ARRAY_BUFFER,g),h.vertexAttribPointer(f.vertexPositionAttribute,M,h.FLOAT,!1,w,0),h.vertexAttribPointer(f.textureCoordAttribute,b,h.FLOAT,!1,w,4*M),h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,u),h.uniform1i(f.samplerUniform,0),v.setViewportAndScissor(0,0,h.viewportWidth,h.viewportHeight),h.uniformMatrix4fv(f.pMatrixUniform,!1,x.getPerspectiveMatrix().data),h.uniformMatrix4fv(f.mvMatrixUniform,!1,x.getViewMatrix().data),h.drawArrays(h.TRIANGLE_STRIP,0,g.numItems),h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,d),h.uniform1i(f.samplerUniform,0),v.setViewportAndScissor(h.viewportWidth,0,h.viewportWidth,h.viewportHeight),h.uniformMatrix4fv(f.pMatrixUniform,!1,x.getPerspectiveMatrix().data),h.uniformMatrix4fv(f.mvMatrixUniform,!1,x.getViewMatrix().data),h.drawArrays(h.TRIANGLE_STRIP,0,g.numItems),h.bindTexture(h.TEXTURE_2D,null)}function n(e,t){v.setViewportAndScissor(0,0,h.viewportWidth,h.viewportHeight),s(e,"left"),s(t,"left"),v.setViewportAndScissor(h.viewportWidth,0,h.viewportWidth,h.viewportHeight),s(e,"right"),s(t,"right")}function s(e,t){for(var i=0;i<e.length;i++)e[i].buffer.renderVR(t)}Ayce.Renderer.call(this,e);var h,c,l,u,d,y,p,f,g,m,x,v=this,A=0,w=0,M=3,b=2;this.resize=function(){i?(e.width=i.cameraProperties.renderRectWidth,e.height=i.cameraProperties.renderRectHeight):(console.warn("Can't get renderRect from cameraProperties."),e.width=this.width*window.devicePixelRatio,e.height=this.height*window.devicePixelRatio),e.style.width=this.width+"px",e.style.height=this.height+"px",console.log("Resolution: "+e.width+"x"+e.height," Style: "+e.style.width+" - "+e.style.height),h.viewportWidth=e.width/2,h.viewportHeight=e.height,v.setViewportAndScissor(0,0,h.viewportWidth,h.viewportHeight)};var S=this.init;this.init=function(){console.log("Initializing VRRenderer"),S(),h=this.getGL();var e=r();c=e[0],u=e[1],e=r(),l=e[0],d=e[1],m=new Ayce.VRSquare;var t=Ayce.VRRenderer.prototype.vrCanvasVert,i=Ayce.VRRenderer.prototype.vrCanvasFrag;f=new Ayce.Shader(h,t,i),f.pMatrixUniform=f.getUniformLocation("uPMatrix"),f.mvMatrixUniform=f.getUniformLocation("uMVMatrix"),f.vertexPositionAttribute=f.getAttribLocation("aVertexPosition"),f.textureCoordAttribute=f.getAttribLocation("aTextureCoord"),f.samplerUniform=f.getUniformLocation("uSampler");var a=new Ayce.CameraModifier;a.getPosition().set(0,0,2.3),a.getOrientation().set(0,0,0,1);var n=new Ayce.CameraManager;n.modifiers.push(a),x=new Ayce.Camera(n),x.isOrtho=!0,x.updateProjectionMatrix(),x.update(),o(),h.enable(h.SCISSOR_TEST)},this.update=function(e,t,i){for(A=0;A<t.length;A++)t[A].buffer.updateVR(e);for(A=0;A<i.length;A++)i[A].buffer.updateVR(e)},this.render=function(e,i,r){t?a(i,r):n(i,r)}},Ayce.VRRenderer.prototype=new Ayce.Renderer,Ayce.VRRenderer.prototype.vrCanvasVert="attribute vec3 aVertexPosition;attribute vec2 aTextureCoord;uniform mat4 uMVMatrix;uniform mat4 uPMatrix;varying vec2 vTextureCoord;void main(void) {gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);vTextureCoord = aTextureCoord;}",Ayce.VRRenderer.prototype.vrCanvasFrag="precision mediump float;uniform sampler2D uSampler;uniform bool uUseTextures;varying vec2 vTextureCoord;varying vec4 vColor;void main(void) {    float distance = sqrt(abs(0.5-vTextureCoord.s)*abs(0.5-vTextureCoord.s)+abs(0.5-vTextureCoord.t)*abs(0.5-vTextureCoord.t));    float distanceS = (0.5-vTextureCoord.s);    float distanceT = (0.5-vTextureCoord.t);    float factor = 1.0+0.22*distance*distance+0.24*distance*distance*distance*distance;    float newCoordS = (vTextureCoord.s-0.5)*factor;    float newCoordT = (vTextureCoord.t-0.5)*factor;    float offsetR = 1.0;    float offsetG = 0.995;    float offsetB = 0.980;    float newCoordSR = newCoordS/offsetR+0.5;    float newCoordSG = newCoordS/offsetG+0.5;    float newCoordSB = newCoordS/offsetB+0.5;    float newCoordTR = newCoordT/offsetR+0.5;    float newCoordTG = newCoordT/offsetG+0.5;    float newCoordTB = newCoordT/offsetB+0.5;    if(newCoordSR<0.0||newCoordSR>1.0    ||newCoordSG<0.0||newCoordSG>1.0    ||newCoordSB<0.0||newCoordSB>1.0    ||newCoordTR<0.0||newCoordTR>1.0    ||newCoordTG<0.0||newCoordTG>1.0    ||newCoordTB<0.0||newCoordTB>1.0){        gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);    }else{        float r = texture2D(uSampler, vec2(newCoordSR, newCoordTR)).r;        float g = texture2D(uSampler, vec2(newCoordSG, newCoordTG)).g;        float b = texture2D(uSampler, vec2(newCoordSB, newCoordTB)).b;        gl_FragColor = vec4(r, g, b, 1.0);    }}",Ayce.Scene=function(e){var t=0,i=!0,r=new Ayce.Camera(new Ayce.CameraManager),o=new Ayce.AudioContext,a=null,n=new Ayce.KeyboardHandler;
this.render=!0,this.width=e.parentNode.clientWidth,this.height=e.parentNode.clientHeight;var s=[],h=[],c=new Ayce.LightContainer,l=[];this.resize=function(){this.width=e.parentNode.clientWidth,this.height=e.parentNode.clientHeight,a.width=this.width,a.height=this.height,a.resize(),r.width=a.getCanvasWidth(),r.height=a.getCanvasHeight(),r.updateProjectionMatrix()},this.useWebVR=function(){var t=r.getManager().modifiers;if(t&&t.length>0)throw"Camera modifiers not empty. Please call camera.getManager().clearModifiers() first.";if(!Ayce.HMDHandler.isWebVRReady())return console.warn("Browser dosen't support WebVR."),!1;var i=r.getManager();return i.modifiers.push(new Ayce.WebVR),r.update(),this.setRenderer(new Ayce.VRRenderer(e,!1,i)),r.useVR=!0,!0},this.useCardboard=function(e){this.useMotionSensor(),this.setRendererVR(e),r.useVR=!0,this.resize()},this.useMotionSensor=function(){var e=r.getManager().modifiers;if(e&&e.length>0)throw"Camera modifiers not empty. Please call camera.getManager().clearModifiers() first.";e.push(new Ayce.Cardboard)},this.setRendererDesktop=function(){this.setRenderer(new Ayce.Renderer(e)),r.useVR=!1,this.resize()},this.setRendererVR=function(t){this.setRenderer(new Ayce.VRRenderer(e,t)),r.useVR=!0,this.resize()},this.setRenderer=function(t){var i=null;a&&(t.clearColor=a.clearColor,i=a.getGL().shaders),a=t,a.width=this.width,a.height=this.height,a.init(),e.style.width="auto",e.style.height="auto",i&&(a.getGL().shaders=i)},this.setRendererNull=function(){a=null},this.setFullscreenElement=function(t){var i=this,r=null;t.addEventListener("click",function(){var t=i.getCamera();t.setFullscreen(!t.isFullscreen(),e),t.isFullscreen()?("orientation"in screen&&screen.orientation.lock("landscape-primary").catch(function(){}),window.navigator.requestWakeLock&&(r=window.navigator.requestWakeLock("screen")),window.navigator.wakeLock&&window.navigator.wakeLock.request("screen"),screen.keepAwake=!0):("orientation"in screen&&screen.orientation.unlock().catch(function(){}),window.navigator.requestWakeLock&&r&&r.unlock(),screen.keepAwake=!1)})},this.setRendererDesktop(),window.attachEvent?window.attachEvent("onresize",this.resize):window.addEventListener&&window.addEventListener("resize",this.resize,!0),this.updateScene=function(){for(i&&(u(s),u(h),i=!1),n.update(),r.update(),c.update(r),t=0;t<s.length;t++)s[t].update();for(t=0;t<h.length;t++)h[t].update();for(a.update(r,s,h),t=0;t<l.length;t++){l[t].listenerPosition=r.getManager().getGlobalPosition();var e=r.getManager().getGlobalRotation(),o=e.getForwardVector(),d=e.getUpVector();l[t].listenerOrientationFront.x=o.x,l[t].listenerOrientationFront.y=o.y,l[t].listenerOrientationFront.z=o.z,l[t].listenerOrientationUp.x=d.x,l[t].listenerOrientationUp.y=d.y,l[t].listenerOrientationUp.z=d.z,l[t].update()}},this.drawScene=function(){if(this.render&&!i){for(var e=0,t=0;t<h.length;t++)if(!h[t].renderPriority){var o=h[t].getGlobalPosition(),n=r.getManager();h[t].distance=Math.sqrt(Math.pow(n.getGlobalPosition().x-o.x,2)+Math.pow(n.getGlobalPosition().y-o.y,2)+Math.pow(n.getGlobalPosition().z-o.z,2)),h[t].distance>e&&(e=h[t].distance)}for(t=0;t<h.length;t++)h[t].renderPriority&&(h[t].distance=h[t].renderPriority>0?e+h[t].renderPriority:h[t].renderPriority);h.sort(function(e,t){return t.distance-e.distance}),a.render(r,s,h)}};var u=function(e){for(t=0;t<e.length;t++)e[t].buffer&&e[t].buffer.dispose(),e[t].buffer=a.getBuffer(e[t],c)};this.addToScene=function(e){if(e instanceof Ayce.Light)c.addLight(e),i=!0;else if(e instanceof Ayce.Object3D)i||(e.buffer=a.getBuffer(e,c)),e.calcBoundingBox(),e.calcBoundingSphere(),e.transparent?h.push(e):s.push(e);else{if(!(e instanceof Ayce.Sound))throw"Can't add to scene. Unknown type: "+typeof e;e.init(o),l.push(e)}},this.removeFromScene=function(e){if(e instanceof Ayce.Light)c.removeLight(e);else if(e instanceof Ayce.Object3D){for(t=0;t<s.length;t++)s[t]===e&&s.splice(t,1);for(t=0;t<h.length;t++)h[t]===e&&h.splice(t,1)}else{if(!(e instanceof Ayce.Sound))throw"Can't remove from scene: "+typeof e;for(t=0;t<l.length;t++)l[t]===e&&(l[t].stop(),l.splice(t,1))}},this.getCamera=function(){return r},this.setClearColor=function(e,t,i){a.clearColor.red=e,a.clearColor.green=t,a.clearColor.blue=i,a.getGL().clearColor(e,t,i,1)},this.setAmbientLight=function(e,t,i){c.ambientLight.red=e,c.ambientLight.green=t,c.ambientLight.blue=i}},Ayce.Light=function(){this.position=new Ayce.Vector3,this.color={red:1,green:1,blue:1},this.specularColor={red:1,green:1,blue:1}},Ayce.LightContainer=function(){var e=[];this.locationsArray=[],this.locationsArrayLeftEye=[],this.locationsArrayRightEye=[],this.colorsArray=[],this.specColorsArray=[],this.lightsCount=0,this.ambientLight={red:.5,green:.5,blue:.5};var t=new Ayce.Vector3;this.addLight=function(t){e.push(t),this.lightsCount=e.length},this.removeLight=function(t){var i=e.indexOf(t);-1!==i&&e.splice(i,1),this.locationsArray.splice(i,1),this.colorsArray.splice(i,1),this.specColorsArray.splice(i,1)},this.update=function(i){var r,o,a=0;if(i.useVR){for(r=i.getViewMatrix("left"),a=0;a<e.length;a++)Ayce.Vector3.prototype.copyToVector(e[a].position,t),o=r.transformVector(t),this.locationsArrayLeftEye[3*a+0]=o.x,this.locationsArrayLeftEye[3*a+1]=o.y,this.locationsArrayLeftEye[3*a+2]=o.z;for(r=i.getViewMatrix("right"),a=0;a<e.length;a++)Ayce.Vector3.prototype.copyToVector(e[a].position,t),o=r.transformVector(t),this.locationsArrayRightEye[3*a+0]=o.x,this.locationsArrayRightEye[3*a+1]=o.y,this.locationsArrayRightEye[3*a+2]=o.z}else for(r=i.getViewMatrix(),a=0;a<e.length;a++)Ayce.Vector3.prototype.copyToVector(e[a].position,t),o=r.transformVector(t),this.locationsArray[3*a+0]=o.x,this.locationsArray[3*a+1]=o.y,this.locationsArray[3*a+2]=o.z;for(a=0;a<e.length;a++)this.colorsArray[3*a+0]=e[a].color.red,this.colorsArray[3*a+1]=e[a].color.green,this.colorsArray[3*a+2]=e[a].color.blue,this.specColorsArray[3*a+0]=e[a].specularColor.red,this.specColorsArray[3*a+1]=e[a].specularColor.green,this.specColorsArray[3*a+2]=e[a].specularColor.blue;this.lightsCount=e.length}},Ayce.LightContainer.prototype={},Ayce.Buffer=function(e,t,i,r,o,a){a=a||e.TRIANGLES;var n,s,h,c,l=[],u=[],d=[];this.indices=null,this.useTexture=!1,this.useSpecularMap=!1,this.useTransparency=!1,this.texturesO3D=null,this.isSkybox=!1;var y=!1,p=!1,f=!1,g=0,m=0;this.init=function(){y=this.useTexture,p=this.useSpecularMap,f=this.useNormalMap;var a,x=0;for(g=0;g<r.length;g++)a=r[g],a[3]=i.getAttribLocation(a[0]),a[4]=x,x+=4*a[1],m+=4*a[1];for(g=0;g<o.length;g++){var v=o[g];v[4]=new Array(1+v[3].length),v[4][0]=i.getUniformLocation(v[0])}if(this.useTexture)for(i.samplerUniform=i.getUniformLocation("uSampler"),g=0;g<this.texturesO3D.length;g++)l.push(this.loadImage(e,this.texturesO3D[g],this.isSkybox));if(this.useSpecularMap)for(this.texturesO3D=Array.isArray(t.specularMap)?t.specularMap:[t.specularMap],i.specularMapUniform=i.getUniformLocation("uSpecularMapSampler"),g=0;g<this.texturesO3D.length;g++)u.push(this.loadImage(e,this.texturesO3D[g],this.isSkybox));if(this.useNormalMap)for(this.texturesO3D=Array.isArray(t.normalMap)?t.normalMap:[t.normalMap],i.normalMapUniform=i.getUniformLocation("uNormalMapSampler"),g=0;g<this.texturesO3D.length;g++)d.push(this.loadImage(e,this.texturesO3D[g],this.isSkybox));for(var A=[],w=0;w<r[0][2].length/r[0][1];w++)for(g=0;g<r.length;g++)a=r[g],this.pushData(A,a[2],w,a[1]);if(s=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array(A),e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),n=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),h=this.indices.length,e.ext){for(c=e.ext.createVertexArrayOES(),e.ext.bindVertexArrayOES(c),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n),e.bindBuffer(e.ARRAY_BUFFER,s),g=0;g<r.length;g++)a=r[g],this.setupAttribPointer(e,a[3],a[1],m,a[4]),x+=4*a[1];e.bindBuffer(e.ARRAY_BUFFER,null),e.ext.bindVertexArrayOES(null)}},this.update=function(){y&&(y=x(y,l)),p&&(p=x(p,u)),f&&(f=x(f,d))};var x=function(e,t){if(e){var i=!0;for(g=0;g<t.length;g++)if(!t[g].loaded){i=!1;break}e=!i}return e};this.render=function(){if(!(y||p||f)){if(this.useTransparency&&(e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)),i.initShaders(),this.useTexture&&this.activateTextures(e,i.samplerUniform,l),this.useSpecularMap){for(g=0;g<u.length;g++)e.activeTexture(e.TEXTURE0+l.length+g),e.bindTexture(e.TEXTURE_2D,u[g]);e.uniform1i(i.specularMapUniform,1)}if(this.useNormalMap){for(g=0;g<d.length;g++)e.activeTexture(e.TEXTURE0+l.length+g),e.bindTexture(e.TEXTURE_2D,d[g]);e.uniform1i(i.normalMapUniform,1)}for(g=0;g<o.length;g++){var t=o[g];if(t[4][1]=t[3],t[2])for(var x=0;x<t[3].length;x++)t[4][x+1]=t[2][t[3][x]]}for(g=0;g<o.length;g++)if("uniform1f"===o[g][1])e.uniform1f(o[g][4][0],o[g][4][1]);else if("uniform1fv"===o[g][1])e.uniform1fv(o[g][4][0],o[g][4][1]);else if("uniform1i"===o[g][1])e.uniform1i(o[g][4][0],o[g][4][1]);else if("uniform1iv"===o[g][1])e.uniform1iv(o[g][4][0],o[g][4][1]);else if("uniform2f"===o[g][1])e.uniform2f(o[g][4][0],o[g][4][1],o[g][4][2]);else if("uniform2fv"===o[g][1])e.uniform2fv(o[g][4][0],o[g][4][1]);else if("uniform2i"===o[g][1])e.uniform2i(o[g][4][0],o[g][4][1],o[g][4][2]);else if("uniform2iv"===o[g][1])e.uniform2iv(o[g][4][0],o[g][4][1]);else if("uniform3f"===o[g][1])e.uniform3f(o[g][4][0],o[g][4][1],o[g][4][2],o[g][4][3]);else if("uniform3fv"===o[g][1])e.uniform3fv(o[g][4][0],o[g][4][1]);else if("uniform3i"===o[g][1])e.uniform3i(o[g][4][0],o[g][4][1],o[g][4][2],o[g][4][3]);else if("uniform3iv"===o[g][1])e.uniform3iv(o[g][4][0],o[g][4][1]);else if("uniform4f"===o[g][1])e.uniform4f(o[g][4][0],o[g][4][1],o[g][4][2],o[g][4][3],o[g][4][4]);else if("uniform4fv"===o[g][1])e.uniform4fv(o[g][4][0],o[g][4][1]);else if("uniform4i"===o[g][1])e.uniform4i(o[g][4][0],o[g][4][1],o[g][4][2],o[g][4][3],o[g][4][4]);else if("uniform4iv"===o[g][1])e.uniform4iv(o[g][4][0],o[g][4][1]);else if("uniformMatrix2fv"===o[g][1])e.uniformMatrix2fv(o[g][4][0],o[g][4][1],o[g][4][2]);else if("uniformMatrix3fv"===o[g][1])e.uniformMatrix3fv(o[g][4][0],o[g][4][1],o[g][4][2]);else{if("uniformMatrix4fv"!==o[g][1])throw"Unkown: "+o[g][1];e.uniformMatrix4fv(o[g][4][0],o[g][4][1],o[g][4][2])}if(e.ext)e.ext.bindVertexArrayOES(c),e.drawElements(a,h,e.UNSIGNED_SHORT,0),e.ext.bindVertexArrayOES(null);else{for(e.bindBuffer(e.ARRAY_BUFFER,s),g=0;g<r.length;g++){var v=r[g];this.setupAttribPointer(e,v[3],v[1],m,v[4])}e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n),e.drawElements(a,h,e.UNSIGNED_SHORT,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}this.useTransparency&&e.disable(e.BLEND)}},this.dispose=function(){e.deleteBuffer(n),e.deleteBuffer(s)},this.getTextureData=function(){return{textures:l,specularMaps:u,normalMaps:d}}},Ayce.Buffer.prototype={pushData:function(e,t,i,r){var o;for(o=0;r>o;o++)e.push(t[i*r+o])},setupAttribPointer:function(e,t,i,r,o){e.enableVertexAttribArray(t),e.vertexAttribPointer(t,i,e.FLOAT,!1,r,o)},loadedTextures:{},loadImage:function(e,t,i){var r=this,o=e.createTexture();o.loaded=!1;var a=e.REPEAT;return(i||t.clamp)&&(a=e.CLAMP_TO_EDGE),t=t.source?t.source:t,this.loadedTextures[t]?(o.loaded=!0,this.loadedTextures[t]):(o.image=new Image,o.image.src=t,o.image.onload=function(){r.loadTexture(e,o,o.image,a),o.loaded=!0},this.loadedTextures[t]=o,o)},loadTexture:function(e,t,i,r){r=r||e.REPEAT,e.bindTexture(e.TEXTURE_2D,t),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,r),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null)},activateTextures:function(e,t,i){for(var r=[],o=0;o<i.length;o++)e.activeTexture(e.TEXTURE0+o),e.bindTexture(e.TEXTURE_2D,i[o]),r.push(o);e.uniform1iv(t,r)}},Ayce.BufferMulti=function(e,t,i){if(!t instanceof Ayce.Object3D)throw"Can't create buffers for "+t;var r=new Ayce.Matrix4;r.transposeUniform=!1;var o=new Ayce.Matrix4,a=new Ayce.Matrix4,n=new Ayce.Matrix3,s=new Ayce.Matrix3,h=null,c=null,l=3,u=3,d=2,y=1,p=4,f=Boolean(t.normals)&&i.lightsCount>0,g=Boolean(t.normals)&&(f||t.shader),m=Array.isArray(t.imageSrc)?t.imageSrc.length:1,x=t.isWireframe;this.transparent=t.transparent;var v=Boolean(t.geometries&&t.velocities&&t.rotationAngles&&t.lifetimes&&t.gravities&&t.gravityExps),A=[];A.push(["aVertexPosition",l,t.vertices]),t.textureCoords&&t.imageSrc&&A.push(["aTextureCoord",d,t.textureCoords]),t.textureCoords&&t.imageSrc&&t.textureIndices&&m>1&&A.push(["aTextureIndex",y,t.textureIndices]),t.colors&&A.push(["aVertexColor",p,t.colors]),g&&A.push(["aVertexNormal",u,t.normals]),t.shaderAttributes&&Array.prototype.push.apply(A,t.shaderAttributes);var w={transposeUniform:!1,data:[]},M={time:0,startTime:Date.now()},b={useTexture:Boolean(t.textureCoords&&t.imageSrc),useLighting:f,useMultiTex:Boolean(t.textureIndices),normalMatrix:new Ayce.Matrix3,useSpecularMap:Boolean(t.specularMap),useNormalMap:Boolean(t.normalMap)},S=[];S.push(["uPMatrix","uniformMatrix4fv",w,["transposeUniform","data"]]),S.push(["uMVMatrix","uniformMatrix4fv",r,["transposeUniform","data"]]),g&&(b.normalMatrix.transposeUniform=!1,S.push(["uNMatrix","uniformMatrix3fv",b.normalMatrix,["transposeUniform","data"]])),f&&(S.push(["uAmbientColor","uniform3f",i.ambientLight,["red","green","blue"]]),S.push(["uPointLightingLocations","uniform3fv",i,["locationsArray"]]),S.push(["uPointLightingColors","uniform3fv",i,["colorsArray"]]),S.push(["uSpecularColors","uniform3fv",i,["specColorsArray"]]),S.push(["uShininess","uniform1f",t,["shininess"]])),v&&S.push(["uTime","uniform1f",M,["time"]]),t.shaderUniforms&&Array.prototype.push.apply(S,t.shaderUniforms);var C=null,R=null,T="";if(t.shader)C=Ayce.XMLLoader.getSourceSynch(t.shader+".vert"),R=Ayce.XMLLoader.getSourceSynch(t.shader+".frag"),T="A"+t.shader,t.logVertexShader&&console.log(C),t.logFragmentShader&&console.log(R);else{var V=new Ayce.ShaderGenerator;f&&(V.useVertexLighting=Boolean(t.normals&&!t.useFragmentLighting),V.lightsCount=i.lightsCount,V.useFragmentLighting=Boolean(t.normals&&t.useFragmentLighting),V.useSpecularLighting=t.useSpecularLighting),V.useNormals=g,V.useColor=Boolean(t.colors),V.texturesCount=Array.isArray(t.imageSrc)?t.imageSrc.length:1,V.useTexture=Boolean(t.imageSrc&&t.textureCoords),V.useSpecularMap=Boolean(t.specularMap&&t.useSpecularLighting),V.useNormalMap=Boolean(t.normalMap),V.isParticleSystem=v,V.init(),C=V.vertexShader,R=V.fragmentShader,T="B"+V.useNormals+V.lightsCount+V.texturesCount+V.useVertexLighting+V.useFragmentLighting+V.useTexture+V.useColor+V.useSpecularMap+V.useNormalMap+V.isParticleSystem,t.logVertexShader&&console.log(C.replace(/;/g,";\n").replace(/{/g,"{\n").replace(/}/g,"}\n")),t.logFragmentShader&&console.log(R.replace(/;/g,";\n").replace(/{/g,"{\n").replace(/}/g,"}\n"))}var z=null;e.shaders[T]?z=e.shaders[T]:(z=new Ayce.Shader(e,C,R),e.shaders[T]=z);var P=x?e.LINES:void 0,E=new Ayce.Buffer(e,t,z,A,S,P);if(t.twoFaceTransparency){var L=t.indices;L=L.slice().reverse().concat(L),E.indices=new Uint16Array(L)}else E.indices=new Uint16Array(t.indices);E.useTexture=Boolean(t.textureCoords&&t.imageSrc),E.useSpecularMap=Boolean(t.textureCoords&&t.specularMap),E.useNormalMap=Boolean(t.textureCoords&&t.normalMap),E.useTransparency=t.transparent,E.texturesO3D=Array.isArray(t.imageSrc)?t.imageSrc:[t.imageSrc],E.isSkybox=Boolean(t.isSkybox),E.init();var D=new Ayce.Matrix4;this.update=function(e){Ayce.Matrix4.prototype.copyToMatrix(t.modelMatrix,r),r.apply(e.getViewMatrix()),Ayce.Matrix4.prototype.copyToMatrix(r,D),D.invert(),D.transpose(),D.getMatrix3(b.normalMatrix),w.data=e.getPerspectiveMatrix().data,M=Date.now()-M.startTime,E.update()},this.render=function(){t.visible&&E.render()},this.updateVR=function(e){Ayce.Matrix4.prototype.copyToMatrix(t.modelMatrix,o),o.apply(e.getViewMatrix("left")),Ayce.Matrix4.prototype.copyToMatrix(o,D),D.invert(),D.transpose(),D.getMatrix3(n),Ayce.Matrix4.prototype.copyToMatrix(t.modelMatrix,a),a.apply(e.getViewMatrix("right")),Ayce.Matrix4.prototype.copyToMatrix(a,D),D.invert(),D.transpose(),D.getMatrix3(s),h=e.getPerspectiveMatrix("left"),c=e.getPerspectiveMatrix("right"),E.update()},this.renderVR=function(e){t.visible&&("left"===e?(r.data=o.data,b.normalMatrix.data=n.data,w.data=h.data,i.locationsArray=i.locationsArrayLeftEye):"right"===e&&(r.data=a.data,b.normalMatrix.data=s.data,w.data=c.data,i.locationsArray=i.locationsArrayRightEye),E.render())},this.dispose=function(){E.dispose()},this.updateTexture=function(t,i){Ayce.Buffer.prototype.loadTexture(e,t,i)},this.getTextureData=function(){return E.getTextureData()}},Ayce.BufferMulti.prototype={},Ayce.Shader=function(e,t,i){var r=e.createShader(e.VERTEX_SHADER);if(e.shaderSource(r,t),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))return alert("ShaderVert: \n"+e.getShaderInfoLog(r)),null;var o=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(o,i),e.compileShader(o),!e.getShaderParameter(r,e.COMPILE_STATUS))return alert("ShaderFrag: \n"+e.getShaderInfoLog(o)),null;var a=e.createProgram();e.attachShader(a,r),e.attachShader(a,o),e.linkProgram(a),e.getProgramParameter(a,e.LINK_STATUS)||alert("Could not initialise shaders"),e.validateProgram(a),this.initShaders=function(){a!==Ayce.Shader.prototype.currentShader&&(e.useProgram(a),Ayce.Shader.prototype.currentShader=a)},this.getAttribLocation=function(t){return e.getAttribLocation(a,t)},this.getUniformLocation=function(t){return e.getUniformLocation(a,t)}},Ayce.Shader.prototype={currentShader:null},Ayce.ShaderGenerator=function(){this.lightsCount=2,this.texturesCount=1,this.useNormals=!1,this.useVertexLighting=!1,this.useFragmentLighting=!1,this.useSpecularLighting=!1,this.useTexture=!1,this.useColor=!1,this.useSpecularMap=!1,this.useNormalMap=!1,this.isParticleSystem=!1;var e=!1;this.vertexShader="",this.fragmentShader="",this.init=function(){this.useTexture||(this.useSpecularMap=!1,this.useNormalMap=!1),e=Boolean(this.texturesCount>1),this.vertexShader+="attribute vec3 aVertexPosition;",this.useColor&&(this.vertexShader+="attribute vec4 aVertexColor;"),this.useTexture&&(this.vertexShader+="attribute vec2 aTextureCoord;"),this.useNormals&&(this.vertexShader+="attribute vec3 aVertexNormal;"),this.isParticleSystem&&(this.vertexShader+="attribute vec3 aGeometryPosition;attribute vec3 aVertexVelocity;attribute vec3 aVertexRotation;attribute float aLifetime;attribute float aGravity;attribute float aGravityExponent;"),this.useTexture&&e&&(this.vertexShader+="attribute float aTextureIndex;"),this.vertexShader+="uniform mat4 uMVMatrix;uniform mat4 uPMatrix;",this.isParticleSystem&&(this.vertexShader+="uniform float uTime;"),this.useNormals&&(this.vertexShader+="uniform mat3 uNMatrix;"),this.useVertexLighting&&(this.vertexShader+="uniform vec3 uAmbientColor;uniform vec3 uPointLightingLocations["+this.lightsCount+"];uniform vec3 uPointLightingColors["+this.lightsCount+"];const int cLightCount = "+this.lightsCount+";",this.useSpecularLighting&&(this.vertexShader+="uniform float uShininess;"),this.useSpecularLighting&&(this.vertexShader+="uniform vec3 uSpecularColors["+this.lightsCount+"];")),this.useColor&&(this.vertexShader+="varying vec4 vColor;"),this.useTexture&&(this.vertexShader+="varying vec2 vTextureCoord;"),this.useVertexLighting?this.vertexShader+="varying vec3 vLightWeighting;":this.useFragmentLighting&&(this.vertexShader+="varying vec3 vTransformedNormal;varying vec4 vPosition;"),this.useTexture&&e&&(this.vertexShader+="varying float vTextureIndex;"),this.vertexShader+="void main(void) {",this.isParticleSystem?this.vertexShader+="float factor;if(aLifetime==0.0){factor = uTime;}else{factor = mod(uTime, aLifetime);}vec3 distance = aGeometryPosition - aVertexPosition;float xAngle = aVertexRotation.x*factor;float yAngle = aVertexRotation.y*factor;float zAngle = aVertexRotation.z*factor;mat4 xRotation = mat4(1.0,	 		 0.0,			 0.0,			 0.0,0.0,			 cos(xAngle),	 sin(xAngle),	 0.0,0.0,			-sin(xAngle),	 cos(xAngle),	 0.0,0.0,	 		 0.0,			 0.0,			 1.0);mat4 yRotation = mat4(cos(yAngle),	 0.0,			-sin(yAngle),	 0.0,0.0,			 1.0,	 		 0.0,			 0.0,sin(yAngle),	 0.0,	 		 cos(yAngle),	 0.0,0.0,			 0.0,	 		 0.0,			 1.0);mat4 zRotation = mat4(cos(zAngle),	 sin(zAngle),	 0.0,			 0.0,-sin(zAngle),	 cos(zAngle),	 0.0,			 0.0,0.0,			 0.0,			 1.0,			 0.0,0.0,			 0.0,			 0.0,			 1.0);vec4 position = vec4(aGeometryPosition, 1.0)*xRotation*yRotation*zRotation;position = position-vec4(distance, 0.0);vec3 velocity = aVertexVelocity+vec3(0.0, aGravity*pow(factor, aGravityExponent),0.0);position = uMVMatrix * vec4(position.xyz+velocity*factor, 1.0);":this.useFragmentLighting?this.useFragmentLighting&&(this.vertexShader+="vPosition = uMVMatrix * vec4(aVertexPosition, 1.0);vec4 position = vPosition;"):this.vertexShader+="vec4 position = uMVMatrix * vec4(aVertexPosition, 1.0);",this.vertexShader+="gl_Position = uPMatrix * position;",this.useTexture&&e&&(this.vertexShader+="vTextureIndex = aTextureIndex;"),this.useTexture&&(this.vertexShader+="vTextureCoord = aTextureCoord;"),this.useColor&&(this.vertexShader+="vColor = aVertexColor;"),this.useVertexLighting?(this.vertexShader+="vLightWeighting = uAmbientColor;",this.vertexShader+=this.isParticleSystem?"vec3 transformedNormal = uNMatrix * (vec4(aVertexNormal, 1.0) * xRotation * yRotation * zRotation).xyz;":"vec3 transformedNormal = uNMatrix * aVertexNormal;",this.vertexShader+="vec3 normal = normalize(transformedNormal);vec3 eyeDirection = normalize(-position.xyz);"+this.getVertexLightingWeightCalcArrayVertex(this.lightsCount,this.useSpecularLighting)):this.useFragmentLighting&&(this.vertexShader+=this.isParticleSystem?"vTransformedNormal = uNMatrix * (vec4(aVertexNormal, 1.0) * xRotation * yRotation * zRotation).xyz;":"vTransformedNormal = uNMatrix * aVertexNormal;"),this.vertexShader+="}",this.fragmentShader+="precision mediump float;",this.useVertexLighting?this.fragmentShader+="varying vec3 vLightWeighting;":this.useFragmentLighting&&(this.fragmentShader+="varying vec3 vTransformedNormal;varying vec4 vPosition;uniform vec3 uAmbientColor;uniform vec3 uPointLightingLocations["+this.lightsCount+"];uniform vec3 uPointLightingColors["+this.lightsCount+"];const int cLightCount = "+this.lightsCount+";",this.useSpecularLighting&&(this.fragmentShader+="uniform float uShininess;"),this.useSpecularLighting&&(this.fragmentShader+="uniform vec3 uSpecularColors["+this.lightsCount+"];")),this.useColor&&(this.fragmentShader+="varying vec4 vColor;"),this.useTexture&&(this.fragmentShader+="varying vec2 vTextureCoord;",this.fragmentShader+=e?"varying float vTextureIndex;uniform sampler2D uSampler["+this.texturesCount+"];":"uniform sampler2D uSampler;"),this.useSpecularMap&&(this.fragmentShader+="uniform sampler2D uSpecularMapSampler;"),this.useNormalMap&&(this.fragmentShader+="uniform sampler2D uNormalMapSampler;"),this.fragmentShader+="void main(void) {vec4 fragmentColor;",this.useFragmentLighting&&(this.fragmentShader+="vec3 lightWeighting = uAmbientColor;vec3 normal = normalize(vTransformedNormal);vec3 eyeDirection = normalize(-vPosition.xyz);"+this.getFragmentLightingWeightCalcArrayVertex(this.lightsCount,this.useSpecularMap,this.useNormalMap,this.useSpecularLighting)),this.useTexture&&e?(this.fragmentShader+="if (vTextureCoord.x > -0.5 && vTextureCoord.y > -0.5) {vec4 tex = vec4(0.0);float i = vTextureIndex;"+this.getTextureCalcArray(this.texturesCount)+"fragmentColor = tex;} else {",this.fragmentShader+=this.useColor?"fragmentColor = vColor;":"fragmentColor = vec4(0.5, 0.5, 0.5, 1.0);",this.fragmentShader+="}"):this.fragmentShader+=this.useTexture?"fragmentColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));":this.useColor?"fragmentColor = vColor;":"fragmentColor = vec4(0.5, 0.5, 0.5, 1.0);",this.fragmentShader+=this.useVertexLighting?"gl_FragColor = vec4(fragmentColor.rgb * vLightWeighting, fragmentColor.a);":this.useFragmentLighting?"gl_FragColor = vec4(fragmentColor.rgb * lightWeighting, fragmentColor.a);":"gl_FragColor = fragmentColor;",this.fragmentShader+="}"}},Ayce.ShaderGenerator.prototype={getVertexLightingWeightCalcArrayVertex:function(e,t){var i="";return i+="for(int i = 0; i < cLightCount; i++){vec3 lightDirection = normalize(uPointLightingLocations[i] - position.xyz);vec3 reflectionDirection = reflect(-lightDirection, normal);float diffuseLightWeighting = max(dot(normalize(transformedNormal), lightDirection), 0.0);",i+=t?"float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uShininess);vLightWeighting += uPointLightingColors[i] * diffuseLightWeighting + uSpecularColors[i] * specularLightWeighting;":"vLightWeighting += uPointLightingColors[i] * diffuseLightWeighting;",i+="}"},getFragmentLightingWeightCalcArrayVertex:function(e,t,i,r){var o="";return o+="for(int i = 0; i < cLightCount; i++){vec3 lightDirection = normalize(uPointLightingLocations[i] - vPosition.xyz);vec3 reflectionDirection = reflect(-lightDirection, normal);",t?o+="float shininess = texture2D(uSpecularMapSampler, 255.0-vec2(vTextureCoord.s, vTextureCoord.t)).r * 255.0 * uShininess;float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), shininess);":r&&(o+="float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uShininess);"),o+=i?"vec3 normalMap = texture2D(uNormalMapSampler, vec2(vTextureCoord.s, vTextureCoord.t)).rgb*2.0-1.0;float diffuseLightWeighting = max(dot(normalize(normalMap), lightDirection), 0.0);":"float diffuseLightWeighting = max(dot(normalize(vTransformedNormal), lightDirection), 0.0);",o+=r?"lightWeighting += uPointLightingColors[i] * diffuseLightWeighting + uSpecularColors[i] * specularLightWeighting;":"lightWeighting += uPointLightingColors[i] * diffuseLightWeighting;",o+="}"},getTextureCalcArray:function(e){for(var t="",i=0;e>i;i++)0!==i&&(t+="else "),t+="if(i-"+i+".0 < 0.01){tex = texture2D(uSampler["+i+"], vec2(vTextureCoord.s, vTextureCoord.t));}";return t}},Ayce.Sound=function(e){var t=this;this.soundLoaded=!1,this.position=new Ayce.Vector3(0,0,0),this.orientationFront=new Ayce.Vector3(0,0,0),this.orientationUp=new Ayce.Vector3(0,1,0),this.listenerPosition=new Ayce.Vector3(0,0,0),this.listenerOrientationFront=new Ayce.Vector3(0,0,0),this.listenerOrientationUp=new Ayce.Vector3(0,1,0),this.loop=!0,this.is3D=!0,this.volume=1,this.isPlaying=!1;var i,r,o,a,n,s,h=0;this.init=function(r){i=r.audioContext;var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="arraybuffer",o.onload=function(){i.decodeAudioData(this.response,function(e){a=e,t.soundLoaded=!0},function(){alert("Decoding the audio buffer failed")})},o.send()},this.update=function(){t.soundLoaded&&t.isPlaying&&(t.is3D&&(r.setPosition(t.position.x,t.position.y,t.position.z),r.panningModel="HRTF",r.distanceModel="linear",i.listener.setOrientation(-t.listenerOrientationFront.x,-t.listenerOrientationFront.y,t.listenerOrientationFront.z,t.listenerOrientationUp.x,t.listenerOrientationUp.y,-t.listenerOrientationUp.z),i.listener.setPosition(-t.listenerPosition.x,-t.listenerPosition.y,-t.listenerPosition.z)),n.gain.value=this.volume,o.loop=this.loop)},this.play=function(){t.soundLoaded?(o=i.createBufferSource(),o.buffer=a,n=i.createGain(),this.is3D?(r=i.createPanner(),o.connect(r),r.connect(n),r.panningModel="HRTF",r.distanceModel="linear"):o.connect(n),n.connect(i.destination),t.update(),o.start(h),s=Date.now(),this.isPlaying=!0):console.error("The audio file is not done loading.")},this.pause=function(){t.soundLoaded?(o.stop(),this.isPlaying=!1,h=(Date.now()-s)%Math.floor(1e3*a.duration)/1e3):console.error("The audio file is not done loading.")},this.stop=function(){t.soundLoaded?(o.stop(),this.isPlaying=!1,h=0):console.error("The audio file is not done loading.")}},Ayce.AudioContext=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext||null,window.AudioContext?this.audioContext=new AudioContext:(this.audioContext={},console.error("AudioContext is not supported by your browser"))},Ayce.Camera=function(e){var t=this;this.useVR=!1;var i=!1,r=new Ayce.Vector3,o=new Ayce.Quaternion,a=new Ayce.Matrix4,n=new Ayce.Matrix4,s=new Ayce.Matrix4,h=new Ayce.Matrix4,c=null,l=null,u=null;this.fieldOfView=60,this.nearPlane=.1,this.farPlane=200,this.width=1,this.height=1,this.isOrtho=!1;var d=new Ayce.Vector3;this.update=function(){e.update(),r=e.getGlobalPosition(),o=e.getGlobalRotation().getConjugate(),y()},this.updateProjectionMatrix=function(){var t=this.width/this.height;e&&e.isInputVR()&&e.cameraProperties.eyeFOVL?(l=Ayce.Matrix4.makeVRPerspective(e.cameraProperties.eyeFOVL,this.nearPlane,this.farPlane),u=Ayce.Matrix4.makeVRPerspective(e.cameraProperties.eyeFOVR,this.nearPlane,this.farPlane)):c=this.isOrtho?Ayce.Matrix4.makeOrthoPerspective(-1,1,1,-1,.5,1.5):Ayce.Matrix4.makePerspective(this.fieldOfView,t,this.nearPlane,this.farPlane)},this.setFullscreen=function(t,r){if(i!==t){if(i=t,!t)return void(document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen());var o={};void 0!==e.cameraProperties.vrDevice&&(o.vrDisplay=e.cameraProperties.vrDevice,o.vrTimewarp=!0),r.requestFullscreen?r.requestFullscreen(o):r.msRequestFullscreen?r.msRequestFullscreen(o):r.mozRequestFullScreen?r.mozRequestFullScreen(o):r.webkitRequestFullscreen&&r.webkitRequestFullscreen(o)}};var y=function(){if(t.useVR){var i=e.cameraProperties.eyeTranslationL,c=e.cameraProperties.eyeTranslationR;s.identity(),s.applyTranslation(-r.x,-r.y,-r.z),o.toRotationMatrix(a),s.apply(a),s.applyTranslation(-i,0,0),h.identity(),h.applyTranslation(-r.x,-r.y,-r.z),o.toRotationMatrix(a),h.apply(a),h.applyTranslation(-c,0,0)}else n.identity(),n.applyTranslation(-r.x,-r.y,-r.z),o.toRotationMatrix(a),n.apply(a)};this.getManager=function(){return e},this.getViewMatrix=function(e){return"left"===e?s:"right"===e?h:n},this.getPerspectiveMatrix=function(e){return"left"===e&&null!==l?l:"right"===e&&null!==u?u:c},this.getEyeTranslation=function(t){return"left"===t?e.cameraProperties.eyeTranslationL:"right"===t?e.cameraProperties.eyeTranslationR:null},this.getForwardVector=function(){return t.useVR?(d.x=-s.data[2],d.y=-s.data[6],d.z=-s.data[10],d):(d.x=-n.data[2],d.y=-n.data[6],d.z=-n.data[10],d)},this.isFullscreen=function(){return i}},Ayce.Camera.prototype={},Ayce.CameraManager=function(){var e=this,t=new Ayce.Vector3,i=new Ayce.Quaternion;this.cameraProperties={vrDevice:null,eyeTranslationL:-.03,eyeTranslationR:.03,eyeFOVR:90,renderRectWidth:null,renderRectHeight:null},this.modifiers=[];var r=!1,o=function(t){var i=t[0],r=t[1];e.cameraProperties.vrDevice=vrDevice,e.cameraProperties.eyeTranslationL=i.eyeTranslation.x,e.cameraProperties.eyeTranslationR=r.eyeTranslation.x,e.cameraProperties.eyeFOVL=i.recommendedFieldOfView,e.cameraProperties.eyeFOVR=r.recommendedFieldOfView;var o=i.renderRect,a=r.renderRect;e.cameraProperties.renderRectWidth=a.x+a.width,e.cameraProperties.renderRectHeight=Math.max(o.y+o.height,a.y+a.height)};this.update=function(){var e;for(e=0;e<this.modifiers.length;e++)this.modifiers[e].update(this.getGlobalRotation().getConjugate());for(t.nullVector(),i.reset(),e=0;e<this.modifiers.length;e++){if(!r&&this.modifiers[e]instanceof Ayce.WebVR){var a=this.modifiers[e].getHMDData();null!==a&&(o(a),r=!0)}i.multiply(i,this.modifiers[e].getOrientation());var n=this.modifiers[e].getPosition();t.add(n.x,n.y,n.z)}},this.getGlobalPosition=function(){return t},this.getGlobalRotation=function(){return i},this.clearModifiers=function(){this.modifiers=[]},this.isInputVR=function(){for(var e=0;e<this.modifiers.length;e++)if(this.modifiers[e]instanceof Ayce.WebVR)return!0;
return!1}},Ayce.CameraManager.prototype={},Ayce.CameraModifier=function(){this.position=new Ayce.Vector3,this.orientation=new Ayce.Quaternion,this.update=function(){},this.getOrientation=function(){return this.orientation},this.getPosition=function(){return this.position},this.getHMDData=function(){return null}},Ayce.Cardboard=function(){Ayce.CameraModifier.call(this);var e=new Ayce.Quaternion,t=function(e){return e*Math.PI/180};this.update=function(){var i=t(-Ayce.SensorsHandler.getRoll()+180),r=t(-Ayce.SensorsHandler.getPitch()),o=t(Ayce.SensorsHandler.getYaw()+90),a=Math.cos(i/2),n=Math.cos(r/2),s=Math.cos(o/2),h=Math.sin(i/2),c=Math.sin(r/2),l=Math.sin(o/2);e.x=h*c*s+a*n*l,e.y=h*n*s+a*c*l,e.z=-(a*c*s-h*n*l),e.w=a*n*s-h*c*l},this.getOrientation=function(){return e}},Ayce.Cardboard.prototype=new Ayce.CameraModifier,Ayce.WebVR=function(){var e=new Ayce.Vector3,t=new Ayce.Quaternion,i=new Ayce.Quaternion,r=new Ayce.Vector3;this.getHMDData=function(){return Ayce.HMDHandler.getHMDData()},this.update=function(o){Ayce.KeyboardHandler.isKeyDown("R")&&Ayce.HMDHandler.resetSensor();var a=Ayce.HMDHandler.getPositionalData();a&&(a.position&&(e.x=a.position.x,e.y=a.position.y,e.z=a.position.z,e.w=a.position.w),t.x=a.orientation.x,t.y=a.orientation.y,t.z=a.orientation.z,t.w=a.orientation.w),e=i.multiply(o,t.getConjugate()).rotatePoint(r),t=t.getConjugate()},this.getPosition=function(){return e},this.getOrientation=function(){return t}},Ayce.WebVR.prototype=new Ayce.CameraModifier,Ayce.MouseKeyboard=function(e,t){var i=.2,r=new Ayce.Vector3,o=new Ayce.Quaternion;e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock,document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock;var a=new Ayce.Vector3,n=Date.now(),s=new Ayce.Quaternion,h=new Ayce.Quaternion,c=new Ayce.Vector3(1,0,0),l=new Ayce.Vector3(0,1,0),u=new Ayce.Vector2(0,0),d=0,y=0;this.update=function(e){Ayce.MouseHandler.setNewFrameTrue();var t=(Date.now()-n)/1e3,p=5,f=null;a.x=0,a.y=0,a.z=0,Ayce.KeyboardHandler.isKeyDown("W")&&(f=a.add(0,0,-1)),Ayce.KeyboardHandler.isKeyDown("S")&&(f=a.add(0,0,1)),Ayce.KeyboardHandler.isKeyDown("D")&&(f=a.add(1,0,0)),Ayce.KeyboardHandler.isKeyDown("A")&&(f=a.add(-1,0,0)),f&&(f=e.getRotatedPoint(f),r.add(f.x*p*t,f.y*p*t,f.z*p*t)),n=Date.now(),u=Ayce.MouseHandler.getMovement(),d+=u.x,y+=u.y,y*i>90?y=90/i:-90>y*i&&(y=-90/i),h.reset(),h.fromAxisAngle(l,d*i*Math.PI/180),s.reset(),s.fromAxisAngle(c,y*i*Math.PI/180),s.multiply(s,h),o=s},this.getPosition=function(){return r},this.getOrientation=function(){return o},t.onclick=function(){e.requestPointerLock()},this.isMouseLocked=function(){return document.pointerLockElement===e||document.mozPointerLockElement===e||document.webkitPointerLockElement===e}},Ayce.MouseKeyboard.prototype=new Ayce.CameraModifier,Ayce.Gamepad=function(){var e=this;this.gamepads=[];var t,i=0,r=0,o=.3,a=6,n=3,s=new Ayce.Vector3,h=new Ayce.Vector3;this.getPosition=function(i){var r=.02;for(h.nullVector(),e.gamepads=Ayce.GamepadHandler.getGamepads(),t=0;t<e.gamepads.length;t++)if(e.gamepads[t]){var n=0,c=0;(e.gamepads[t].axes[0]>o||e.gamepads[t].axes[0]<-o)&&(n=e.gamepads[t].axes[0]*a),(e.gamepads[t].axes[1]>o||e.gamepads[t].axes[1]<-o)&&(c=e.gamepads[t].axes[1]*a),h.add(n,0,c)}return h=i.getConjugate().getRotatedPoint(h),s.add(h.x*r,h.y*r,h.z*r),s};var c=new Ayce.Quaternion,l=new Ayce.Quaternion,u=new Ayce.Vector3(1,0,0),d=new Ayce.Vector3(0,1,0);this.getOrientation=function(){for(c.reset(),e.gamepads=Ayce.GamepadHandler.getGamepads(),t=0;t<e.gamepads.length;t++)e.gamepads[t]&&((e.gamepads[t].axes[2]>o||e.gamepads[t].axes[2]<-o)&&(i+=e.gamepads[t].axes[2]*n),(e.gamepads[t].axes[3]>o||e.gamepads[t].axes[3]<-o)&&(r+=e.gamepads[t].axes[3]*n),l.reset(),l.fromAxisAngle(d,i*Math.PI/180),c.reset(),c.fromAxisAngle(u,r*Math.PI/180),c.multiply(c,l));return c}},Ayce.Gamepad.prototype=new Ayce.CameraModifier,Ayce.Object3D=function(){var e=this;this.position=new Ayce.Vector3,this.rotation=new Ayce.Quaternion;var t=new Ayce.Vector3,i=new Ayce.Quaternion,r=new Ayce.Matrix4;this.scale=new Ayce.Vector3(1,1,1),this.modelMatrix=new Ayce.Matrix4,this.parent=null,this.parentPositionWeight=new Ayce.Vector3(1,1,1),this.parentRotationWeight=new Ayce.Vector3(1,1,1),this.vertices=null,this.normals=null,this.textureCoords=null,this.textureIndices=null,this.colors=null,this.indices=null,this.transparent=!1,this.isWireframe=!1,this.twoFaceTransparency=!1,this.buffer=null,this.imageSrc=null,this.shader=null,this.shaderAttributes=null,this.shaderUniforms=null,this.useFragmentLighting=!1,this.specularMap=null,this.normalMap=null,this.useSpecularLighting=!1,this.shininess=1,this.soundFile=null,this.sound=null,this.isSkybox=!1,this.boundingBox=null,this.boundingSphere=null,this.gravity=null,this.velocity=new Ayce.Vector3,this.collision=!1,this.useBoundingSphere=!1,this.collideWith=null,this.onCollision=null;var o=Ayce.Timer.prototype.getCurrentTimeMs();this.onUpdate=null,this.renderPriority=null,this.visible=!0,this.logVertexShader=!1,this.logFragmentShader=!1,this.calcBoundingBox=function(){this.vertices||console.error("No Vertices set. Can't calc Bounding Box."),s();for(var e=this.vertices[0],r=this.vertices[0],o=this.vertices[1],a=this.vertices[1],n=this.vertices[2],h=this.vertices[2],c=0;c<this.vertices.length;c+=3){var l=this.vertices[c+0],u=this.vertices[c+1],d=this.vertices[c+2];l>r&&(r=l),e>l&&(e=l),u>a&&(a=u),o>u&&(o=u),d>h&&(h=d),n>d&&(n=d)}var y=r-e,p=a-o,f=h-n;this.boundingBox=new Ayce.Geometry.Box(y,p,f),this.boundingBox.position=t,this.boundingBox.offset=new Ayce.Vector3(e,o,n),this.boundingBox.rotation=i,this.boundingBox.scale=this.scale},this.calcBoundingSphere=function(){s();var e,r,o,a,n=this.scale,h=this.vertices[0]*n.x,c=this.vertices[0]*n.x,l=this.vertices[1]*n.y,u=this.vertices[1]*n.y,d=this.vertices[2]*n.z,y=this.vertices[2]*n.z;for(e=0;e<this.vertices.length;e+=3)r=this.vertices[e+0]*n.x,o=this.vertices[e+1]*n.y,a=this.vertices[e+2]*n.z,r>c&&(c=r),h>r&&(h=r),o>u&&(u=o),l>o&&(l=o),a>y&&(y=a),d>a&&(d=a);var p=new Ayce.Vector3((c+h)/2,(u+l)/2,(y+d)/2),f=0;for(e=0;e<this.vertices.length;e+=3){r=this.vertices[e+0]*this.scale.x,o=this.vertices[e+1]*this.scale.y,a=this.vertices[e+2]*this.scale.z;var g=Ayce.Vector3.prototype.distance(p,new Ayce.Vector3(r,o,a));g>f&&(f=g)}this.boundingSphere=new Ayce.Geometry.Sphere(f),this.boundingSphere.position=t,this.boundingSphere.offset=p,this.boundingSphere.rotation=i},this.update=function(){var e=Ayce.Timer.prototype.getCurrentTimeMs(),a=e-o,n=this.gravity,h=this.velocity;if((n||0!==h.x||0!==h.y||0!==h.z)&&a>0){var c=a/1e3;if(n&&((n.x>0&&h.x<n.x||n.x<0&&h.x>n.x)&&(h.x=h.x+n.x*c),(n.y>0&&h.y<n.y||n.y<0&&h.y>n.y)&&(h.y=h.y+n.y*c),(n.z>0&&h.z<n.z||n.z<0&&h.z>n.z)&&(h.z=h.z+n.z*c)),this.position.x+=h.x*c,this.position.y+=h.y*c,this.position.z+=h.z*c,s(),this.collision&&this.collideWith)for(var l=0;l<this.collideWith.length;l++){var u=this.collideWith[l],d=this.boundingSphere.position.x+this.boundingSphere.offset.x-(u.boundingSphere.position.x+u.boundingSphere.offset.x),y=this.boundingSphere.position.y+this.boundingSphere.offset.y-(u.boundingSphere.position.y+u.boundingSphere.offset.y),p=this.boundingSphere.position.z+this.boundingSphere.offset.z-(u.boundingSphere.position.z+u.boundingSphere.offset.z),f=Math.sqrt(d*d+y*y+p*p),g=this.boundingSphere.r+u.boundingSphere.r;if(!(f>1.3*g)){var m;if(m=u.useBoundingSphere&&this.useBoundingSphere?Ayce.Geometry.prototype.sphereSphereCollision(this.boundingSphere,u.boundingSphere):u.useBoundingSphere?Ayce.Geometry.prototype.boxSphereCollision(this.boundingBox,u.boundingSphere,!0):this.useBoundingSphere?Ayce.Geometry.prototype.boxSphereCollision(u.boundingBox,this.boundingSphere):Ayce.Geometry.prototype.boxBoxCollision(this.boundingBox,u.boundingBox),m&&(this.position.subtract(m.x,m.y,m.z),this.onCollision)){var x={collisionWith:u,collisionVector:m.negate()};this.onCollision(x)}}}}o=e,s(),this.modelMatrix.identity(),this.modelMatrix.applyScale(this.scale.x,this.scale.y,this.scale.z),i.toRotationMatrix(r),this.modelMatrix.apply(r),this.modelMatrix.applyTranslation(t.x,t.y,t.z),this.onUpdate&&this.onUpdate()};var a=new Ayce.Vector3,n=new Ayce.Quaternion,s=function(){if(e.parent){var r=e.parent.getGlobalRotation(),o=e.parentRotationWeight;i.x=r.x*o.x,i.y=r.y*o.y,i.z=r.z*o.z,i.w=r.w,Ayce.Quaternion.prototype.copyToQuaternion(i,n),i.getConjugate(n),i.normalize(),i.multiply(e.rotation,i);var s=e.parent.getGlobalPosition(),h=e.parentPositionWeight;a.x=e.position.x,a.y=e.position.y,a.z=e.position.z,n.rotatePoint(a),t.x=s.x*h.x+a.x,t.y=s.y*h.y+a.y,t.z=s.z*h.z+a.z}else Ayce.Vector3.prototype.copyToVector(e.position,t),Ayce.Quaternion.prototype.copyToQuaternion(e.rotation,i)};this.getGlobalPosition=function(){return t},this.getGlobalRotation=function(){return i}},Ayce.Object3D.prototype={addShaderAttribute:function(e,t,i){this.shaderAttributes||(this.shaderAttributes=[]),this.shaderAttributes.push([e,t,i])},addShaderUniform:function(e,t,i,r){this.shaderUniforms||(this.shaderUniforms=[]),this.shaderUniforms.push([e,t,i,r])}},Ayce.OBJLoader=function(e){for(var t=/(.*[\/|\\])(.*)/,i=t.exec(e)[1],r=t.exec(e)[2],o=Ayce.XMLLoader.getSourceSynch(i+r),a=this.getMtlName(o),n=Ayce.XMLLoader.getSourceSynch(i+a),s=this.readObj(o),h=a?this.readMtl(n):null,c=[],l=0;l<s.length;l++){var u=this.createO3DFromOBJ(s[l],h,i),d=s[l].name;c.push(u),c[d]=u}return c},Ayce.OBJLoader.prototype={readObj:function(e){var t=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,i=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,r=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,o=/f( +-?\d+)( +-?\d+)( +-?\d+)( +-?\d+)?/,a=/f( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))?/,n=/f( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))?/,s=/f( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))?/,h=[],c={};c.name="",c.vertices=[],c.normals=[],c.uvs=[],c.faces=[];for(var l,u=function(e,t,i){if(void 0!==e[3])throw"obj quad rendering not supported";for(var r=[],o=0;3>o;o++){var a=e[o],n=t?t[o]:void 0,s=i?i[o]:void 0;r.push([a,n,s])}r.push(l),c.faces.push(r)},d=e.split("\n"),y=0;y<d.length;y++){var p=d[y];p=p.trim();var f;0!==p.length&&"#"!==p.charAt(0)&&(null!==(f=t.exec(p))?c.vertices.push([parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3])]):null!==(f=i.exec(p))?c.normals.push([parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3])]):null!==(f=r.exec(p))?c.uvs.push([parseFloat(f[1]),parseFloat(f[2])]):null!==(f=o.exec(p))?u([f[1],f[2],f[3],f[4]]):null!==(f=a.exec(p))?u([f[2],f[5],f[8],f[11]],[f[3],f[6],f[9],f[12]]):null!==(f=n.exec(p))?u([f[2],f[6],f[10],f[14]],[f[3],f[7],f[11],f[15]],[f[4],f[8],f[12],f[16]]):null!==(f=s.exec(p))?u([f[2],f[5],f[8],f[11]],void 0,[f[3],f[6],f[9],f[12]]):/^o /.test(p)||/^g /.test(p)?(c.faces.length>0&&(c.faces=this.getCorrectIndices(c.faces)),c.faces.length>0&&h.push(c),c={},c.name=p.substring(2).trim(),c.vertices=[],c.normals=[],c.uvs=[],c.faces=[]):/^g /.test(p)||/^mtllib /.test(p)||(/^usemtl /.test(p)?l=p.substring(7).trim():/^s /.test(p)))}return h.length>0&&(c.faces=this.getCorrectIndices(c.faces)),h.push(c),h},getMtlName:function(e){for(var t=e.split("\n"),i=0;i<t.length;i++){var r=t[i];if(r=r.trim(),/^mtllib /.test(r))return r.substring(7).trim()}return null},readMtl:function(e){var t=e.split("\n"),i=/Kd ([\d|\.|\+|\-|e|E]+) ([\d|\.|\+|\-|e|E]+) ([\d|\.|\+|\-|e|E]+)/,r={},o=-1;r.mtlName=[],r.kd=[],r.mapKd=[];for(var a=0;a<t.length;a++){var n,s=t[a];/^newmtl /.test(s)?(o++,r.mtlName[o]=s.substring(7).trim()):null!==(n=i.exec(s))?r.kd[o]=[parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3]),1]:/^map_Kd /.test(s)&&(r.mapKd[o]=s.substring(7).trim())}return r},getCorrectIndices:function(e){for(var t=parseInt(e[0][0][0]),i=parseInt(e[0][0][1]),r=parseInt(e[0][0][2]),o=0;o<e.length;o++)for(var a=0;3>a;a++)parseInt(e[o][a][0])<t&&(t=parseInt(e[o][a][0])),parseInt(e[o][a][1])<i&&(i=parseInt(e[o][a][1])),parseInt(e[o][a][2])<r&&(r=parseInt(e[o][a][2]));t-=1,i-=1,r-=1;for(var o=0;o<e.length;o++)for(var a=0;3>a;a++)e[o][a][0]-=t,e[o][a][1]-=i,e[o][a][2]-=r;return e},createO3DFromOBJ:function(e,t,i){for(var r=[],o=[],a=[],n=[],s=[],h=[],c=[],l=0,u=!t||t.mapKd.length>0,d=!t||u&&t.mapKd.length>1,y=0;y<e.faces.length;y++){var p,f=e.faces[y],g=0,m=!1;if(!t||0===t.kd.length&&0===t.mapKd.length)p=[.5,.5,.5,1];else{var x=t.mtlName.indexOf(f[3]);m=Boolean(t.mapKd[x]),p=m?t.mapKd[x]:t.kd[x],m&&(g=c.indexOf(p),0>g&&(c.push(p),g=c.indexOf(p)))}for(var v=0;3>v;v++){var A=f[v][0]-1,w=f[v][1]-1,M=f[v][2]-1,b=!1;b||(Array.prototype.push.apply(r,e.vertices[A]),Array.prototype.push.apply(s,e.normals[M]),m?(Array.prototype.push.apply(a,e.uvs[w]),Array.prototype.push.apply(o,[.5,.5,.5,2])):(Array.prototype.push.apply(o,p),Array.prototype.push.apply(a,e.uvs[w])),n.push(g),h.push(l++))}}var S=new Ayce.Object3D;if(r.length>0&&(S.vertices=r),o.length>0&&(S.colors=o),a.length>0&&(S.textureCoords=a),d&&(S.textureIndices=n),s.length>0&&(S.normals=s),h.length>0&&(S.indices=h),u){for(var y=0;y<c.length;y++)c[y]=i+c[y].replace(/\\/g,"/");if(c&&c.length>10)throw"OBJ Loader: Can't use more than 10 Textures";c.length>0&&(S.imageSrc=c)}return S},copyOBJO3D:function(e){var t=new Ayce.Object3D;return e.vertices&&(t.vertices=e.vertices.slice()),e.colors&&(t.colors=e.colors.slice()),e.textureCoords&&(t.textureCoords=e.textureCoords.slice()),e.textureIndices&&(t.textureIndices=e.textureIndices.slice()),e.normals&&(t.normals=e.normals.slice()),e.indices&&(t.indices=e.indices.slice()),t.imageSrc=e.imageSrc,t}},Ayce.VRSquare=function(){Ayce.Object3D.call(this),this.shader="vr-canvas",this.vertices=[-1,-1,1,1,-1,1,-1,1,1,1,1,1],this.textureCoords=[0,0,1,0,0,1,1,1]},Ayce.VRSquare.prototype=new Ayce.Object3D,Ayce.ParticleSystem=function(e,t,i,r){Ayce.Object3D.call(this);var o=3,a=3,n=3,s=1,h=1,c=1;this.particles=[];var l;for(l=0;i>l;l++)this.particles.push(new Ayce.Particle);this.vertices=[],this.colors=null,this.textureCoords=null,this.indices=[],this.velocities=[],this.lifetimes=[],this.gravities=[],this.gravityExps=[],this.geometries=[],this.rotationAngles=[],this.normals=null,this.imageSrc=t.imageSrc,this.shader=null;var u={time:0,startTime:Date.now()};this.shaderAttributes=[],this.shaderAttributes.push(["aGeometryPosition",o,this.geometries]),this.shaderAttributes.push(["aVertexVelocity",a,this.velocities]),this.shaderAttributes.push(["aVertexRotation",n,this.rotationAngles]),this.shaderAttributes.push(["aLifetime",s,this.lifetimes]),this.shaderAttributes.push(["aGravity",h,this.gravities]),this.shaderAttributes.push(["aGravityExponent",c,this.gravityExps]),this.shaderUniforms=[],this.shaderUniforms.push(["uTime","uniform1f",u,["time"]]),this.initParticleArrays=function(){var e;for(l=0;l<this.particles.length;l++){var i=this.particles[l];for(e=0;e<t.vertices.length;e+=3)this.vertices.push(t.vertices[e]*i.scale.x+i.position.x),this.vertices.push(t.vertices[e+1]*i.scale.y+i.position.y),this.vertices.push(t.vertices[e+2]*i.scale.z+i.position.z),this.geometries.push(t.vertices[e]*i.scale.x),this.geometries.push(t.vertices[e+1]*i.scale.y),this.geometries.push(t.vertices[e+2]*i.scale.z)}if(t.textureCoords&&-1!=t.textureCoords[0])for(this.textureCoords=[],l=0;l<this.particles.length;l++)this.textureCoords=this.textureCoords.concat(t.textureCoords);else for(this.colors=[],l=0;l<this.particles.length;l++)this.colors=this.colors.concat(this.particles[l].colors?this.particles[l].colors:t.colors);for(l=0;l<this.particles.length;l++)for(e=0;e<t.indices.length;e++)this.indices.push(t.indices[e]+l*t.vertices.length/o);for(l=0;l<this.particles.length;l++)for(e=0;e<t.vertices.length/o;e++)t.velocities?(this.velocities.push(this.particles[l].velocity.x+t.velocities[e*a]),this.velocities.push(this.particles[l].velocity.y+t.velocities[e*a+1]),this.velocities.push(this.particles[l].velocity.z+t.velocities[e*a+2])):(this.velocities.push(this.particles[l].velocity.x),this.velocities.push(this.particles[l].velocity.y),this.velocities.push(this.particles[l].velocity.z));for(l=0;l<this.particles.length;l++)for(e=0;e<t.vertices.length/o;e++)this.lifetimes.push(t.lifetimes?0===t.lifetimes[e]?this.particles[l].lifetime:Math.min(this.particles[l].lifetime,t.lifetimes[e]):this.particles[l].lifetime);for(l=0;l<this.particles.length;l++)for(e=0;e<t.vertices.length/o;e++)this.gravities.push(t.gravities?this.particles[l].gravity+t.gravities[e]:this.particles[l].gravity),this.gravityExps.push(this.particles[l].gravityExponent);for(l=0;l<this.particles.length;l++)for(e=0;e<t.vertices.length/o;e++)this.rotationAngles.push(this.particles[l].rotationAngle.x),this.rotationAngles.push(this.particles[l].rotationAngle.y),this.rotationAngles.push(this.particles[l].rotationAngle.z);if(t.normals)for(this.normals=[],l=0;l<this.particles.length;l++)this.normals=this.normals.concat(t.normals)};var d=this.update;this.update=function(){d.call(this),u.time=Date.now()+r-u.startTime}},Ayce.ParticleSystem.prototype=new Ayce.Object3D,Ayce.Particle=function(){this.position=new Ayce.Vector3(0,0,0),this.rotationAngle=new Ayce.Vector3(0,0,0),this.scale=new Ayce.Vector3(1,1,1),this.vertices=[],this.colors=null,this.velocity=new Ayce.Vector3(0,0,0),this.lifetime=0,this.gravity=0,this.gravityExponent=1},Ayce.Skybox=function(e,t,i,r,o,a,n,s,h){this.isSkybox=!0,this.imageSrc=[n+e,n+t,n+i,n+r,n+o,n+a],this.parent=s,this.parentRotationWeight=new Ayce.Vector3(0,0,0),this.parentPositionWeight=new Ayce.Vector3(1,1,1);var c=2*h/Math.sqrt(3);this.scale=new Ayce.Vector3(c,c,c),this.vertices=[-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5],this.textureCoords=[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0],this.textureIndices=[0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5],this.normals=null,this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],this.indices.reverse(),this.calcBoundingBox()},Ayce.Skybox.prototype=new Ayce.Object3D,Ayce.Cube3D=function(){Ayce.Object3D.call(this),this.vertices=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],this.colors=[1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1,.5,.5,1,1,.5,.5,1,1,.5,.5,1,1,.5,.5,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1],this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},Ayce.Cube3D.prototype=new Ayce.Object3D,Ayce.Pyramid3D=function(){Ayce.Object3D.call(this),this.vertices=[0,1,0,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1],this.colors=[1,0,0,.5,0,1,0,.5,0,0,1,.5,0,0,1,.5,0,1,0,.5],this.indices=[0,2,1,0,3,2,0,4,3,0,1,4,1,2,3,1,3,4],this.transparent=!0},Ayce.Pyramid3D.prototype=Ayce.Object3D.prototype,Ayce.Sphere3D=function(){Ayce.Object3D.call(this),this.imageSrc="earth.jpg",this.specularMap="earth-specular.gif",this.shininess=10,this.useFragmentLighting=!0;var e=30,t=30,i=5;this.vertices=[],this.normals=[],this.textureCoords=[];for(var r=0;e>=r;r++)for(var o=r*Math.PI/e,a=Math.sin(o),n=Math.cos(o),s=0;t>=s;s++){var h=2*s*Math.PI/t,c=Math.sin(h),l=Math.cos(h),u=l*a,d=n,y=c*a,p=1-s/t,f=1-r/e;this.normals.push(u),this.normals.push(d),this.normals.push(y),this.textureCoords.push(p),this.textureCoords.push(f),this.vertices.push(i*u),this.vertices.push(i*d),this.vertices.push(i*y)}for(console.log(this.normals),this.indices=[],r=0;e>r;r++)for(var s=0;t>s;s++){var g=r*(t+1)+s,m=g+t+1;this.indices.push(g+1),this.indices.push(m),this.indices.push(g),this.indices.push(g+1),this.indices.push(m+1),this.indices.push(m)}},Ayce.Sphere3D.prototype=Ayce.Object3D.prototype,Ayce.Square=function(){Ayce.Object3D.call(this),this.vertices=[-1,-1,0,1,-1,0,1,1,0,-1,1,0],this.colors=[0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1],this.indices=[0,1,2,0,2,3]},Ayce.Square.prototype=Ayce.Object3D.prototype,Ayce.KeyboardHandler=function(){var e=[],t=[];Ayce.KeyboardHandler.keys=[],this.update=function(){var i;for(i=0;i<e.length;i++)Ayce.KeyboardHandler.keys[e[i]]=!0,e.splice(i,1);for(i=0;i<t.length;i++)Ayce.KeyboardHandler.keys[t[i]]=!1,t.splice(i,1)},window.addEventListener("keydown",function(t){var i=t.keyCode||t.which;Ayce.KeyboardHandler.keys[i]||e.push(i)},!0),window.addEventListener("keyup",function(e){var i=e.keyCode||e.which;t.push(i)},!0)},Ayce.KeyboardHandler.isKeyDown=function(e){if(!Ayce.KeyboardHandler.keys)return void console.log("KeyboardHandler not initialised");if(1===e.length){var t=e.charCodeAt(0);return Ayce.KeyboardHandler.keys[t]}return e.length>1?!1:!1},Ayce.KeyboardHandler.prototype={},Ayce.GamepadHandler=function(){},Ayce.GamepadHandler.getGamepads=function(){return APISupported?navigator.getGamepads():void 0};var APISupported=null,init=function(){navigator.getGamepads?(APISupported=!0,console.log("Gamepad API supported"),console.log("ongamepadconnected"in window?"ongamepadconnected supported":"ongamepadconnected not supported")):(APISupported=!1,console.log("Gamepad API not supported"))};init(),Ayce.MouseHandler=function(){function e(){document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement?document.addEventListener("mousemove",t.onMouseLockMove,!1):document.removeEventListener("mousemove",t.onMouseLockMove,!1)}var t=this;this.addedMovement=new Ayce.Vector2(0,0),this.movement=new Ayce.Vector2(0,0),this.onMouseLockMove=function(e){t.addedMovement.x+=e.movementX||e.mozMovementX||0,t.movement.x=e.movementX||e.mozMovementX||0,t.addedMovement.y+=e.movementY||e.mozMovementY||0,t.movement.y=e.movementY||e.mozMovementY||0},document.addEventListener("pointerlockchange",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("webkitpointerlockchange",e,!1)};var mouseHandler=null,lastMovement=new Ayce.Vector2(0,0),movement=new Ayce.Vector2(0,0),x=0,y=0,newFrame=!0;Ayce.MouseHandler.getMovement=function(){return null===mouseHandler&&(mouseHandler=new Ayce.MouseHandler),newFrame&&(lastMovement.x-mouseHandler.addedMovement.x===0?movement.x=0:(lastMovement.x=mouseHandler.addedMovement.x,movement.x=mouseHandler.movement.x),lastMovement.y-mouseHandler.addedMovement.y===0?movement.y=0:(lastMovement.y=mouseHandler.addedMovement.y,movement.y=mouseHandler.movement.y),newFrame=!1),movement},Ayce.MouseHandler.setNewFrameTrue=function(){newFrame=!0},Ayce.SensorsHandler=function(){var e=this;this.alpha=0,this.beta=0,this.gamma=0,window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",function(t){e.alpha=t.alpha,e.beta=t.beta,e.gamma=t.gamma},!0)};var sensorsHandler=null;Ayce.SensorsHandler.getRoll=function(){return null==sensorsHandler&&(sensorsHandler=new Ayce.SensorsHandler),sensorsHandler.alpha},Ayce.SensorsHandler.getPitch=function(){return null==sensorsHandler&&(sensorsHandler=new Ayce.SensorsHandler),sensorsHandler.beta},Ayce.SensorsHandler.getYaw=function(){return null==sensorsHandler&&(sensorsHandler=new Ayce.SensorsHandler),sensorsHandler.gamma},Ayce.SensorsHandler.prototype={},Ayce.HMDHandler=function(){};var vrDevice=null,positionDevice=null;Ayce.HMDHandler.getHMDData=function(){if(!vrDevice)return null;var e=vrDevice.getEyeParameters("left"),t=vrDevice.getEyeParameters("right");return[e,t]},Ayce.HMDHandler.getPositionalData=function(){return null!==positionDevice?positionDevice.getState():void 0},Ayce.HMDHandler.resetSensor=function(){void 0!==positionDevice&&("resetSensor"in positionDevice?positionDevice.resetSensor():"zeroSensor"in positionDevice?positionDevice.zeroSensor():console.log("Can't reset position sensor."))},function(){function e(e){for(var t in e)if(e[t]instanceof HMDVRDevice){vrDevice=e[t];break}for(var t in e)if(e[t]instanceof PositionSensorVRDevice){positionDevice=e[t];break}}navigator.getVRDevices&&navigator.getVRDevices().then(e)}(),Ayce.HMDHandler.isWebVRReady=function(){return void 0!==navigator.getVRDevices},Ayce.HMDHandler.prototype={};
//# sourceMappingURL=AyceVR.min.js.map